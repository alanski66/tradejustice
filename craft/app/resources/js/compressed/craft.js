!function(p){p.extend(Craft,{navHeight:48,asciiCharMap:{216:"O",223:"ss",224:"a",225:"a",226:"a",229:"a",227:"ae",230:"ae",228:"ae",231:"c",232:"e",233:"e",234:"e",235:"e",236:"i",237:"i",238:"i",239:"i",241:"n",242:"o",243:"o",244:"o",245:"o",246:"oe",248:"o",249:"u",250:"u",251:"u",252:"ue",255:"y",257:"aa",269:"ch",275:"ee",291:"gj",299:"ii",311:"kj",316:"lj",326:"nj",353:"sh",363:"uu",382:"zh",256:"aa",268:"ch",274:"ee",290:"gj",298:"ii",310:"kj",315:"lj",325:"nj",337:"o",352:"sh",362:"uu",369:"u",381:"zh",260:"A",261:"a",262:"C",263:"c",280:"E",281:"e",321:"L",322:"l",323:"N",324:"n",211:"O",346:"S",347:"s",377:"Z",378:"z",379:"Z",380:"z",388:"z"},t:function(t,e){if(void 0!==Craft.translations[t]&&(t=Craft.translations[t]),e)for(var s in e)t=t.replace("{"+s+"}",e[s]);return t},formatDate:function(t){return"object"!=typeof t&&(t=new Date(t)),p.datepicker.formatDate(Craft.datepickerOptions.dateFormat,t)},escapeHtml:function(t){return p("<div/>").text(t).html()},getText:function(t){return p("<div/>").html(t).text()},encodeUriComponent:function(t){t=encodeURIComponent(t);var e={"!":"%21","*":"%2A","'":"%27","(":"%28",")":"%29"};for(var s in e){var i=new RegExp("\\"+s,"g");t=t.replace(i,e[s])}return t},formatInputId:function(t){return this.rtrim(t.replace(/[\[\]]+/g,"-"),"-")},getUrl:function(t,e,s){if("string"!=typeof t&&(t=""),-1!=t.search("://")||"//"==t.substr(0,2))return t;t=Craft.trim(t,"/");var i,n,a="";if(p.isPlainObject(e)){var r=[];for(var o in e){var l=e[o];"#"==o?a=l:null!==l&&""!==l&&r.push(o+"="+l)}e=r}if(e=Garnish.isArray(e)?e.join("&"):Craft.trim(e,"&?"),-1!=(n=t.indexOf("?"))&&(e=t.substr(n+1)+(e?"&"+e:""),t=t.substr(0,n)),s){if(i=s,t){var h=i.match(/[&\?]p=[^&]+/);h&&(i=i.replace(h[0],h[0]+"/"+t),t="")}}else i=Craft.baseUrl;if("-1"!=(n=i.indexOf("?"))&&(e=i.substr(n+1)+(e?"&"+e:""),i=i.substr(0,n)),!Craft.omitScriptNameInUrls&&t)if(Craft.usePathInfo)-1==i.search(Craft.scriptName)&&(i=Craft.rtrim(i,"/")+"/"+Craft.scriptName);else{if(e&&"p="==e.substr(0,2)){var d,c=e.indexOf("&");e=-1!=c?(d=e.substring(2,c),e.substr(c+1)):(d=e.substr(2),null),t=(d=Craft.rtrim(d))+(t?"/"+t:"")}e="p="+t+(e?"&"+e:""),t=null}return t&&(i=Craft.rtrim(i,"/")+"/"+t),e&&(i+="?"+e),a&&(i+="#"+a),i},getCpUrl:function(t,e){return this.getUrl(t,e,Craft.baseCpUrl)},getSiteUrl:function(t,e){return this.getUrl(t,e,Craft.baseSiteUrl)},getResourceUrl:function(t,e){return Craft.getUrl(t,e,Craft.resourceUrl)},getActionUrl:function(t,e){return Craft.getUrl(t,e,Craft.actionUrl)},redirectTo:function(t){document.location.href=this.getUrl(t)},getCsrfInput:function(){return Craft.csrfTokenName?'<input type="hidden" name="'+Craft.csrfTokenName+'" value="'+Craft.csrfTokenValue+'"/>':""},postActionRequest:function(t,e,i,s){"function"==typeof e&&(s=i,i=e,e={}),Craft.csrfTokenValue&&Craft.csrfTokenName&&("string"==typeof e?(e&&(e+="&"),e+=Craft.csrfTokenName+"="+Craft.csrfTokenValue):(e=null===e||"object"!=typeof e?{}:p.extend({},e))[Craft.csrfTokenName]=Craft.csrfTokenValue);var n=p.ajax(p.extend({url:Craft.getActionUrl(t),type:"POST",data:e,success:i,error:function(t,e,s){i&&i(null,e,t)},complete:function(t,e){"success"!=e&&(void 0!==Craft.cp?Craft.cp.displayError():alert(Craft.t("An unknown error occurred.")))}},s));return s&&"function"==typeof s.send&&s.send(n),n},_waitingOnAjax:!1,_ajaxQueue:[],queueActionRequest:function(t,e,s,i){"function"==typeof e&&(i=s,s=e,e=void 0),Craft._ajaxQueue.push([t,e,s,i]),Craft._waitingOnAjax||Craft._postNextActionRequestInQueue()},_postNextActionRequestInQueue:function(){Craft._waitingOnAjax=!0;var i=Craft._ajaxQueue.shift();Craft.postActionRequest(i[0],i[1],function(t,e,s){i[2]&&"function"==typeof i[2]&&i[2](t,e,s),Craft._ajaxQueue.length?Craft._postNextActionRequestInQueue():Craft._waitingOnAjax=!1},i[3])},stringToArray:function(t){if("string"!=typeof t)return t;for(var e=t.split(","),s=0;s<e.length;s++)e[s]=p.trim(e[s]);return e},expandPostArray:function(t){var e={};for(var s in t){var i,n=t[s],a=s.match(/^(\w+)(\[.*)?/);if(a[2]){i=a[2].match(/\[[^\[\]]*\]/g);for(var r=0;r<i.length;r++)i[r]=i[r].substring(1,i[r].length-1)}else i=[];i.unshift(a[1]);var o=e;for(r=0;r<i.length;r++)r<i.length-1?("object"!=typeof o[i[r]]&&(i[r+1]&&parseInt(i[r+1])!=i[r+1]?o[i[r]]={}:o[i[r]]=[]),o=o[i[r]]):(i[r]||(i[r]=o.length),o[i[r]]=n)}return e},compare:function(t,e,s){if(typeof t!=typeof e)return!1;if("object"!=typeof t)return t===e;if(t.length!=e.length)return!1;if(t instanceof Array!=e instanceof Array)return!1;if(!(t instanceof Array))if(void 0===s||1==s){if(!Craft.compare(Craft.getObjectKeys(t).sort(),Craft.getObjectKeys(e).sort()))return!1}else if(!Craft.compare(Craft.getObjectKeys(t),Craft.getObjectKeys(e)))return!1;for(var i in t)if(!Craft.compare(t[i],e[i]))return!1;return!0},getObjectKeys:function(t){var e=[];for(var s in t)t.hasOwnProperty(s)&&e.push(s);return e},escapeChars:function(t){Garnish.isArray(t)||(t=t.split());for(var e="",s=0;s<t.length;s++)e+="\\"+t[s];return e},ltrim:function(t,e){if(!t)return t;void 0===e&&(e=" \t\n\r\0\v");var s=new RegExp("^["+Craft.escapeChars(e)+"]+");return t.replace(s,"")},rtrim:function(t,e){if(!t)return t;void 0===e&&(e=" \t\n\r\0\v");var s=new RegExp("["+Craft.escapeChars(e)+"]+$");return t.replace(s,"")},trim:function(t,e){return t=Craft.ltrim(t,e),t=Craft.rtrim(t,e)},filterArray:function(t,e){for(var s=[],i=0;i<t.length;i++){("function"==typeof e?e(t[i],i):t[i])&&s.push(t[i])}return s},inArray:function(t,e){return-1!=p.inArray(t,e)},removeFromArray:function(t,e){var s=p.inArray(t,e);return-1!=s&&(e.splice(s,1),!0)},getLast:function(t){return t.length?t[t.length-1]:null},uppercaseFirst:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},lowercaseFirst:function(t){return t.charAt(0).toLowerCase()+t.slice(1)},secondsToHumanTimeDuration:function(t,e){void 0===e&&(e=!0);var s=Math.floor(t/604800);t%=604800;var i=Math.floor(t/86400);t%=86400;var n,a=Math.floor(t/3600);return t%=3600,e?(n=Math.floor(t/60),t%=60):(n=Math.round(t/60),t=0),timeComponents=[],s&&timeComponents.push(s+" "+(1==s?Craft.t("week"):Craft.t("weeks"))),i&&timeComponents.push(i+" "+(1==i?Craft.t("day"):Craft.t("days"))),a&&timeComponents.push(a+" "+(1==a?Craft.t("hour"):Craft.t("hours"))),!n&&(e||s||i||a)||timeComponents.push(n+" "+(1==n?Craft.t("minute"):Craft.t("minutes"))),!t&&(!e||s||i||a||n)||timeComponents.push(t+" "+(1==t?Craft.t("second"):Craft.t("seconds"))),timeComponents.join(", ")},asciiString:function(t){for(var e="",s=0;s<t.length;s++){var i=t.charCodeAt(s);32<=i&&i<128?e+=t.charAt(s):void 0!==Craft.asciiCharMap[i]&&(e+=Craft.asciiCharMap[i])}return e},preventOutlineOnMouseFocus:function(t){var e=p(t),s=".preventOutlineOnMouseFocus";e.on("mousedown"+s,function(){e.addClass("no-outline"),e.trigger("focus")}).on("keydown"+s+" blur"+s,function(t){t.keyCode!=Garnish.SHIFT_KEY&&t.keyCode!=Garnish.CTRL_KEY&&t.keyCode!=Garnish.CMD_KEY&&e.removeClass("no-outline")})},createErrorList:function(t){for(var e=p(document.createElement("ul")).addClass("errors"),s=0;s<t.length;s++){var i=p(document.createElement("li"));i.appendTo(e),i.html(t[s])}return e},appendHeadHtml:function(t){if(t){var e=p("link[href]");if(e.length){for(var s=[],i=0;i<e.length;i++){var n=e.eq(i).attr("href");s.push(n.replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&"))}var a=new RegExp('<link\\s[^>]*href="(?:'+s.join("|")+')".*?><\/script>',"g");t=t.replace(a,"")}p("head").append(t)}},appendFootHtml:function(t){if(t){var e=p("script[src]");if(e.length){for(var s=[],i=0;i<e.length;i++){var n=e.eq(i).attr("src");s.push(n.replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&"))}var a=new RegExp('<script\\s[^>]*src="(?:'+s.join("|")+')".*?><\/script>',"g");t=t.replace(a,"")}Garnish.$bod.append(t)}},initUiElements:function(t){p(".grid",t).grid(),p(".pane",t).pane(),p(".info",t).infoicon(),p(".checkbox-select",t).checkboxselect(),p(".fieldtoggle",t).fieldtoggle(),p(".lightswitch",t).lightswitch(),p(".nicetext",t).nicetext(),p(".pill",t).pill(),p(".formsubmit",t).formsubmit(),p(".menubtn",t).menubtn()},_elementIndexClasses:{},_elementSelectorModalClasses:{},registerElementIndexClass:function(t,e){if(void 0!==this._elementIndexClasses[t])throw"An element index class has already been registered for the element type “"+t+"”.";this._elementIndexClasses[t]=e},registerElementSelectorModalClass:function(t,e){if(void 0!==this._elementSelectorModalClasses[t])throw"An element selector modal class has already been registered for the element type “"+t+"”.";this._elementSelectorModalClasses[t]=e},createElementIndex:function(t,e,s){return new(void 0!==this._elementIndexClasses[t]?this._elementIndexClasses[t]:Craft.BaseElementIndex)(t,e,s)},createElementSelectorModal:function(t,e){return new(void 0!==this._elementSelectorModalClasses[t]?this._elementSelectorModalClasses[t]:Craft.BaseElementSelectorModal)(t,e)},getLocalStorage:function(t,e){return t="Craft-"+Craft.siteUid+"."+t,"undefined"!=typeof localStorage&&void 0!==localStorage[t]?JSON.parse(localStorage[t]):e},setLocalStorage:function(t,e){if("undefined"!=typeof localStorage){t="Craft-"+Craft.siteUid+"."+t;try{localStorage[t]=JSON.stringify(e)}catch(t){}}},getElementInfo:function(t){var e=p(t);return e.hasClass("element")||(e=e.find(".element:first")),{id:e.data("id"),locale:e.data("locale"),label:e.data("label"),status:e.data("status"),url:e.data("url"),hasThumb:e.hasClass("hasthumb"),$element:e}},setElementSize:function(t,e){var s=p(t);if("small"!=e&&"large"!=e&&(e="small"),!s.hasClass(e)){var i="small"==e?"large":"small";if(s.addClass(e).removeClass(i),s.hasClass("hasthumb")){var n=s.find("> .elementthumb > img");$newImg=p("<img/>",{sizes:("small"==e?"30":"100")+"px",srcset:n.attr("srcset")||n.attr("data-pfsrcset")}),n.replaceWith($newImg),picturefill({elements:[$newImg[0]]})}}},showElementEditor:function(t,e){if(Garnish.hasAttr(t,"data-editable")&&!t.hasClass("disabled")&&!t.hasClass("loading"))return new Craft.ElementEditor(t,e)}}),p.extend(p.fn,{animateLeft:function(t,e,s,i){return"ltr"==Craft.orientation?this.velocity({left:t},e,s,i):this.velocity({right:t},e,s,i)},animateRight:function(t,e,s,i){return"ltr"==Craft.orientation?this.velocity({right:t},e,s,i):this.velocity({left:t},e,s,i)},disable:function(){return this.each(function(){var t=p(this);t.addClass("disabled"),t.data("activatable")&&t.removeAttr("tabindex")})},enable:function(){return this.each(function(){var t=p(this);t.removeClass("disabled"),t.data("activatable")&&t.attr("tabindex","0")})},grid:function(){return this.each(function(){var t=p(this),e={};t.data("item-selector")&&(e.itemSelector=t.data("item-selector")),t.data("cols")&&(e.cols=parseInt(t.data("cols"))),t.data("max-cols")&&(e.maxCols=parseInt(t.data("max-cols"))),t.data("min-col-width")&&(e.minColWidth=parseInt(t.data("min-col-width"))),t.data("mode")&&(e.mode=t.data("mode")),t.data("fill-mode")&&(e.fillMode=t.data("fill-mode")),t.data("col-class")&&(e.colClass=t.data("col-class")),t.data("snap-to-grid")&&(e.snapToGrid=!!t.data("snap-to-grid")),new Craft.Grid(this,e)})},infoicon:function(){return this.each(function(){new Craft.InfoIcon(this)})},pane:function(){return this.each(function(){p.data(this,"pane")||new Craft.Pane(this)})},checkboxselect:function(){return this.each(function(){p.data(this,"checkboxselect")||new Garnish.CheckboxSelect(this)})},fieldtoggle:function(){return this.each(function(){p.data(this,"fieldtoggle")||new Craft.FieldToggle(this)})},lightswitch:function(e,t,s){return"settings"==e?("string"==typeof t?(e={})[t]=s:e=t,this.each(function(){var t=p.data(this,"lightswitch");t&&t.setSettings(e)})):this.each(function(){p.data(this,"lightswitch")||new Craft.LightSwitch(this,e)})},nicetext:function(){return this.each(function(){p.data(this,"nicetext")||new Garnish.NiceText(this)})},pill:function(){return this.each(function(){p.data(this,"pill")||new Garnish.Pill(this)})},formsubmit:function(){this.on("click",function(t){var e,s=p(t.currentTarget);s.attr("data-confirm")&&!confirm(s.attr("data-confirm"))||(e=s.data("menu")?s.data("menu").$anchor.closest("form"):s.closest("form"),s.attr("data-action")&&p('<input type="hidden" name="action"/>').val(s.attr("data-action")).appendTo(e),s.attr("data-redirect")&&p('<input type="hidden" name="redirect"/>').val(s.attr("data-redirect")).appendTo(e),s.attr("data-param")&&p('<input type="hidden"/>').attr({name:s.attr("data-param"),value:s.attr("data-value")}).appendTo(e),e.trigger("submit"))})},menubtn:function(){return this.each(function(){var t=p(this);if(!t.data("menubtn")&&t.next().hasClass("menu")){var e={};t.data("menu-anchor")&&(e.menuAnchor=t.data("menu-anchor")),new Garnish.MenuBtn(t,e)}})}}),Garnish.$doc.ready(function(){Craft.initUiElements()}),Craft.BaseElementIndex=Garnish.Base.extend({initialized:!1,elementType:null,instanceState:null,sourceStates:null,sourceStatesStorageKey:null,searchTimeout:null,sourceSelect:null,$container:null,$main:null,$mainSpinner:null,isIndexBusy:!1,$sidebar:null,showingSidebar:null,sourceKey:null,sourceViewModes:null,$source:null,$customizeSourcesBtn:null,customizeSourcesModal:null,$toolbar:null,$toolbarTableRow:null,toolbarOffset:null,$search:null,searching:!1,searchText:null,$clearSearchBtn:null,$statusMenuBtn:null,statusMenu:null,status:null,$localeMenuBtn:null,localeMenu:null,locale:null,$sortMenuBtn:null,sortMenu:null,$sortAttributesList:null,$sortDirectionsList:null,$scoreSortAttribute:null,$structureSortAttribute:null,$elements:null,$viewModeBtnTd:null,$viewModeBtnContainer:null,viewModeBtns:null,viewMode:null,view:null,_autoSelectElements:null,actions:null,actionsHeadHtml:null,actionsFootHtml:null,$selectAllContainer:null,$selectAllCheckbox:null,showingActionTriggers:!1,_$triggers:null,init:function(t,e,s){this.elementType=t,this.$container=e,this.setSettings(s,Craft.BaseElementIndex.defaults),this.instanceState={selectedSource:null},this.sourceStates={},this.settings.storageKey&&p.extend(this.instanceState,Craft.getLocalStorage(this.settings.storageKey),{}),this.sourceStatesStorageKey="BaseElementIndex."+this.elementType+"."+this.settings.context,p.extend(this.sourceStates,Craft.getLocalStorage(this.sourceStatesStorageKey,{})),this.$main=this.$container.find(".main"),this.$toolbar=this.$container.find(".toolbar:first"),this.$toolbarTableRow=this.$toolbar.children("table").children("tbody").children("tr"),this.$statusMenuBtn=this.$toolbarTableRow.find(".statusmenubtn:first"),this.$localeMenuBtn=this.$toolbarTableRow.find(".localemenubtn:first"),this.$sortMenuBtn=this.$toolbarTableRow.find(".sortmenubtn:first"),this.$search=this.$toolbarTableRow.find(".search:first input:first"),this.$clearSearchBtn=this.$toolbarTableRow.find(".search:first > .clear"),this.$mainSpinner=this.$toolbar.find(".spinner:first"),this.$sidebar=this.$container.find(".sidebar:first"),this.$customizeSourcesBtn=this.$sidebar.children(".customize-sources"),this.$elements=this.$container.find(".elements:first"),this.$viewModeBtnTd=this.$toolbarTableRow.find(".viewbtns:first"),this.$viewModeBtnContainer=p('<div class="btngroup fullwidth"/>').appendTo(this.$viewModeBtnTd),"index"!=this.settings.context||Garnish.isMobileBrowser(!0)||this.addListener(Garnish.$win,"resize,scroll","updateFixedToolbar");var i=this._getSourcesInList(this.$sidebar.children("nav").children("ul"));if(0!=i.length){if(this.sourceSelect=new Garnish.Select(this.$sidebar.find("nav"),{multi:!1,allowEmpty:!1,vertical:!0,onSelectionChange:p.proxy(this,"_handleSourceSelectionChange")}),this._initSources(i),this.$customizeSourcesBtn.length&&this.addListener(this.$customizeSourcesBtn,"click","createCustomizeSourcesModal"),this.$statusMenuBtn.length&&(this.statusMenu=this.$statusMenuBtn.menubtn().data("menubtn").menu,this.statusMenu.on("optionselect",p.proxy(this,"_handleStatusChange"))),this.$localeMenuBtn.length){this.localeMenu=this.$localeMenuBtn.menubtn().data("menubtn").menu;var n=this.localeMenu.$options.filter(".sel:first");if(n.length||(n=this.localeMenu.$options.first()),n.length?this.locale=n.data("locale"):this.settings.criteria={id:"0"},this.localeMenu.on("optionselect",p.proxy(this,"_handleLocaleChange")),this.locale){var a=Craft.getLocalStorage("BaseElementIndex.locale");if(a&&a!=this.locale){var r=this.localeMenu.$options.filter('[data-locale="'+a+'"]:first');r.length&&r.trigger("click")}}}else this.settings.criteria&&this.settings.criteria.locale&&(this.locale=this.settings.criteria.locale);this.addListener(this.$search,"textchange",p.proxy(function(){!this.searching&&this.$search.val()?this.startSearching():this.searching&&!this.$search.val()&&this.stopSearching(),this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(p.proxy(this,"updateElementsIfSearchTextChanged"),500)},this)),this.addListener(this.$search,"keypress",p.proxy(function(t){t.keyCode==Garnish.RETURN_KEY&&(t.preventDefault(),this.searchTimeout&&clearTimeout(this.searchTimeout),this.updateElementsIfSearchTextChanged())},this)),this.addListener(this.$clearSearchBtn,"click",p.proxy(function(){this.$search.val(""),this.searchTimeout&&clearTimeout(this.searchTimeout),Garnish.isMobileBrowser(!0)||this.$search.trigger("focus"),this.stopSearching(),this.updateElementsIfSearchTextChanged()},this)),Garnish.isMobileBrowser(!0)||this.$search.trigger("focus"),this.$sortMenuBtn.length&&(this.sortMenu=this.$sortMenuBtn.menubtn().data("menubtn").menu,this.$sortAttributesList=this.sortMenu.$container.children(".sort-attributes"),this.$sortDirectionsList=this.sortMenu.$container.children(".sort-directions"),this.sortMenu.on("optionselect",p.proxy(this,"_handleSortChange"))),this.initialized=!0,this.afterInit();var o,l=this.getDefaultSourceKey();if(l)if(o=this.getSourceByKey(l))o.parentsUntil(".sidebar","li").not(":first").addClass("expanded");l&&o||(o=this.$sources.first()),o.length&&this.selectSource(o),this.updateElements()}},afterInit:function(){this.onAfterInit()},get $sources(){if(this.sourceSelect)return this.sourceSelect.$items},updateFixedToolbar:function(){(this.toolbarOffset||(this.toolbarOffset=this.$toolbar.offset().top,this.toolbarOffset))&&(this.updateFixedToolbar._scrollTop=Garnish.$win.scrollTop(),992<Garnish.$win.width()&&this.updateFixedToolbar._scrollTop>this.toolbarOffset-7?(this.$toolbar.hasClass("fixed")||(this.$elements.css("padding-top",this.$toolbar.outerHeight()+24),this.$toolbar.addClass("fixed")),this.$toolbar.css("width",this.$main.width())):this.$toolbar.hasClass("fixed")&&(this.$toolbar.removeClass("fixed"),this.$toolbar.css("width",""),this.$elements.css("padding-top","")))},initSource:function(t){this.sourceSelect.addItems(t),this.initSourceToggle(t)},initSourceToggle:function(t){var e=this._getSourceToggle(t);e.length&&this.addListener(e,"click","_handleSourceToggleClick")},deinitSource:function(t){this.sourceSelect.removeItems(t),this.deinitSourceToggle(t)},deinitSourceToggle:function(t){var e=this._getSourceToggle(t);e.length&&this.removeListener(e,"click")},getDefaultSourceKey:function(){return this.instanceState.selectedSource},startSearching:function(){this.$clearSearchBtn.removeClass("hidden"),this.$scoreSortAttribute||(this.$scoreSortAttribute=p('<li><a data-attr="score">'+Craft.t("Score")+"</a></li>"),this.sortMenu.addOptions(this.$scoreSortAttribute.children())),this.$scoreSortAttribute.prependTo(this.$sortAttributesList),this.setSortAttribute("score"),this.getSortAttributeOption("structure").addClass("disabled"),this.searching=!0},stopSearching:function(){this.$clearSearchBtn.addClass("hidden"),this.$scoreSortAttribute.detach(),this.getSortAttributeOption("structure").removeClass("disabled"),this.setStoredSortOptionsForSource(),this.searching=!1},setInstanceState:function(t,e){"object"==typeof t?p.extend(this.instanceState,t):this.instanceState[t]=e,this.settings.storageKey&&Craft.setLocalStorage(this.settings.storageKey,this.instanceState)},getSourceState:function(t,e,s){return void 0===this.sourceStates[t]&&(this.sourceStates[t]={}),void 0===e?this.sourceStates[t]:void 0!==this.sourceStates[t][e]?this.sourceStates[t][e]:void 0!==s?s:null},getSelectedSourceState:function(t,e){return this.getSourceState(this.instanceState.selectedSource,t,e)},setSelecetedSourceState:function(t,e){var s=this.getSelectedSourceState();"object"==typeof t?p.extend(s,t):s[t]=e,this.sourceStates[this.instanceState.selectedSource]=s,Craft.setLocalStorage(this.sourceStatesStorageKey,this.sourceStates)},storeSortAttributeAndDirection:function(){var t=this.getSelectedSortAttribute();"score"!=t&&this.setSelecetedSourceState({order:t,sort:this.getSelectedSortDirection()})},getViewParams:function(){var t=p.extend({status:this.status,locale:this.locale,search:this.searchText,limit:this.settings.batchSize},this.settings.criteria),e={context:this.settings.context,elementType:this.elementType,source:this.instanceState.selectedSource,criteria:t,disabledElementIds:this.settings.disabledElementIds,viewState:p.extend({},this.getSelectedSourceState())};return e.viewState.order=this.getSelectedSortAttribute(),e.viewState.sort=this.getSelectedSortDirection(),"structure"==this.getSelectedSortAttribute()&&(void 0===this.instanceState.collapsedElementIds&&(this.instanceState.collapsedElementIds=[]),e.collapsedElementIds=this.instanceState.collapsedElementIds),e},updateElements:function(){if(this.initialized){this.setIndexBusy();var s=this.getViewParams();Craft.postActionRequest("elementIndex/getElements",s,p.proxy(function(t,e){this.setIndexAvailable(),"success"==e?this._updateView(s,t):Craft.cp.displayError(Craft.t("An unknown error occurred."))},this))}},updateElementsIfSearchTextChanged:function(){this.searchText!==(this.searchText=this.searching?this.$search.val():null)&&this.updateElements()},showActionTriggers:function(){this.showingActionTriggers||(this.$toolbar.css("min-height",this.$toolbar.height()),this.$toolbarTableRow.children().not(this.$selectAllContainer).addClass("hidden"),this._$triggers?this._$triggers.insertAfter(this.$selectAllContainer):this._createTriggers(),this.showingActionTriggers=!0)},submitAction:function(t,e){var s,i=this.view.getSelectedElementIds(),n=i.length;this.view.getEnabledElements.length;if(0!=n){for(var a=0;a<this.actions.length;a++)if(this.actions[a].handle==t){s=this.actions[a];break}if(s&&(!s.confirm||confirm(s.confirm))){var r=this.getViewParams(),o=p.extend(r,e,{elementAction:t,elementIds:i});this.setIndexBusy(),this._autoSelectElements=i,Craft.postActionRequest("elementIndex/performAction",o,p.proxy(function(t,e){this.setIndexAvailable(),"success"==e&&(t.success?(this._updateView(r,t),t.message&&Craft.cp.displayNotice(t.message),Craft.cp.runPendingTasks()):Craft.cp.displayError(t.message))},this))}}},hideActionTriggers:function(){this.showingActionTriggers&&(this._$triggers.detach(),this.$toolbarTableRow.children().not(this.$selectAllContainer).removeClass("hidden"),this.$toolbar.css("min-height",""),this.showingActionTriggers=!1)},updateActionTriggers:function(){if(this.actions){var t=this.view.getSelectedElements().length;0!=t?(t==this.view.getEnabledElements().length?(this.$selectAllCheckbox.removeClass("indeterminate"),this.$selectAllCheckbox.addClass("checked"),this.$selectAllBtn.attr("aria-checked","true")):(this.$selectAllCheckbox.addClass("indeterminate"),this.$selectAllCheckbox.removeClass("checked"),this.$selectAllBtn.attr("aria-checked","mixed")),this.showActionTriggers()):(this.$selectAllCheckbox.removeClass("indeterminate checked"),this.$selectAllBtn.attr("aria-checked","false"),this.hideActionTriggers())}},getSelectedElements:function(){return this.view?this.view.getSelectedElements():p()},getSelectedElementIds:function(){return this.view?this.view.getSelectedElementIds():[]},getSortAttributeOption:function(t){return this.$sortAttributesList.find('a[data-attr="'+t+'"]:first')},getSelectedSortAttribute:function(){return this.$sortAttributesList.find("a.sel:first").data("attr")},setSortAttribute:function(t){var e=this.getSortAttributeOption(t);if(e.length){this.$sortAttributesList.find("a.sel").removeClass("sel"),e.addClass("sel");var s=e.text();this.$sortMenuBtn.attr("title",Craft.t("Sort by {attribute}",{attribute:s})),this.$sortMenuBtn.text(s),this.setSortDirection("asc"),"score"==t||"structure"==t?this.$sortDirectionsList.find("a").addClass("disabled"):this.$sortDirectionsList.find("a").removeClass("disabled")}},getSortDirectionOption:function(t){return this.$sortDirectionsList.find("a[data-dir="+t+"]:first")},getSelectedSortDirection:function(){return this.$sortDirectionsList.find("a.sel:first").data("dir")},getSelectedViewMode:function(){return this.getSelectedSourceState("mode")},setSortDirection:function(t){"desc"!=t&&(t="asc"),this.$sortMenuBtn.attr("data-icon",t),this.$sortDirectionsList.find("a.sel").removeClass("sel"),this.getSortDirectionOption(t).addClass("sel")},getSourceByKey:function(t){if(this.$sources){var e=this.$sources.filter('[data-key="'+t+'"]:first');if(e.length)return e}},selectSource:function(t){if(!t||!t.length)return!1;if(this.$source&&this.$source[0]&&this.$source[0]==t[0]&&t.data("key")==this.sourceKey)return!1;if(this.$source=t,this.sourceKey=t.data("key"),this.setInstanceState("selectedSource",this.sourceKey),this.sourceSelect.selectItem(t),Craft.cp.updateSidebarMenuLabel(),this.searching&&(this.searchText=null,this.$search.val(""),this.stopSearching()),Garnish.hasAttr(this.$source,"data-has-structure")?(this.$structureSortAttribute||(this.$structureSortAttribute=p('<li><a data-attr="structure">'+Craft.t("Structure")+"</a></li>"),this.sortMenu.addOptions(this.$structureSortAttribute.children())),this.$structureSortAttribute.prependTo(this.$sortAttributesList)):this.$structureSortAttribute&&this.$structureSortAttribute.removeClass("sel").detach(),this.setStoredSortOptionsForSource(),this.$viewModeBtnContainer.empty(),this.viewModeBtns={},this.viewMode=null,this.sourceViewModes=this.getViewModesForSource(),1<this.sourceViewModes.length){this.$viewModeBtnTd.removeClass("hidden");for(var e=0;e<this.sourceViewModes.length;e++){var s=this.sourceViewModes[e],i=p('<div data-view="'+s.mode+'" role="button" class="btn'+(void 0!==s.className?" "+s.className:"")+'" title="'+s.title+'"'+(void 0!==s.icon?' data-icon="'+s.icon+'"':"")+"/>").appendTo(this.$viewModeBtnContainer);this.viewModeBtns[s.mode]=i,this.addListener(i,"click",{mode:s.mode},function(t){this.selectViewMode(t.data.mode),this.updateElements()})}}else this.$viewModeBtnTd.addClass("hidden");return(s=this.getSelectedViewMode())&&this.doesSourceHaveViewMode(s)||(s=this.viewMode&&this.doesSourceHaveViewMode(this.viewMode)?this.viewMode:this.sourceViewModes[0].mode),this.selectViewMode(s),this.onSelectSource(),!0},selectSourceByKey:function(t){var e=this.getSourceByKey(t);return!!e&&this.selectSource(e)},setStoredSortOptionsForSource:function(){var t=this.getSelectedSourceState("order"),e=this.getSelectedSourceState("sort");t&&e||(t=this.getDefaultSort(),Garnish.isArray(t)&&(e=t[1],t=t[0])),"asc"!=e&&"desc"!=e&&(e="asc"),this.setSortAttribute(t),this.setSortDirection(e)},getDefaultSort:function(){return this.$source&&Garnish.hasAttr(this.$source,"data-default-sort")?this.$source.attr("data-default-sort").split(":"):[this.$sortAttributesList.find("a:first").data("attr"),"asc"]},getViewModesForSource:function(){var t=[{mode:"table",title:Craft.t("Display in a table"),icon:"list"}];return this.$source&&Garnish.hasAttr(this.$source,"data-has-thumbs")&&t.push({mode:"thumbs",title:Craft.t("Display as thumbnails"),icon:"grid"}),t},doesSourceHaveViewMode:function(t){for(var e=0;e<this.sourceViewModes.length;e++)if(this.sourceViewModes[e].mode==t)return!0;return!1},selectViewMode:function(t,e){e||this.doesSourceHaveViewMode(t)||(t=this.sourceViewModes[0].mode),t!=this.viewMode&&(this.viewMode&&void 0!==this.viewModeBtns[this.viewMode]&&this.viewModeBtns[this.viewMode].removeClass("active"),this.viewMode=t,this.setSelecetedSourceState("mode",this.viewMode),void 0!==this.viewModeBtns[this.viewMode]&&this.viewModeBtns[this.viewMode].addClass("active"))},createView:function(t,e){return new(this.getViewClass(t))(this,this.$elements,e)},getViewClass:function(t){switch(t){case"table":return Craft.TableElementIndexView;case"thumbs":return Craft.ThumbsElementIndexView;default:throw'View mode "'+t+'" not supported.'}},rememberDisabledElementId:function(t){-1==p.inArray(t,this.settings.disabledElementIds)&&this.settings.disabledElementIds.push(t)},forgetDisabledElementId:function(t){var e=p.inArray(t,this.settings.disabledElementIds);-1!=e&&this.settings.disabledElementIds.splice(e,1)},enableElements:function(t){t.removeClass("disabled").parents(".disabled").removeClass("disabled");for(var e=0;e<t.length;e++){var s=p(t[e]).data("id");this.forgetDisabledElementId(s)}this.onEnableElements(t)},disableElements:function(t){t.removeClass("sel").addClass("disabled");for(var e=0;e<t.length;e++){var s=p(t[e]).data("id");this.rememberDisabledElementId(s)}this.onDisableElements(t)},getElementById:function(t){return this.view.getElementById(t)},enableElementsById:function(t){t=p.makeArray(t);for(var e=0;e<t.length;e++){var s=t[e],i=this.getElementById(s);i&&i.length?this.enableElements(i):this.forgetDisabledElementId(s)}},disableElementsById:function(t){t=p.makeArray(t);for(var e=0;e<t.length;e++){var s=t[e],i=this.getElementById(s);i&&i.length?this.disableElements(i):this.rememberDisabledElementId(s)}},selectElementAfterUpdate:function(t){null===this._autoSelectElements&&(this._autoSelectElements=[]),this._autoSelectElements.push(t)},addButton:function(t){this.getButtonContainer().append(t)},isShowingSidebar:function(){return null===this.showingSidebar&&(this.showingSidebar=this.$sidebar.length&&!this.$sidebar.hasClass("hidden")),this.showingSidebar},getButtonContainer:function(){if(this.settings.buttonContainer)return p(this.settings.buttonContainer);var t=p("#extra-headers > .buttons:first");if(!t.length){var e=p("#extra-headers");e.length||(e=p('<div id="extra-headers"/>').appendTo(p("#page-header"))),t=p('<div class="buttons right"/>').appendTo(e)}return t},setIndexBusy:function(){this.$mainSpinner.removeClass("hidden"),this.isIndexBusy=!0},setIndexAvailable:function(){this.$mainSpinner.addClass("hidden"),this.isIndexBusy=!1},createCustomizeSourcesModal:function(){var t=new Craft.CustomizeSourcesModal(this,{onHide:function(){t.destroy()}});return t},disable:function(){this.sourceSelect&&this.sourceSelect.disable(),this.view&&this.view.disable(),this.base()},enable:function(){this.sourceSelect&&this.sourceSelect.enable(),this.view&&this.view.enable(),this.base()},onAfterInit:function(){this.settings.onAfterInit(),this.trigger("afterInit")},onSelectSource:function(){this.settings.onSelectSource(this.sourceKey),this.trigger("selectSource",{sourceKey:this.sourceKey})},onUpdateElements:function(){this.settings.onUpdateElements(),this.trigger("updateElements")},onSelectionChange:function(){this.settings.onSelectionChange(),this.trigger("selectionChange")},onEnableElements:function(t){this.settings.onEnableElements(t),this.trigger("enableElements",{elements:t})},onDisableElements:function(t){this.settings.onDisableElements(t),this.trigger("disableElements",{elements:t})},_handleSourceSelectionChange:function(){this.sourceSelect.totalSelected?this.selectSource(this.sourceSelect.$selectedItems)&&this.updateElements():this.sourceSelect.selectItem(this.$sources.first())},_handleActionTriggerSubmit:function(t){t.preventDefault();var e=p(t.currentTarget);if(!e.hasClass("disabled")&&!e.data("custom-handler")){var s=e.data("action"),i=Garnish.getPostData(e);this.submitAction(s,i)}},_handleMenuActionTriggerSubmit:function(t){var e=p(t.option);if(!e.hasClass("disabled")&&!e.data("custom-handler")){var s=e.data("action");this.submitAction(s)}},_handleStatusChange:function(t){this.statusMenu.$options.removeClass("sel");var e=p(t.selectedOption).addClass("sel");this.$statusMenuBtn.html(e.html()),this.status=e.data("status"),this.updateElements()},_handleLocaleChange:function(t){this.localeMenu.$options.removeClass("sel");var e=p(t.selectedOption).addClass("sel");this.$localeMenuBtn.html(e.html()),this.locale=e.data("locale"),this.initialized&&(Craft.setLocalStorage("BaseElementIndex.locale",this.locale),this.updateElements())},_handleSortChange:function(t){var e=p(t.selectedOption);e.hasClass("disabled")||e.hasClass("sel")||(e.parent().parent().is(this.$sortAttributesList)?this.setSortAttribute(e.data("attr")):this.setSortDirection(e.data("dir")),this.storeSortAttributeAndDirection(),this.updateElements())},_handleSelectionChange:function(){this.updateActionTriggers(),this.onSelectionChange()},_handleSourceToggleClick:function(t){this._toggleSource(p(t.currentTarget).prev("a")),t.stopPropagation()},_getSourcesInList:function(t){return t.children("li").children("a")},_getChildSources:function(t){var e=t.siblings("ul");return this._getSourcesInList(e)},_getSourceToggle:function(t){return t.siblings(".toggle")},_initSources:function(t){for(var e=0;e<t.length;e++)this.initSource(p(t[e]))},_deinitSources:function(t){for(var e=0;e<t.length;e++)this.deinitSource(p(t[e]))},_toggleSource:function(t){t.parent("li").hasClass("expanded")?this._collapseSource(t):this._expandSource(t)},_expandSource:function(t){t.parent("li").addClass("expanded");var e=this._getChildSources(t);this._initSources(e)},_collapseSource:function(t){t.parent("li").removeClass("expanded");var e=this._getChildSources(t);this._deinitSources(e)},_updateView:function(t,e){this.view&&(this.view.destroy(),delete this.view),this.actions&&(this.hideActionTriggers(),this.actions=this.actionsHeadHtml=this.actionsFootHtml=this._$triggers=null),this.$selectAllContainer&&this.$selectAllContainer.detach(),"index"==this.settings.context&&e.actions&&e.actions.length&&(this.actions=e.actions,this.actionsHeadHtml=e.actionsHeadHtml,this.actionsFootHtml=e.actionsFootHtml,this.$selectAllContainer?(this.$selectAllCheckbox.removeClass("indeterminate checked"),this.$selectAllBtn.attr("aria-checked","false")):(this.$selectAllContainer=p('<td class="selectallcontainer thin"/>'),this.$selectAllBtn=p('<div class="btn" />').appendTo(this.$selectAllContainer),this.$selectAllCheckbox=p('<div class="checkbox"/>').appendTo(this.$selectAllBtn),this.$selectAllBtn.attr({role:"checkbox",tabindex:"0","aria-checked":"false"}),this.addListener(this.$selectAllBtn,"click",function(){0==this.view.getSelectedElements().length?this.view.selectAllElements():this.view.deselectAllElements()}),this.addListener(this.$selectAllBtn,"keydown",function(t){t.keyCode==Garnish.SPACE_KEY&&(t.preventDefault(),p(t.currentTarget).trigger("click"))})),this.$selectAllContainer.prependTo(this.$toolbarTableRow)),this.$elements.html(e.html),Craft.appendHeadHtml(e.headHtml),Craft.appendFootHtml(e.footHtml),picturefill();var s=this.actions||this.settings.selectable;if(this.view=this.createView(this.getSelectedViewMode(),{context:this.settings.context,batchSize:this.settings.batchSize,params:t,selectable:s,multiSelect:this.actions||this.settings.multiSelect,checkboxMode:"index"==this.settings.context&&this.actions,onSelectionChange:p.proxy(this,"_handleSelectionChange")}),this._autoSelectElements){if(s)for(var i=0;i<this._autoSelectElements.length;i++)this.view.selectElementById(this._autoSelectElements[i]);this._autoSelectElements=null}this.onUpdateElements()},_createTriggers:function(){for(var t,e=[],s=[],i=[],n=0;n<this.actions.length;n++){var a=this.actions[n];if(a.trigger){var r=p('<form id="'+a.handle+'-actiontrigger"/>').data("action",a.handle).append(a.trigger);this.addListener(r,"submit","_handleActionTriggerSubmit"),e.push(r)}else a.destructive?i.push(a):s.push(a)}if(s.length||i.length){var o=p("<form/>");t=p('<div class="btn menubtn" data-icon="settings" title="'+Craft.t("Actions")+'"/>').appendTo(o);var l=p('<ul class="menu"/>').appendTo(o),h=this._createMenuTriggerList(s),d=this._createMenuTriggerList(i);h&&h.appendTo(l),h&&d&&p("<hr/>").appendTo(l),d&&d.appendTo(l),e.push(o)}e.push(""),this._$triggers=p();for(n=0;n<e.length;n++){var c=p('<td class="'+(n<e.length-1?"thin":"")+'"/>').append(e[n]);this._$triggers=this._$triggers.add(c)}this._$triggers.insertAfter(this.$selectAllContainer),Craft.appendHeadHtml(this.actionsHeadHtml),Craft.appendFootHtml(this.actionsFootHtml),Craft.initUiElements(this._$triggers),t&&t.data("menubtn").on("optionSelect",p.proxy(this,"_handleMenuActionTriggerSubmit"))},_createMenuTriggerList:function(t){if(t&&t.length){for(var e=p("<ul/>"),s=0;s<t.length;s++){var i=t[s].handle;p('<li><a id="'+i+'-actiontrigger" data-action="'+i+'">'+t[s].name+"</a></li>").appendTo(e)}return e}}},{defaults:{context:"index",modal:null,storageKey:null,criteria:null,batchSize:50,disabledElementIds:[],selectable:!1,multiSelect:!1,buttonContainer:null,onAfterInit:p.noop,onSelectSource:p.noop,onUpdateElements:p.noop,onSelectionChange:p.noop,onEnableElements:p.noop,onDisableElements:p.noop}}),Craft.BaseElementIndexView=Garnish.Base.extend({$container:null,$loadingMoreSpinner:null,$elementContainer:null,$scroller:null,elementIndex:null,elementSelect:null,loadingMore:!1,_totalVisible:null,_morePending:null,_handleEnableElements:null,_handleDisableElements:null,init:function(t,e,s){this.elementIndex=t,this.$container=p(e),this.setSettings(s,Craft.BaseElementIndexView.defaults),this.$loadingMoreSpinner=p('<div class="centeralign hidden"><div class="spinner loadingmore"></div></div>').insertAfter(this.$container),this.$elementContainer=this.getElementContainer();var i=this.$elementContainer.children();this.setTotalVisible(i.length),this.setMorePending(this.settings.batchSize&&i.length==this.settings.batchSize),this.settings.selectable&&(this.elementSelect=new Garnish.Select(this.$elementContainer,i.filter(":not(.disabled)"),{multi:this.settings.multiSelect,vertical:this.isVerticalList(),handle:"index"==this.settings.context?".checkbox, .element:first":null,filter:":not(a):not(.toggle)",checkboxMode:this.settings.checkboxMode,onSelectionChange:p.proxy(this,"onSelectionChange")}),this._handleEnableElements=p.proxy(function(t){this.elementSelect.addItems(t.elements)},this),this._handleDisableElements=p.proxy(function(t){this.elementSelect.removeItems(t.elements)},this),this.elementIndex.on("enableElements",this._handleEnableElements),this.elementIndex.on("disableElements",this._handleDisableElements)),"index"==this.settings.context&&(this._handleElementEditing=p.proxy(function(t){var e=p(t.target);if("A"!=e.prop("nodeName")){var s;if(e.hasClass("element"))s=e;else if(!(s=e.closest(".element")).length)return;Garnish.hasAttr(s,"data-editable")&&this.createElementEditor(s)}},this),this.addListener(this.$elementContainer,"dblclick",this._handleElementEditing),p.isTouchCapable()&&this.addListener(this.$elementContainer,"taphold",this._handleElementEditing)),this.afterInit(),this.settings.batchSize&&("index"==this.settings.context?this.$scroller=Garnish.$win:this.$scroller=this.elementIndex.$main,this.$scroller.scrollTop(0),this.addListener(this.$scroller,"scroll","maybeLoadMore"),this.maybeLoadMore())},getElementContainer:function(){throw"Classes that extend Craft.BaseElementIndexView must supply a getElementContainer() method."},afterInit:function(){},getAllElements:function(){return this.$elementContainer.children()},getEnabledElements:function(){return this.$elementContainer.children(":not(.disabled)")},getElementById:function(t){var e=this.$elementContainer.children('[data-id="'+t+'"]:first');return e.length?e:null},getSelectedElements:function(){if(!this.elementSelect)throw"This view is not selectable.";return this.elementSelect.$selectedItems},getSelectedElementIds:function(){var t=this.getSelectedElements(),e=[];if(t)for(var s=0;s<t.length;s++)e.push(t.eq(s).data("id"));return e},selectElement:function(t){if(!this.elementSelect)throw"This view is not selectable.";return this.elementSelect.selectItem(t,!0),!0},selectElementById:function(t){if(!this.elementSelect)throw"This view is not selectable.";var e=this.getElementById(t);return!!e&&(this.elementSelect.selectItem(e,!0),!0)},selectAllElements:function(){this.elementSelect.selectAll()},deselectAllElements:function(){this.elementSelect.deselectAll()},isVerticalList:function(){return!1},getTotalVisible:function(){return this._totalVisible},setTotalVisible:function(t){this._totalVisible=t},getMorePending:function(){return this._morePending},setMorePending:function(t){this._morePending=t},maybeLoadMore:function(){this.canLoadMore()&&this.loadMore()},canLoadMore:function(){if(!this.getMorePending()||!this.settings.batchSize)return!1;if(this.$scroller[0]!=Garnish.$win[0])return this.$scroller.prop("scrollHeight")-this.$scroller.scrollTop()<=this.$scroller.outerHeight()+15;var t=Garnish.$win.innerHeight(),e=Garnish.$win.scrollTop();return this.$container.offset().top+this.$container.height()<=t+e},loadMore:function(){if(this.getMorePending()&&!this.loadingMore&&this.settings.batchSize){this.loadingMore=!0,this.$loadingMoreSpinner.removeClass("hidden"),this.removeListener(this.$scroller,"scroll");var t=this.getLoadMoreParams();Craft.postActionRequest("elementIndex/getMoreElements",t,p.proxy(function(t,e){if(this.loadingMore=!1,this.$loadingMoreSpinner.addClass("hidden"),"success"==e){var s=p(t.html);this.appendElements(s),Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),picturefill(),this.elementSelect&&(this.elementSelect.addItems(s.filter(":not(.disabled)")),this.elementIndex.updateActionTriggers()),this.setTotalVisible(this.getTotalVisible()+s.length),this.setMorePending(s.length==this.settings.batchSize),this.addListener(this.$scroller,"scroll","maybeLoadMore"),this.maybeLoadMore()}},this))}},getLoadMoreParams:function(){var t=p.extend(!0,{},this.settings.params);return t.criteria.offset=this.getTotalVisible(),t},appendElements:function(t){t.appendTo(this.$elementContainer),this.onAppendElements(t)},onAppendElements:function(t){this.settings.onAppendElements(t),this.trigger("appendElements",{newElements:t})},onSelectionChange:function(){this.settings.onSelectionChange(),this.trigger("selectionChange")},createElementEditor:function(t){new Craft.ElementEditor(t)},disable:function(){this.elementSelect&&this.elementSelect.disable()},enable:function(){this.elementSelect&&this.elementSelect.enable()},destroy:function(){this.$loadingMoreSpinner.remove(),this.elementSelect&&(this.elementIndex.off("enableElements",this._handleEnableElements),this.elementIndex.off("disableElements",this._handleDisableElements),this.elementSelect.destroy(),delete this.elementSelect),this.base()}},{defaults:{context:"index",batchSize:null,params:null,selectable:!1,multiSelect:!1,checkboxMode:!1,onAppendElements:p.noop,onSelectionChange:p.noop}}),Craft.BaseElementSelectInput=Garnish.Base.extend({elementSelect:null,elementSort:null,modal:null,elementEditor:null,$container:null,$elementsContainer:null,$elements:null,$addElementBtn:null,_initialized:!1,init:function(t){if(!p.isPlainObject(t)){for(var e={},s=["id","name","elementType","sources","criteria","sourceElementId","limit","modalStorageKey","fieldId"],i=0;i<s.length&&void 0!==arguments[i];i++)e[s[i]]=arguments[i];t=e}this.setSettings(t,Craft.BaseElementSelectInput.defaults),this.settings.modalStorageKey&&(this.modalStorageKey="BaseElementSelectInput."+this.settings.modalStorageKey),1==this.settings.limit&&(this.settings.sortable=!1),this.$container=this.getContainer(),this.$container.data("elementSelect",this),this.$elementsContainer=this.getElementsContainer(),this.$addElementBtn=this.getAddElementsBtn(),this.$addElementBtn&&1==this.settings.limit&&this.$addElementBtn.css("position","absolute").css("top",0).css(Craft.left,0),this.initElementSelect(),this.initElementSort(),this.resetElements(),this.$addElementBtn&&this.addListener(this.$addElementBtn,"activate","showModal"),this._initialized=!0},get totalSelected(){return this.$elements.length},getContainer:function(){return p("#"+this.settings.id)},getElementsContainer:function(){return this.$container.children(".elements")},getElements:function(){return this.$elementsContainer.children()},getAddElementsBtn:function(){return this.$container.children(".btn.add")},initElementSelect:function(){this.settings.selectable&&(this.elementSelect=new Garnish.Select({multi:this.settings.sortable,filter:":not(.delete)"}))},initElementSort:function(){this.settings.sortable&&(this.elementSort=new Garnish.DragSort({container:this.$elementsContainer,filter:this.settings.selectable?p.proxy(function(){return this.elementSort.$targetItem.hasClass("sel")?this.elementSelect.getSelectedItems():this.elementSort.$targetItem},this):null,ignoreHandleSelector:".delete",axis:this.getElementSortAxis(),collapseDraggees:!0,magnetStrength:4,helperLagBase:1.5,onSortChange:this.settings.selectable?p.proxy(function(){this.elementSelect.resetItemOrder()},this):null}))},getElementSortAxis:function(){return"list"==this.settings.viewMode?"y":null},canAddMoreElements:function(){return!this.settings.limit||this.$elements.length<this.settings.limit},updateAddElementsBtn:function(){this.canAddMoreElements()?this.enableAddElementsBtn():this.disableAddElementsBtn()},disableAddElementsBtn:function(){this.$addElementBtn&&!this.$addElementBtn.hasClass("disabled")&&(this.$addElementBtn.addClass("disabled"),1==this.settings.limit&&(this._initialized?this.$addElementBtn.velocity("fadeOut",Craft.BaseElementSelectInput.ADD_FX_DURATION):this.$addElementBtn.hide()))},enableAddElementsBtn:function(){this.$addElementBtn&&this.$addElementBtn.hasClass("disabled")&&(this.$addElementBtn.removeClass("disabled"),1==this.settings.limit&&(this._initialized?this.$addElementBtn.velocity("fadeIn",Craft.BaseElementSelectInput.REMOVE_FX_DURATION):this.$addElementBtn.show()))},resetElements:function(){this.$elements=p(),this.addElements(this.getElements())},addElements:function(t){this.settings.selectable&&this.elementSelect.addItems(t),this.settings.sortable&&this.elementSort.addItems(t),this.settings.editable&&(this._handleShowElementEditor=p.proxy(function(t){this.elementEditor=Craft.showElementEditor(p(t.currentTarget),this.settings.editorSettings)},this),this.addListener(t,"dblclick",this._handleShowElementEditor),p.isTouchCapable()&&this.addListener(t,"taphold",this._handleShowElementEditor)),t.find(".delete").on("click",p.proxy(function(t){this.removeElement(p(t.currentTarget).closest(".element"))},this)),this.$elements=this.$elements.add(t),this.updateAddElementsBtn()},removeElements:function(t){if(this.settings.selectable&&this.elementSelect.removeItems(t),this.modal){for(var e=[],s=0;s<t.length;s++){var i=t.eq(s).data("id");i&&e.push(i)}e.length&&this.modal.elementIndex.enableElementsById(e)}t.children("input").prop("disabled",!0),this.$elements=this.$elements.not(t),this.updateAddElementsBtn(),this.onRemoveElements()},removeElement:function(t){this.removeElements(t),this.animateElementAway(t,function(){t.remove()})},animateElementAway:function(t,e){t.css("z-index",0);var s={opacity:-1};s["margin-"+Craft.left]=-(t.outerWidth()+parseInt(t.css("margin-"+Craft.right))),"list"!=this.settings.viewMode&&0!=this.$elements.length||(s["margin-bottom"]=-(t.outerHeight()+parseInt(t.css("margin-bottom")))),t.velocity(s,Craft.BaseElementSelectInput.REMOVE_FX_DURATION,e)},showModal:function(){this.canAddMoreElements()&&(this.modal?this.modal.show():this.modal=this.createModal())},createModal:function(){return Craft.createElementSelectorModal(this.settings.elementType,this.getModalSettings())},getModalSettings:function(){return p.extend({closeOtherModals:!1,storageKey:this.modalStorageKey,sources:this.settings.sources,criteria:this.settings.criteria,multiSelect:1!=this.settings.limit,showLocaleMenu:this.settings.showLocaleMenu,disabledElementIds:this.getDisabledElementIds(),onSelect:p.proxy(this,"onModalSelect")},this.settings.modalSettings)},getSelectedElementIds:function(){for(var t=[],e=0;e<this.$elements.length;e++)t.push(this.$elements.eq(e).data("id"));return t},getDisabledElementIds:function(){var t=this.getSelectedElementIds();return this.settings.sourceElementId&&t.push(this.settings.sourceElementId),t},onModalSelect:function(t){if(this.settings.limit){var e=this.settings.limit-this.$elements.length;t.length>e&&(t=t.slice(0,e))}this.selectElements(t),this.updateDisabledElementsInModal()},selectElements:function(t){for(var e=0;e<t.length;e++){var s=t[e],i=this.createNewElement(s);this.appendElement(i),this.addElements(i),this.animateElementIntoPlace(s.$element,i)}this.onSelectElements(t)},createNewElement:function(t){var e=t.$element.clone();return Craft.setElementSize(e,"large"==this.settings.viewMode?"large":"small"),e.addClass("removable"),e.prepend('<input type="hidden" name="'+this.settings.name+'[]" value="'+t.id+'"><a class="delete icon" title="'+Craft.t("Remove")+'"></a>'),e},appendElement:function(t){t.appendTo(this.$elementsContainer)},animateElementIntoPlace:function(t,e){var s=t.offset(),i=e.offset(),n=e.clone().appendTo(Garnish.$bod);e.css("visibility","hidden"),n.css({position:"absolute",zIndex:1e4,top:s.top,left:s.left});var a={top:i.top,left:i.left};n.velocity(a,Craft.BaseElementSelectInput.ADD_FX_DURATION,function(){n.remove(),e.css("visibility","visible")})},updateDisabledElementsInModal:function(){this.modal.elementIndex&&this.modal.elementIndex.disableElementsById(this.getDisabledElementIds())},getElementById:function(t){for(var e=0;e<this.$elements.length;e++){var s=this.$elements.eq(e);if(s.data("id")==t)return s}},onSelectElements:function(t){this.trigger("selectElements",{elements:t}),this.settings.onSelectElements(t)},onRemoveElements:function(){this.trigger("removeElements"),this.settings.onRemoveElements()}},{ADD_FX_DURATION:200,REMOVE_FX_DURATION:200,defaults:{id:null,name:null,fieldId:null,elementType:null,sources:null,criteria:{},sourceElementId:null,viewMode:"list",limit:null,showLocaleMenu:!1,modalStorageKey:null,modalSettings:{},onSelectElements:p.noop,onRemoveElements:p.noop,sortable:!0,selectable:!0,editable:!0,editorSettings:{}}}),Craft.BaseElementSelectorModal=Garnish.Modal.extend({elementType:null,elementIndex:null,$body:null,$sidebar:null,$sources:null,$sourceToggles:null,$main:null,$search:null,$elements:null,$tbody:null,$primaryButtons:null,$secondaryButtons:null,$cancelBtn:null,$selectBtn:null,$footerSpinner:null,init:function(t,e){this.elementType=t,this.setSettings(e,Craft.BaseElementSelectorModal.defaults);var s=p('<div class="modal elementselectormodal"></div>').appendTo(Garnish.$bod),i=p('<div class="body"><div class="spinner big"></div></div>').appendTo(s),n=p('<div class="footer"/>').appendTo(s);this.base(s,this.settings),this.$footerSpinner=p('<div class="spinner hidden"/>').appendTo(n),this.$primaryButtons=p('<div class="buttons right"/>').appendTo(n),this.$secondaryButtons=p('<div class="buttons left secondary-buttons"/>').appendTo(n),this.$cancelBtn=p('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(this.$primaryButtons),this.$selectBtn=p('<div class="btn disabled submit">'+Craft.t("Select")+"</div>").appendTo(this.$primaryButtons),this.$body=i,this.addListener(this.$cancelBtn,"activate","cancel"),this.addListener(this.$selectBtn,"activate","selectElements")},onFadeIn:function(){this.elementIndex?Garnish.isMobileBrowser(!0)||this.elementIndex.$search.trigger("focus"):this._createElementIndex(),this.base()},onSelectionChange:function(){this.updateSelectBtnState()},updateSelectBtnState:function(){this.$selectBtn&&(this.elementIndex.getSelectedElements().length?this.enableSelectBtn():this.disableSelectBtn())},enableSelectBtn:function(){this.$selectBtn.removeClass("disabled")},disableSelectBtn:function(){this.$selectBtn.addClass("disabled")},enableCancelBtn:function(){this.$cancelBtn.removeClass("disabled")},disableCancelBtn:function(){this.$cancelBtn.addClass("disabled")},showFooterSpinner:function(){this.$footerSpinner.removeClass("hidden")},hideFooterSpinner:function(){this.$footerSpinner.addClass("hidden")},cancel:function(){this.$cancelBtn.hasClass("disabled")||this.hide()},selectElements:function(){if(this.elementIndex&&this.elementIndex.getSelectedElements().length){this.elementIndex.view.elementSelect.clearMouseUpTimeout();var t=this.elementIndex.getSelectedElements(),e=this.getElementInfo(t);this.onSelect(e),this.settings.disableElementsOnSelect&&this.elementIndex.disableElements(this.elementIndex.getSelectedElements()),this.settings.hideOnSelect&&this.hide()}},getElementInfo:function(t){for(var e=[],s=0;s<t.length;s++){var i=p(t[s]);e.push(Craft.getElementInfo(i))}return e},show:function(){this.updateSelectBtnState(),this.base()},onSelect:function(t){this.settings.onSelect(t)},disable:function(){this.elementIndex&&this.elementIndex.disable(),this.base()},enable:function(){this.elementIndex&&this.elementIndex.enable(),this.base()},_createElementIndex:function(){var t={context:"modal",elementType:this.elementType,sources:this.settings.sources};null!==this.settings.showLocaleMenu&&"auto"!=this.settings.showLocaleMenu&&(t.showLocaleMenu=this.settings.showLocaleMenu?"1":"0"),Craft.postActionRequest("elements/getModalBody",t,p.proxy(function(t,e){"success"==e&&(this.$body.html(t),this.$body.has(".sidebar:not(.hidden)").length&&this.$body.addClass("has-sidebar"),this.elementIndex=Craft.createElementIndex(this.elementType,this.$body,{context:"modal",modal:this,storageKey:this.settings.storageKey,criteria:this.settings.criteria,disabledElementIds:this.settings.disabledElementIds,selectable:!0,multiSelect:this.settings.multiSelect,buttonContainer:this.$secondaryButtons,onSelectionChange:p.proxy(this,"onSelectionChange")}),this.addListener(this.elementIndex.$elements,"doubletap",function(t,e){e.firstTap.target===e.secondTap.target&&this.selectElements()}))},this))}},{defaults:{resizable:!0,storageKey:null,sources:null,criteria:null,multiSelect:!1,showLocaleMenu:null,disabledElementIds:[],disableElementsOnSelect:!1,hideOnSelect:!0,onCancel:p.noop,onSelect:p.noop}}),Craft.BaseInputGenerator=Garnish.Base.extend({$source:null,$target:null,$form:null,settings:null,listening:null,timeout:null,init:function(t,e,s){this.$source=p(t),this.$target=p(e),this.$form=this.$source.closest("form"),this.setSettings(s),this.startListening()},setNewSource:function(t){var e=this.listening;this.stopListening(),this.$source=p(t),e&&this.startListening()},startListening:function(){this.listening||(this.listening=!0,this.addListener(this.$source,"textchange","onTextChange"),this.addListener(this.$form,"submit","onFormSubmit"),this.addListener(this.$target,"focus",function(){this.addListener(this.$target,"textchange","stopListening"),this.addListener(this.$target,"blur",function(){this.removeListener(this.$target,"textchange,blur")})}))},stopListening:function(){this.listening&&(this.listening=!1,this.removeAllListeners(this.$source),this.removeAllListeners(this.$target),this.removeAllListeners(this.$form))},onTextChange:function(){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(p.proxy(this,"updateTarget"),250)},onFormSubmit:function(){this.timeout&&clearTimeout(this.timeout),this.updateTarget()},updateTarget:function(){var t=this.$source.val(),e=this.generateTargetValue(t);this.$target.val(e),this.$target.trigger("textchange")},generateTargetValue:function(t){return t}}),Craft.AdminTable=Garnish.Base.extend({settings:null,totalObjects:null,sorter:null,$noObjects:null,$table:null,$tbody:null,$deleteBtns:null,init:function(t){this.setSettings(t,Craft.AdminTable.defaults),this.settings.allowDeleteAll||(this.settings.minObjects=1),this.$noObjects=p(this.settings.noObjectsSelector),this.$table=p(this.settings.tableSelector),this.$tbody=this.$table.children("tbody"),this.totalObjects=this.$tbody.children().length,this.settings.sortable&&(this.sorter=new Craft.DataTableSorter(this.$table,{onSortChange:p.proxy(this,"reorderObjects")})),this.$deleteBtns=this.$table.find(".delete"),this.addListener(this.$deleteBtns,"click","handleDeleteBtnClick"),this.updateUI()},addRow:function(t){if(!(this.settings.maxObjects&&this.totalObjects>=this.settings.maxObjects)){var e=p(t).appendTo(this.$tbody),s=e.find(".delete");this.settings.sortable&&this.sorter.addItems(e),this.$deleteBtns=this.$deleteBtns.add(s),this.addListener(s,"click","handleDeleteBtnClick"),this.totalObjects++,this.updateUI()}},reorderObjects:function(){if(!this.settings.sortable)return!1;for(var s=[],t=0;t<this.sorter.$items.length;t++){var e=p(this.sorter.$items[t]).attr(this.settings.idAttribute);s.push(e)}var i={ids:JSON.stringify(s)};Craft.postActionRequest(this.settings.reorderAction,i,p.proxy(function(t,e){"success"==e&&(t.success?(this.onReorderObjects(s),Craft.cp.displayNotice(Craft.t(this.settings.reorderSuccessMessage))):Craft.cp.displayError(Craft.t(this.settings.reorderFailMessage)))},this))},handleDeleteBtnClick:function(t){if(!(this.settings.minObjects&&this.totalObjects<=this.settings.minObjects)){var e=p(t.target).closest("tr");this.confirmDeleteObject(e)&&this.deleteObject(e)}},confirmDeleteObject:function(t){var e=this.getObjectName(t);return confirm(Craft.t(this.settings.confirmDeleteMessage,{name:e}))},deleteObject:function(s){var t={id:this.getObjectId(s)};Craft.postActionRequest(this.settings.deleteAction,t,p.proxy(function(t,e){"success"==e&&this.handleDeleteObjectResponse(t,s)},this))},handleDeleteObjectResponse:function(t,e){var s=this.getObjectId(e),i=this.getObjectName(e);t.success?(this.sorter&&this.sorter.removeItems(e),e.remove(),this.totalObjects--,this.updateUI(),this.onDeleteObject(s),Craft.cp.displayNotice(Craft.t(this.settings.deleteSuccessMessage,{name:Craft.escapeHtml(i)}))):Craft.cp.displayError(Craft.t(this.settings.deleteFailMessage,{name:Craft.escapeHtml(i)}))},onReorderObjects:function(t){this.settings.onReorderObjects(t)},onDeleteObject:function(t){this.settings.onDeleteObject(t)},getObjectId:function(t){return t.attr(this.settings.idAttribute)},getObjectName:function(t){return t.attr(this.settings.nameAttribute)},updateUI:function(){if(0==this.totalObjects?(this.$table.hide(),this.$noObjects.removeClass("hidden")):(this.$table.show(),this.$noObjects.addClass("hidden")),this.settings.sortable){var t=this.$table.find(".move");1==this.totalObjects?t.addClass("disabled"):t.removeClass("disabled")}this.settings.minObjects&&this.totalObjects<=this.settings.minObjects?this.$deleteBtns.addClass("disabled"):this.$deleteBtns.removeClass("disabled"),this.settings.newObjectBtnSelector&&(this.settings.maxObjects&&this.totalObjects>=this.settings.maxObjects?p(this.settings.newObjectBtnSelector).addClass("hidden"):p(this.settings.newObjectBtnSelector).removeClass("hidden"))}},{defaults:{tableSelector:null,noObjectsSelector:null,newObjectBtnSelector:null,idAttribute:"data-id",nameAttribute:"data-name",sortable:!1,allowDeleteAll:!0,minObjects:0,maxObjects:null,reorderAction:null,deleteAction:null,reorderSuccessMessage:Craft.t("New order saved."),reorderFailMessage:Craft.t("Couldn’t save new order."),confirmDeleteMessage:Craft.t("Are you sure you want to delete “{name}”?"),deleteSuccessMessage:Craft.t("“{name}” deleted."),deleteFailMessage:Craft.t("Couldn’t delete “{name}”."),onReorderObjects:p.noop,onDeleteObject:p.noop}}),Craft.AssetIndex=Craft.BaseElementIndex.extend({$includeSubfoldersContainer:null,$includeSubfoldersCheckbox:null,showingIncludeSubfoldersCheckbox:!1,$uploadButton:null,$uploadInput:null,$progressBar:null,$folders:null,uploader:null,promptHandler:null,progressBar:null,_uploadTotalFiles:0,_uploadFileProgress:{},_uploadedFileIds:[],_currentUploaderSettings:{},_fileDrag:null,_folderDrag:null,_expandDropTargetFolderTimeout:null,_tempExpandedFolders:[],init:function(t,e,s){this.base(t,e,s),"index"==this.settings.context?(this._initIndexPageMode(),this.addListener(Garnish.$win,"resize,scroll","_positionProgressBar")):(this.addListener(this.$main,"scroll","_positionProgressBar"),this.settings.modal&&this.settings.modal.on("updateSizeAndPosition",p.proxy(this,"_positionProgressBar")))},initSource:function(t){this.base(t),this._createFolderContextMenu(t),"index"==this.settings.context&&(this._folderDrag&&1<this._getSourceLevel(t)&&this._getFolderIdFromSourceKey(t.data("key"))&&this._folderDrag.addItems(t.parent()),this._fileDrag&&this._fileDrag.updateDropTargets())},deinitSource:function(t){this.base(t);var e=t.data("contextmenu");e&&e.destroy(),"index"==this.settings.context&&(this._folderDrag&&1<this._getSourceLevel(t)&&this._folderDrag.removeItems(t.parent()),this._fileDrag&&this._fileDrag.updateDropTargets())},_getSourceLevel:function(t){return t.parentsUntil("nav","ul").length},_initIndexPageMode:function(){this.settings.selectable=!0,this.settings.multiSelect=!0;var t=p.proxy(this,"_onDragStart"),e=p.proxy(this,"_onDropTargetChange");this._fileDrag=new Garnish.DragDrop({activeDropTargetClass:"sel",helperOpacity:.75,filter:p.proxy(function(){return this.view.getSelectedElements()},this),helper:p.proxy(function(t){return this._getFileDragHelper(t)},this),dropTargets:p.proxy(function(){for(var t=[],e=0;e<this.$sources.length;e++)this._getFolderIdFromSourceKey(this.$sources.eq(e).data("key"))&&t.push(p(this.$sources[e]));return t},this),onDragStart:t,onDropTargetChange:e,onDragStop:p.proxy(this,"_onFileDragStop")}),this._folderDrag=new Garnish.DragDrop({activeDropTargetClass:"sel",helperOpacity:.75,filter:p.proxy(function(){for(var t=this.sourceSelect.getSelectedItems(),e=[],s=0;s<t.length;s++){var i=t.eq(s);this._getFolderIdFromSourceKey(i.data("key"))&&(i.hasClass("sel")&&1<this._getSourceLevel(i)&&e.push(i.parent()[0]))}return p(e)},this),helper:p.proxy(function(t){var e=p('<div class="sidebar" style="padding-top: 0; padding-bottom: 0;"/>'),s=p("<nav/>").appendTo(e),i=p("<ul/>").appendTo(s);return t.appendTo(i).removeClass("expanded"),t.children("a").addClass("sel"),t.css({"padding-top":this._folderDrag.$draggee.css("padding-top"),"padding-right":this._folderDrag.$draggee.css("padding-right"),"padding-bottom":this._folderDrag.$draggee.css("padding-bottom"),"padding-left":this._folderDrag.$draggee.css("padding-left")}),e},this),dropTargets:p.proxy(function(){var t=[],e=[];this._folderDrag.$draggee.find("a[data-key]").each(function(){e.push(p(this).data("key"))});for(var s=0;s<this.$sources.length;s++){var i=this.$sources.eq(s);this._getFolderIdFromSourceKey(i.data("key"))&&(Craft.inArray(i.data("key"),e)||t.push(i))}return t},this),onDragStart:t,onDropTargetChange:e,onDragStop:p.proxy(this,"_onFolderDragStop")})},_onFileDragStop:function(){if(this._fileDrag.$activeDropTarget&&this._fileDrag.$activeDropTarget[0]!=this.$source[0]){for(var r=this.$source,o=this._getFolderIdFromSourceKey(this._fileDrag.$activeDropTarget.data("key")),l=[],t=[],e=0;e<this._fileDrag.$draggee.length;e++){var s=Craft.getElementInfo(this._fileDrag.$draggee[e]).id,i=Craft.getElementInfo(this._fileDrag.$draggee[e]).url.split("/").pop();-1!==i.indexOf("?")&&(i=i.split("?").shift()),l.push(s),t.push(i)}if(l.length){this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(l.length),this.progressBar.showProgressBar();var h=[];for(e=0;e<l.length;e++)h.push({fileId:l[e],folderId:o,fileName:t[e]});var d=p.proxy(function(t){this.promptHandler.resetPrompts();for(var e=0;e<t.length;e++){var s=t[e];s.prompt&&this.promptHandler.addPrompt(s),s.error&&alert(s.error)}this.setIndexAvailable(),this.progressBar.hideProgressBar();var n=!1,a=function(){this.sourceSelect.selectItem(r),this._totalVisible-=this._fileDrag.$draggee.length;for(var t=0;t<l.length;t++)p("[data-id="+l[t]+"]").remove();this.view.deselectAllElements(),this._collapseExtraExpandedFolders(o),n&&this.updateElements()};if(this.promptHandler.getPromptCount()){var i=p.proxy(function(t){for(var e=[],s=0;s<t.length;s++)if("cancel"!=t[s].choice)for(var i=0;i<h.length;i++)h[i].fileName==t[s].fileName&&(h[i].action=t[s].choice,e.push(h[i]));else n=!0;0==e.length?a.apply(this):(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),this._moveFile(e,0,d))},this);this._fileDrag.fadeOutHelpers(),this.promptHandler.showBatchPrompts(i)}else a.apply(this),this._fileDrag.fadeOutHelpers()},this);return void this._moveFile(h,0,d)}}else this.$source.addClass("sel"),this._collapseExtraExpandedFolders();this._fileDrag.returnHelpersToDraggees()},_onFolderDragStop:function(){if(this._folderDrag.$activeDropTarget&&0==this._folderDrag.$activeDropTarget.siblings("ul").children("li").filter(this._folderDrag.$draggee).length){var r=this._getFolderIdFromSourceKey(this._folderDrag.$activeDropTarget.data("key"));this._collapseExtraExpandedFolders(r);for(var t=[],e=0;e<this._folderDrag.$draggee.length;e++){var s=this._folderDrag.$draggee.eq(e).children("a"),i=this._getFolderIdFromSourceKey(s.data("key")),n=this._getSourceByFolderId(i);this._getFolderIdFromSourceKey(this._getParentSource(n).data("key"))!=r&&t.push(i)}if(t.length){t.sort(),t.reverse(),this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(t.length),this.progressBar.showProgressBar();var a=[],o=[];for(e=0;e<t.length;e++)o.push({folderId:t[e],parentId:r});this.requestId++;var l=[],h=[],d={},c=[],u=p.proxy(function(t){this.promptHandler.resetPrompts();for(var e=0;e<t.length;e++){var s=t[e];if(s.success&&s.transferList&&s.deleteList&&s.changedFolderIds){for(var i=0;i<s.transferList.length;i++)l.push(s.transferList[i]);for(i=0;i<s.deleteList.length;i++)h.push(s.deleteList[i]);for(var n in s.changedFolderIds)d[n]=s.changedFolderIds[n];c.push(s.removeFromTree)}s.prompt&&this.promptHandler.addPrompt(s),s.error&&alert(s.error)}if(this.promptHandler.getPromptCount()){var a=p.proxy(function(t){this.promptHandler.resetPrompts(),this.setNewElementDataHtml("");for(var e=[],s=0;s<t.length;s++)"cancel"!=t[s].choice&&(o[0].action=t[s].choice,e.push(o[0]));0==e.length?p.proxy(this,"_performActualFolderMove",l,h,d,c)():(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),g(e,0,u))},this);this.promptHandler.showBatchPrompts(a),this.setIndexAvailable(),this.progressBar.hideProgressBar()}else p.proxy(this,"_performActualFolderMove",l,h,d,c,r)()},this),g=p.proxy(function(s,i,n){0==i&&(a=[]),Craft.postActionRequest("assets/moveFolder",s[i],p.proxy(function(t,e){i++,this.progressBar.incrementProcessedItemCount(1),this.progressBar.updateProgressBar(),"success"==e&&a.push(t),i>=s.length?n(a):g(s,i,n)},this))},this);return void g(o,0,u)}}else this.$source.addClass("sel"),this._collapseExtraExpandedFolders();this._folderDrag.returnHelpersToDraggees()},_performActualFolderMove:function(t,e,s,i,c){this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(1),this.progressBar.showProgressBar();var n=p.proxy(function(t,e,s){var i,n;for(var a in e)(n=this._getSourceByFolderId(a)).attr("data-key","folder:"+e[a].newId).data("key","folder:"+e[a].newId),n=n.parent(),(!i||0<i.parents().filter(n).length)&&(i=n,topFolderMovedId=e[a].newId);if(0==i.length)return this.setIndexAvailable(),this.progressBar.hideProgressBar(),void this._folderDrag.returnHelpersToDraggees();var r=i.children("a"),o=i.siblings("ul, .toggle"),l=this._getParentSource(r),h=this._getSourceByFolderId(c);this._prepareParentForChildren(h),this._appendSubfolder(h,i),r.after(o),this._cleanUpTree(l),this.$sidebar.find("ul>ul, ul>.toggle").remove();for(var d=0;d<t.length;d++)Craft.postActionRequest("assets/deleteFolder",{folderId:t[d]});this.setIndexAvailable(),this.progressBar.hideProgressBar(),this._folderDrag.returnHelpersToDraggees(),this._selectSourceByFolderId(topFolderMovedId)},this);0<t.length?this._moveFile(t,0,p.proxy(function(){n(e,s,i)},this)):n(e,s,i)},_getParentSource:function(t){if(1<this._getSourceLevel(t))return t.parent().parent().siblings("a")},_moveFile:function(s,i,n){0==i&&(this.responseArray=[]),Craft.postActionRequest("assets/moveFile",s[i],p.proxy(function(t,e){this.progressBar.incrementProcessedItemCount(1),this.progressBar.updateProgressBar(),"success"==e&&(this.responseArray.push(t),Craft.cp.runPendingTasks()),++i>=s.length?n(this.responseArray):this._moveFile(s,i,n)},this))},_selectSourceByFolderId:function(t){for(var e=this._getSourceByFolderId(t),s=e.parent().parents("li"),i=0;i<s.length;i++){var n=p(s[i]);n.hasClass("expanded")||n.children(".toggle").trigger("click")}this.selectSource(e),this.updateElements()},afterInit:function(){this.$uploadButton||(this.$uploadButton=p('<div class="btn submit" data-icon="upload" style="position: relative; overflow: hidden;" role="button">'+Craft.t("Upload files")+"</div>"),this.addButton(this.$uploadButton),this.$uploadInput=p('<input type="file" multiple="multiple" name="assets-upload" />').hide().insertBefore(this.$uploadButton)),this.promptHandler=new Craft.PromptHandler,this.progressBar=new Craft.ProgressBar(this.$main,!0);var t={url:Craft.getActionUrl("assets/uploadFile"),fileInput:this.$uploadInput,dropZone:this.$main};t.events={fileuploadstart:p.proxy(this,"_onUploadStart"),fileuploadprogressall:p.proxy(this,"_onUploadProgress"),fileuploaddone:p.proxy(this,"_onUploadComplete")},void 0!==this.settings.criteria.kind&&(t.allowedKinds=this.settings.criteria.kind),this._currentUploaderSettings=t,this.uploader=new Craft.Uploader(this.$uploadButton,t),this.$uploadButton.on("click",p.proxy(function(){this.$uploadButton.hasClass("disabled")||this.isIndexBusy||this.$uploadButton.parent().find("input[name=assets-upload]").trigger("click")},this)),this.base()},onSelectSource:function(){this.uploader.setParams({folderId:this._getFolderIdFromSourceKey(this.sourceKey)}),this.$source.attr("data-upload")?this.$uploadButton.removeClass("disabled"):this.$uploadButton.addClass("disabled"),this.base()},_getFolderIdFromSourceKey:function(t){var e=t.split(":");return 1<e.length&&"folder"==e[0]?e[1]:null},startSearching:function(){if(this.$source.siblings("ul").length){if(null===this.$includeSubfoldersContainer){var t="includeSubfolders-"+Math.floor(1e9*Math.random());this.$includeSubfoldersContainer=p('<div style="margin-bottom: -23px; opacity: 0;"/>').insertAfter(this.$search);var e=p('<div style="padding-top: 5px;"/>').appendTo(this.$includeSubfoldersContainer);this.$includeSubfoldersCheckbox=p('<input type="checkbox" id="'+t+'" class="checkbox"/>').appendTo(e),p('<label class="light smalltext" for="'+t+'"/>').text(" "+Craft.t("Search in subfolders")).appendTo(e),this.addListener(this.$includeSubfoldersCheckbox,"change",function(){this.setSelecetedSourceState("includeSubfolders",this.$includeSubfoldersCheckbox.prop("checked")),this.updateElements()})}else this.$includeSubfoldersContainer.velocity("stop");var s=this.getSelectedSourceState("includeSubfolders",!1);this.$includeSubfoldersCheckbox.prop("checked",s),this.$includeSubfoldersContainer.velocity({marginBottom:0,opacity:1},"fast"),this.showingIncludeSubfoldersCheckbox=!0}this.base()},stopSearching:function(){this.showingIncludeSubfoldersCheckbox&&(this.$includeSubfoldersContainer.velocity("stop"),this.$includeSubfoldersContainer.velocity({marginBottom:-23,opacity:0},"fast"),this.showingIncludeSubfoldersCheckbox=!1),this.base()},getViewParams:function(){var t=this.base();return this.showingIncludeSubfoldersCheckbox&&this.$includeSubfoldersCheckbox.prop("checked")&&(t.criteria.includeSubfolders=!0),t},_onUploadStart:function(t){this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar(),this.promptHandler.resetPrompts()},_onUploadProgress:function(t,e){var s=parseInt(e.loaded/e.total*100,10);this.progressBar.setProgressPercentage(s)},_onUploadComplete:function(t,e){var s=e.result,i=e.files[0].name,n=!0;s.success||s.prompt?(this._uploadedFileIds.push(s.fileId),s.prompt&&this.promptHandler.addPrompt(s)):(s.error?alert(Craft.t("Upload failed for {filename}. The error message was: “{error}”",{filename:i,error:s.error})):alert(Craft.t("Upload failed for {filename}.",{filename:i})),n=!1),this.uploader.isLastUpload()&&(this.setIndexAvailable(),this.progressBar.hideProgressBar(),this.promptHandler.getPromptCount()?this.promptHandler.showBatchPrompts(p.proxy(this,"_uploadFollowup")):n&&this._updateAfterUpload())},_updateAfterUpload:function(){"index"!==this.settings.context&&(this.setSortAttribute("dateModified"),this.setSortDirection("desc")),this.updateElements()},_uploadFollowup:function(t){this.setIndexBusy(),this.progressBar.resetProgressBar(),this.promptHandler.resetPrompts();var e=p.proxy(function(){this.setIndexAvailable(),this.progressBar.hideProgressBar(),this._updateAfterUpload()},this);this.progressBar.setItemCount(t.length);var a=p.proxy(function(s,i,n){var t={newFileId:s[i].fileId,fileName:s[i].fileName,userResponse:s[i].choice};Craft.postActionRequest("assets/uploadFile",t,p.proxy(function(t,e){"success"==e&&t.fileId&&this._uploadedFileIds.push(t.fileId),i++,this.progressBar.incrementProcessedItemCount(1),this.progressBar.updateProgressBar(),i==s.length?n():a(s,i,n)},this))},this);this.progressBar.showProgressBar(),a(t,0,e)},onUpdateElements:function(){this._onUpdateElements(!1,this.view.getAllElements()),this.view.on("appendElements",p.proxy(function(t){this._onUpdateElements(!0,t.newElements)},this)),this.base()},_onUpdateElements:function(t,e){if("index"==this.settings.context&&(t||this._fileDrag.removeAllItems(),this._fileDrag.addItems(e)),this._uploadedFileIds.length){if(this.view.settings.selectable)for(var s=0;s<this._uploadedFileIds.length;s++)this.view.selectElementById(this._uploadedFileIds[s]);this._uploadedFileIds=[]}},_onDragStart:function(){this._tempExpandedFolders=[]},_getFileDragHelper:function(t){switch(this.getSelectedSourceState("mode")){case"table":var e=p('<div class="elements datatablesorthelper"/>').appendTo(Garnish.$bod),s=p('<div class="tableview"/>').appendTo(e),i=p('<table class="data"/>').appendTo(s),n=p("<tbody/>").appendTo(i);t.appendTo(n),this._$firstRowCells=this.view.$table.children("tbody").children("tr:first").children();for(var a=t.children(),r=0;r<a.length;r++){var o=p(a[r]);if(o.hasClass("checkbox-cell"))o.remove(),e.css("margin-"+Craft.left,19);else{var l=p(this._$firstRowCells[r]),h=l.width();l.width(h),o.width(h)}}return e;case"thumbs":e=p('<div class="elements thumbviewhelper"/>').appendTo(Garnish.$bod),s=p('<ul class="thumbsview"/>').appendTo(e);return t.appendTo(s),e}return p()},_onDropTargetChange:function(t){if(clearTimeout(this._expandDropTargetFolderTimeout),t){var e=this._getFolderIdFromSourceKey(t.data("key"));e?(this.dropTargetFolder=this._getSourceByFolderId(e),this._hasSubfolders(this.dropTargetFolder)&&!this._isExpanded(this.dropTargetFolder)&&(this._expandDropTargetFolderTimeout=setTimeout(p.proxy(this,"_expandFolder"),500))):this.dropTargetFolder=null}t&&t[0]!=this.$source[0]?this.$source.removeClass("sel"):this.$source.addClass("sel")},_collapseExtraExpandedFolders:function(t){var e;clearTimeout(this._expandDropTargetFolderTimeout),t&&(e=this._getSourceByFolderId(t).parents("li").children("a"));for(var s=this._tempExpandedFolders.length-1;0<=s;s--){var i=this._tempExpandedFolders[s];t&&0!=e.filter('[data-key="'+i.data("key")+'"]').length||(this._collapseFolder(i),this._tempExpandedFolders.splice(s,1))}},_getSourceByFolderId:function(t){return this.$sources.filter('[data-key="folder:'+t+'"]')},_hasSubfolders:function(t){return t.siblings("ul").find("li").length},_isExpanded:function(t){return t.parent("li").hasClass("expanded")},_expandFolder:function(){this._collapseExtraExpandedFolders(this._getFolderIdFromSourceKey(this.dropTargetFolder.data("key"))),this.dropTargetFolder.siblings(".toggle").trigger("click"),this._tempExpandedFolders.push(this.dropTargetFolder)},_collapseFolder:function(t){t.parent().hasClass("expanded")&&t.siblings(".toggle").trigger("click")},_createFolderContextMenu:function(t){if(this._getFolderIdFromSourceKey(t.data("key"))){var e=[{label:Craft.t("New subfolder"),onClick:p.proxy(this,"_createSubfolder",t)}];"index"==this.settings.context&&1<this._getSourceLevel(t)&&(e.push({label:Craft.t("Rename folder"),onClick:p.proxy(this,"_renameFolder",t)}),e.push({label:Craft.t("Delete folder"),onClick:p.proxy(this,"_deleteFolder",t)})),new Garnish.ContextMenu(t,e,{menuClass:"menu"})}},_createSubfolder:function(n){var t=prompt(Craft.t("Enter the name of the folder"));if(t){var e={parentId:this._getFolderIdFromSourceKey(n.data("key")),folderName:t};this.setIndexBusy(),Craft.postActionRequest("assets/createFolder",e,p.proxy(function(t,e){if(this.setIndexAvailable(),"success"==e&&t.success){this._prepareParentForChildren(n);var s=p('<li><a data-key="folder:'+t.folderId+'"'+(Garnish.hasAttr(n,"data-has-thumbs")?" data-has-thumbs":"")+' data-upload="'+n.attr("data-upload")+'">'+t.folderName+"</a></li>"),i=s.children("a:first");this._appendSubfolder(n,s),this.initSource(i)}"success"==e&&t.error&&alert(t.error)},this))}},_deleteFolder:function(i){if(confirm(Craft.t("Really delete folder “{folder}”?",{folder:p.trim(i.text())}))){var t={folderId:this._getFolderIdFromSourceKey(i.data("key"))};this.setIndexBusy(),Craft.postActionRequest("assets/deleteFolder",t,p.proxy(function(t,e){if(this.setIndexAvailable(),"success"==e&&t.success){var s=this._getParentSource(i);this.deinitSource(i),i.parent().remove(),this._cleanUpTree(s)}"success"==e&&t.error&&alert(t.error)},this))}},_renameFolder:function(s){var t=p.trim(s.text()),e=prompt(Craft.t("Rename folder"),t);if(e&&e!=t){var i={folderId:this._getFolderIdFromSourceKey(s.data("key")),newName:e};this.setIndexBusy(),Craft.postActionRequest("assets/renameFolder",i,p.proxy(function(t,e){this.setIndexAvailable(),"success"==e&&t.success&&s.text(t.newName),"success"==e&&t.error&&alert(t.error)},this),"json")}},_prepareParentForChildren:function(t){this._hasSubfolders(t)||(t.parent().addClass("expanded").append('<div class="toggle"></div><ul></ul>'),this.initSourceToggle(t))},_appendSubfolder:function(t,e){for(var s=t.siblings("ul").children("li"),i=p.trim(e.children("a:first").text()),n=!1,a=0;a<s.length;a++){var r=p(s[a]);if(p.trim(r.children("a:first").text())>i){r.before(e),n=!0;break}}n||t.siblings("ul").append(e)},_cleanUpTree:function(t){null!==t&&0==t.siblings("ul").children("li").length&&(this.deinitSourceToggle(t),t.siblings("ul").remove(),t.siblings(".toggle").remove(),t.parent().removeClass("expanded"))},_positionProgressBar:function(){var t=p(),e=0,s=0,i=(e="index"==this.settings.context?(t=this.progressBar.$progressBar.closest("#content"),Garnish.$win.scrollTop()):(t=this.progressBar.$progressBar.closest(".main"),this.$main.scrollTop()))-t.offset().top,n=Garnish.$win.height();s=t.height()>n?n/2-6+i:t.height()/2-6,"index"!=this.settings.context&&(s=e+(t.height()/2-6)),this.progressBar.$progressBar.css({top:s})}}),Craft.registerElementIndexClass("Asset",Craft.AssetIndex),Craft.AssetSelectInput=Craft.BaseElementSelectInput.extend({requestId:0,hud:null,uploader:null,progressBar:null,originalFilename:"",originalExtension:"",init:function(t){t.editorSettings={onShowHud:p.proxy(this.resetOriginalFilename,this),onCreateForm:p.proxy(this._renameHelper,this),validators:[p.proxy(this.validateElementForm,this)]},this.base(t),this._attachUploader()},_attachUploader:function(){this.progressBar=new Craft.ProgressBar(p('<div class="progress-shade"></div>').appendTo(this.$container));var t={url:Craft.getActionUrl("assets/expressUpload"),dropZone:this.$container,formData:{fieldId:this.settings.fieldId,elementId:this.settings.sourceElementId}};void 0!==Craft.csrfTokenName&&void 0!==Craft.csrfTokenValue&&(t.formData[Craft.csrfTokenName]=Craft.csrfTokenValue),void 0!==this.settings.criteria.kind&&(t.allowedKinds=this.settings.criteria.kind),t.canAddMoreFiles=p.proxy(this,"canAddMoreFiles"),t.events={},t.events.fileuploadstart=p.proxy(this,"_onUploadStart"),t.events.fileuploadprogressall=p.proxy(this,"_onUploadProgress"),t.events.fileuploaddone=p.proxy(this,"_onUploadComplete"),this.uploader=new Craft.Uploader(this.$container,t)},selectUploadedFile:function(t){if(this.canAddMoreElements()){var e=t.$element;e.addClass("removable"),e.prepend('<input type="hidden" name="'+this.settings.name+'[]" value="'+t.id+'"><a class="delete icon" title="'+Craft.t("Remove")+'"></a>'),e.appendTo(this.$elementsContainer);var s=-(e.outerWidth()+10);this.$addElementBtn.css("margin-"+Craft.left,s+"px");var i={};i["margin-"+Craft.left]=0,this.$addElementBtn.velocity(i,"fast"),this.addElements(e),delete this.modal}},_onUploadStart:function(t){this.progressBar.$progressBar.css({top:Math.round(this.$container.outerHeight()/2)-6}),this.$container.addClass("uploading"),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar()},_onUploadProgress:function(t,e){var s=parseInt(e.loaded/e.total*100,10);this.progressBar.setProgressPercentage(s)},_onUploadComplete:function(t,e){if(e.result.error)alert(e.result.error);else{var s=p(e.result.html);Craft.appendHeadHtml(e.result.headHtml),this.selectUploadedFile(Craft.getElementInfo(s))}this.uploader.isLastUpload()&&(this.progressBar.hideProgressBar(),this.$container.removeClass("uploading"))},canAddMoreFiles:function(t){return!this.settings.limit||this.$elements.length+t<this.settings.limit},_parseFilename:function(t){var e=t.split("."),s="";return 1<e.length&&(s=e.pop()),{extension:s,baseFileName:e.join(".")}},_renameHelper:function(t){p(".renameHelper",t).on("focus",p.proxy(function(t){input=t.currentTarget;var e=this._parseFilename(input.value);""==this.originalFilename&&""==this.originalExtension&&(this.originalFilename=e.baseFileName,this.originalExtension=e.extension);var s=e.baseFileName.length;if(void 0!==input.selectionStart)input.selectionStart=0,input.selectionEnd=s;else if(document.selection&&document.selection.createRange){input.select();var i=document.selection.createRange();i.collapse(!0),i.moveEnd("character",s),i.moveStart("character",0),i.select()}},this))},resetOriginalFilename:function(){this.originalFilename="",this.originalExtension=""},validateElementForm:function(){var t=p(".renameHelper",this.elementEditor.hud.$hud.data("elementEditor").$form),e=this._parseFilename(t.val());return e.extension==this.originalExtension||(""==e.extension?this.originalFilename!=e.baseFileName?(t.val(e.baseFileName+"."+this.originalExtension),!0):confirm(Craft.t("Are you sure you want to remove the extension “.{ext}”?",{ext:this.originalExtension})):confirm(Craft.t("Are you sure you want to change the extension from “.{oldExt}” to “.{newExt}”?",{oldExt:this.originalExtension,newExt:e.extension})))}}),Craft.AssetSelectorModal=Craft.BaseElementSelectorModal.extend({$selectTransformBtn:null,_selectedTransform:null,init:function(t,e){e=p.extend({},Craft.AssetSelectorModal.defaults,e),this.base(t,e),e.transforms.length&&this.createSelectTransformButton(e.transforms)},createSelectTransformButton:function(t){if(t&&t.length){var e=p('<div class="btngroup"/>').appendTo(this.$primaryButtons);this.$selectBtn.appendTo(e),this.$selectTransformBtn=p('<div class="btn menubtn disabled">'+Craft.t("Select transform")+"</div>").appendTo(e);for(var s=p('<div class="menu" data-align="right"></div>').insertAfter(this.$selectTransformBtn),i=p("<ul></ul>").appendTo(s),n=0;n<t.length;n++)p('<li><a data-transform="'+t[n].handle+'">'+t[n].name+"</a></li>").appendTo(i);var a=new Garnish.MenuBtn(this.$selectTransformBtn,{onOptionSelect:p.proxy(this,"onSelectTransform")});a.disable(),this.$selectTransformBtn.data("menuButton",a)}},onSelectionChange:function(t){var e=this.elementIndex.getSelectedElements(),s=!1;if(e.length&&this.settings.transforms.length){s=!0;for(var i=0;i<e.length;i++)if(!p(".element.hasthumb:first",e[i]).length){s=!1;break}}var n=null;this.$selectTransformBtn&&(n=this.$selectTransformBtn.data("menuButton")),s?(n&&n.enable(),this.$selectTransformBtn.removeClass("disabled")):this.$selectTransformBtn&&(n&&n.disable(),this.$selectTransformBtn.addClass("disabled")),this.base()},onSelectTransform:function(t){var e=p(t).data("transform");this.selectImagesWithTransform(e)},selectImagesWithTransform:function(t){void 0===Craft.AssetSelectorModal.transformUrls[t]&&(Craft.AssetSelectorModal.transformUrls[t]={});for(var e=this.elementIndex.getSelectedElements(),s=[],i=0;i<e.length;i++){var n=p(e[i]),a=Craft.getElementInfo(n).id;void 0===Craft.AssetSelectorModal.transformUrls[t][a]&&s.push(a)}s.length?(this.showFooterSpinner(),this.fetchMissingTransformUrls(s,t,p.proxy(function(){this.hideFooterSpinner(),this.selectImagesWithTransform(t)},this))):(this._selectedTransform=t,this.selectElements(),this._selectedTransform=null)},fetchMissingTransformUrls:function(s,i,n){var a=s.pop(),t={fileId:a,handle:i,returnUrl:!0};Craft.postActionRequest("assets/generateTransform",t,p.proxy(function(t,e){Craft.AssetSelectorModal.transformUrls[i][a]=!1,"success"==e&&t.url&&(Craft.AssetSelectorModal.transformUrls[i][a]=t.url),s.length?this.fetchMissingTransformUrls(s,i,n):n()},this))},getElementInfo:function(t){var e=this.base(t);if(this._selectedTransform)for(var s=0;s<e.length;s++){var i=e[s].id;void 0!==Craft.AssetSelectorModal.transformUrls[this._selectedTransform][i]&&!1!==Craft.AssetSelectorModal.transformUrls[this._selectedTransform][i]&&(e[s].url=Craft.AssetSelectorModal.transformUrls[this._selectedTransform][i])}return e},onSelect:function(t){this.settings.onSelect(t,this._selectedTransform)}},{defaults:{canSelectImageTransforms:!1,transforms:[]},transformUrls:{}}),Craft.registerElementSelectorModalClass("Asset",Craft.AssetSelectorModal),Craft.AuthManager=Garnish.Base.extend({checkAuthTimeoutTimer:null,showLoginModalTimer:null,decrementLogoutWarningInterval:null,showingLogoutWarningModal:!1,showingLoginModal:!1,logoutWarningModal:null,loginModal:null,$logoutWarningPara:null,$passwordInput:null,$passwordSpinner:null,$loginBtn:null,$loginErrorPara:null,submitLoginIfLoggedOut:!1,init:function(){this.updateAuthTimeout(Craft.authTimeout)},setCheckAuthTimeoutTimer:function(t){this.checkAuthTimeoutTimer&&clearTimeout(this.checkAuthTimeoutTimer),this.checkAuthTimeoutTimer=setTimeout(p.proxy(this,"checkAuthTimeout"),1e3*t)},checkAuthTimeout:function(t){p.ajax({url:Craft.getActionUrl("users/getAuthTimeout",t?null:"dontExtendSession=1"),type:"GET",complete:p.proxy(function(t,e){"success"==e?(void 0!==t.responseJSON.csrfTokenValue&&void 0!==Craft.csrfTokenValue&&(Craft.csrfTokenValue=t.responseJSON.csrfTokenValue),this.updateAuthTimeout(t.responseJSON.timeout),this.submitLoginIfLoggedOut=!1):this.updateAuthTimeout(-1)},this)})},updateAuthTimeout:function(t){this.authTimeout=parseInt(t),-1!=this.authTimeout&&this.authTimeout<Craft.AuthManager.minSafeAuthTimeout?(this.authTimeout?(this.showingLogoutWarningModal||this.showLogoutWarningModal(),this.authTimeout<Craft.AuthManager.checkInterval&&(this.showLoginModalTimer&&clearTimeout(this.showLoginModalTimer),this.showLoginModalTimer=setTimeout(p.proxy(this,"showLoginModal"),1e3*this.authTimeout))):this.showingLoginModal?this.submitLoginIfLoggedOut&&this.submitLogin():this.showLoginModal(),this.setCheckAuthTimeoutTimer(Craft.AuthManager.checkInterval)):(this.hideLogoutWarningModal(),this.hideLoginModal(),-1!=this.authTimeout&&this.authTimeout<Craft.AuthManager.minSafeAuthTimeout+Craft.AuthManager.checkInterval?this.setCheckAuthTimeoutTimer(this.authTimeout-Craft.AuthManager.minSafeAuthTimeout+1):this.setCheckAuthTimeoutTimer(Craft.AuthManager.checkInterval))},showLogoutWarningModal:function(){var t;if(t=!!this.showingLoginModal&&(this.hideLoginModal(!0),!0),this.showingLogoutWarningModal=!0,!this.logoutWarningModal){var e=p('<form id="logoutwarningmodal" class="modal alert fitted"/>'),s=p('<div class="body"/>').appendTo(e),i=p('<div class="buttons right"/>').appendTo(s),n=p('<div class="btn">'+Craft.t("Log out now")+"</div>").appendTo(i),a=p('<input type="submit" class="btn submit" value="'+Craft.t("Keep me logged in")+'" />').appendTo(i);this.$logoutWarningPara=p("<p/>").prependTo(s),this.logoutWarningModal=new Garnish.Modal(e,{autoShow:!1,closeOtherModals:!1,hideOnEsc:!1,hideOnShadeClick:!1,shadeClass:"modal-shade dark",onFadeIn:function(){Garnish.isMobileBrowser(!0)||setTimeout(function(){a.trigger("focus")},100)}}),this.addListener(n,"activate","logout"),this.addListener(e,"submit","renewSession")}t?this.logoutWarningModal.quickShow():this.logoutWarningModal.show(),this.updateLogoutWarningMessage(),this.decrementLogoutWarningInterval=setInterval(p.proxy(this,"decrementLogoutWarning"),1e3)},updateLogoutWarningMessage:function(){this.$logoutWarningPara.text(Craft.t("Your session will expire in {time}.",{time:Craft.secondsToHumanTimeDuration(this.authTimeout)})),this.logoutWarningModal.updateSizeAndPosition()},decrementLogoutWarning:function(){0<this.authTimeout&&(this.authTimeout--,this.updateLogoutWarningMessage()),0==this.authTimeout&&clearInterval(this.decrementLogoutWarningInterval)},hideLogoutWarningModal:function(t){this.showingLogoutWarningModal=!1,this.logoutWarningModal&&(t?this.logoutWarningModal.quickHide():this.logoutWarningModal.hide(),this.decrementLogoutWarningInterval&&clearInterval(this.decrementLogoutWarningInterval))},showLoginModal:function(){var t;if(t=!!this.showingLogoutWarningModal&&(this.hideLogoutWarningModal(!0),!0),this.showingLoginModal=!0,!this.loginModal){var e=p('<form id="loginmodal" class="modal alert fitted"/>'),s=p('<div class="body"><h2>'+Craft.t("Your session has ended.")+"</h2><p>"+Craft.t("Enter your password to log back in.")+"</p></div>").appendTo(e),i=p('<div class="inputcontainer">').appendTo(s),n=p('<table class="inputs fullwidth"/>').appendTo(i),a=p("<tr/>").appendTo(n),r=p("<td/>").appendTo(a),o=p('<td class="thin"/>').appendTo(a),l=p('<div class="passwordwrapper"/>').appendTo(r);this.$passwordInput=p('<input type="password" class="text password fullwidth" placeholder="'+Craft.t("Password")+'"/>').appendTo(l),this.$passwordSpinner=p('<div class="spinner hidden"/>').appendTo(i),this.$loginBtn=p('<input type="submit" class="btn submit disabled" value="'+Craft.t("Login")+'" />').appendTo(o),this.$loginErrorPara=p('<p class="error"/>').appendTo(s),this.loginModal=new Garnish.Modal(e,{autoShow:!1,closeOtherModals:!1,hideOnEsc:!1,hideOnShadeClick:!1,shadeClass:"modal-shade dark",onFadeIn:p.proxy(function(){Garnish.isMobileBrowser(!0)||setTimeout(p.proxy(function(){this.$passwordInput.trigger("focus")},this),100)},this),onFadeOut:p.proxy(function(){this.$passwordInput.val("")},this)}),new Craft.PasswordInput(this.$passwordInput,{onToggleInput:p.proxy(function(t){this.$passwordInput=t},this)}),this.addListener(this.$passwordInput,"textchange","validatePassword"),this.addListener(e,"submit","login")}t?this.loginModal.quickShow():this.loginModal.show()},hideLoginModal:function(t){this.showingLoginModal=!1,this.loginModal&&(t?this.loginModal.quickHide():this.loginModal.hide())},logout:function(){var t=Craft.getActionUrl("users/logout");p.get(t,p.proxy(function(){Craft.redirectTo("")},this))},renewSession:function(t){t&&t.preventDefault(),this.hideLogoutWarningModal(),this.checkAuthTimeout(!0)},validatePassword:function(){return 6<=this.$passwordInput.val().length?(this.$loginBtn.removeClass("disabled"),!0):(this.$loginBtn.addClass("disabled"),!1)},login:function(t){t&&t.preventDefault(),this.validatePassword()&&(this.$passwordSpinner.removeClass("hidden"),this.clearLoginError(),void 0!==Craft.csrfTokenValue?(this.submitLoginIfLoggedOut=!0,this.checkAuthTimeout()):this.submitLogin())},submitLogin:function(){var t={loginName:Craft.username,password:this.$passwordInput.val()};Craft.postActionRequest("users/login",t,p.proxy(function(t,e){this.$passwordSpinner.addClass("hidden"),"success"==e?t.success?(this.hideLoginModal(),this.checkAuthTimeout()):(this.showLoginError(t.error),Garnish.shake(this.loginModal.$container),Garnish.isMobileBrowser(!0)||this.$passwordInput.trigger("focus")):this.showLoginError()},this))},showLoginError:function(t){null==t&&(t=Craft.t("An unknown error occurred.")),this.$loginErrorPara.text(t),this.loginModal.updateSizeAndPosition()},clearLoginError:function(){this.showLoginError("")}},{checkInterval:60,minSafeAuthTimeout:120}),Craft.CategoryIndex=Craft.BaseElementIndex.extend({editableGroups:null,$newCategoryBtnGroup:null,$newCategoryBtn:null,afterInit:function(){this.editableGroups=[];for(var t=0;t<Craft.editableCategoryGroups.length;t++){var e=Craft.editableCategoryGroups[t];this.getSourceByKey("group:"+e.id)&&this.editableGroups.push(e)}this.base()},getDefaultSourceKey:function(){if("index"==this.settings.context&&"undefined"!=typeof defaultGroupHandle)for(var t=0;t<this.$sources.length;t++){var e=p(this.$sources[t]);if(e.data("handle")==defaultGroupHandle)return e.data("key")}return this.base()},onSelectSource:function(){var t=this.$source.data("handle");if(this.editableGroups.length){var e,s;if(this.$newCategoryBtnGroup&&this.$newCategoryBtnGroup.remove(),t)for(var i=0;i<this.editableGroups.length;i++)if(this.editableGroups[i].handle==t){e=this.editableGroups[i];break}if(this.$newCategoryBtnGroup=p('<div class="btngroup submit"/>'),e){var n=this._getGroupTriggerHref(e),a="index"==this.settings.context?Craft.t("New category"):Craft.t("New {group} category",{group:e.name});this.$newCategoryBtn=p('<a class="btn submit add icon" '+n+">"+Craft.escapeHtml(a)+"</a>").appendTo(this.$newCategoryBtnGroup),"index"!=this.settings.context&&this.addListener(this.$newCategoryBtn,"click",function(t){this._openCreateCategoryModal(t.currentTarget.getAttribute("data-id"))}),1<this.editableGroups.length&&(s=p('<div class="btn submit menubtn"></div>').appendTo(this.$newCategoryBtnGroup))}else this.$newCategoryBtn=s=p('<div class="btn submit add icon menubtn">'+Craft.t("New category")+"</div>").appendTo(this.$newCategoryBtnGroup);if(s){var r='<div class="menu"><ul>';for(i=0;i<this.editableGroups.length;i++){var o=this.editableGroups[i];if("index"==this.settings.context||o!=e){n=this._getGroupTriggerHref(o),a="index"==this.settings.context?o.name:Craft.t("New {group} category",{group:o.name});r+="<li><a "+n+'">'+Craft.escapeHtml(a)+"</a></li>"}}p(r+="</ul></div>").appendTo(this.$newCategoryBtnGroup);var l=new Garnish.MenuBtn(s);"index"!=this.settings.context&&l.on("optionSelect",p.proxy(function(t){this._openCreateCategoryModal(t.option.getAttribute("data-id"))},this))}this.addButton(this.$newCategoryBtnGroup)}if("index"==this.settings.context&&"undefined"!=typeof history){var h="categories";t&&(h+="/"+t),history.replaceState({},"",Craft.getUrl(h))}this.base()},_getGroupTriggerHref:function(t){return"index"==this.settings.context?'href="'+Craft.getUrl("categories/"+t.handle+"/new")+'"':'data-id="'+t.id+'"'},_openCreateCategoryModal:function(s){if(!this.$newCategoryBtn.hasClass("loading")){for(var t,e=0;e<this.editableGroups.length;e++)if(this.editableGroups[e].id==s){t=this.editableGroups[e];break}if(t){this.$newCategoryBtn.addClass("inactive");var i=this.$newCategoryBtn.text();this.$newCategoryBtn.text(Craft.t("New {group} category",{group:t.name})),new Craft.ElementEditor({hudTrigger:this.$newCategoryBtnGroup,elementType:"Category",locale:this.locale,attributes:{groupId:s},onBeginLoading:p.proxy(function(){this.$newCategoryBtn.addClass("loading")},this),onEndLoading:p.proxy(function(){this.$newCategoryBtn.removeClass("loading")},this),onHideHud:p.proxy(function(){this.$newCategoryBtn.removeClass("inactive").text(i)},this),onSaveElement:p.proxy(function(t){var e="group:"+s;this.sourceKey!=e&&this.selectSourceByKey(e),this.selectElementAfterUpdate(t.id),this.updateElements()},this)})}}}}),Craft.registerElementIndexClass("Category",Craft.CategoryIndex),Craft.CategorySelectInput=Craft.BaseElementSelectInput.extend({setSettings:function(){this.base.apply(this,arguments),this.settings.sortable=!1},getModalSettings:function(){var t=this.base();return t.hideOnSelect=!1,t},getElements:function(){return this.$elementsContainer.find(".element")},onModalSelect:function(r){this.modal.disable(),this.modal.disableCancelBtn(),this.modal.disableSelectBtn(),this.modal.showFooterSpinner();for(var t=this.getSelectedElementIds(),e=0;e<r.length;e++)t.push(r[e].id);var s={categoryIds:t,locale:r[0].locale,id:this.settings.id,name:this.settings.name,limit:this.settings.limit,selectionLabel:this.settings.selectionLabel};Craft.postActionRequest("elements/getCategoriesInputHtml",s,p.proxy(function(t,e){if(this.modal.enable(),this.modal.enableCancelBtn(),this.modal.enableSelectBtn(),this.modal.hideFooterSpinner(),"success"==e){var s=p(t.html).children(".elements");this.$elementsContainer.replaceWith(s),this.$elementsContainer=s,this.resetElements();for(var i=0;i<r.length;i++){var n=r[i],a=this.getElementById(n.id);a&&this.animateElementIntoPlace(n.$element,a)}this.updateDisabledElementsInModal(),this.modal.hide(),this.onSelectElements()}},this))},removeElement:function(t){var e=t.add(t.parent().siblings("ul").find(".element"));this.removeElements(e);for(var s=0;s<e.length;s++)this._animateCategoryAway(e,s)},_animateCategoryAway:function(s,t){var e;e=t==s.length-1?p.proxy(function(){var t=s.first().parent().parent(),e=t.parent();e[0]==this.$elementsContainer[0]||t.siblings().length?t.remove():e.remove()},this):null;var i=p.proxy(function(){this.animateElementAway(s.eq(t),e)},this);0==t?i():setTimeout(i,100*t)}}),Craft.charts={},Craft.charts.DataTable=Garnish.Base.extend({columns:null,rows:null,init:function(t){columns=t.columns,rows=t.rows,rows.forEach(p.proxy(function(s){p.each(s,function(t,e){switch(columns[t].type){case"date":s[t]=d3.time.format("%Y-%m-%d").parse(s[t]);break;case"datetime":s[t]=d3.time.format("%Y-%m-%d %H:00:00").parse(s[t]);break;case"percent":s[t]=s[t]/100;break;case"number":s[t]=+s[t]}})},this)),this.columns=columns,this.rows=rows}}),Craft.charts.Tip=Garnish.Base.extend({$tip:null,init:function(t,e){this.setSettings(e,Craft.charts.Tip.defaults),this.$container=t,this.$tip=p('<div class="tooltip"></div>').appendTo(this.$container),this.hide()},tipContentFormat:function(t){var e=this.settings.locale;if(this.settings.tipContentFormat)return this.settings.tipContentFormat(e,t);var s=p("<div />"),i=p('<div class="x-value" />').appendTo(s),n=p('<div class="y-value" />').appendTo(s);return i.html(this.settings.xTickFormat(t[0])),n.html(this.settings.yTickFormat(t[1])),s.get(0)},show:function(t){this.$tip.html(this.tipContentFormat(t)),this.$tip.css("display","block");var e=this.settings.getPosition(this.$tip,t);this.$tip.css("left",e.left+"px"),this.$tip.css("top",e.top+"px")},hide:function(){this.$tip.css("display","none")}},{defaults:{locale:null,tipContentFormat:null,getPosition:null}}),Craft.charts.BaseChart=Garnish.Base.extend({$container:null,$chart:null,chartBaseClass:"cp-chart",dataTable:null,locale:null,orientation:null,svg:null,width:null,height:null,x:null,y:null,init:function(t){this.$container=t,d3.select(window).on("resize",p.proxy(function(){this.resize()},this))},initLocale:function(){var t=window.d3_locale;this.settings.localeDefinition&&(t=p.extend(!0,{},t,this.settings.localeDefinition)),this.locale=d3.locale(t)},initChartElement:function(){this.$chart&&this.$chart.remove();var t=this.chartBaseClass;this.settings.chartClass&&(t+=" "+this.settings.chartClass),this.$chart=p('<div class="'+t+'" />').appendTo(this.$container)},draw:function(t,e,s){this.setSettings(e,Craft.charts.BaseChart.defaults),s&&this.setSettings(e,s),this.initLocale(),this.initChartElement(),this.orientation=this.settings.orientation,this.dataTable=t},xTickFormat:function(t){switch(this.settings.dataScale){case"year":return t.timeFormat("%Y");case"month":return t.timeFormat(this.settings.formats.shortDateFormats.month);case"hour":return t.timeFormat(this.settings.formats.shortDateFormats.day+" %H:00:00");default:return t.timeFormat(this.settings.formats.shortDateFormats.day)}},yTickFormat:function(t){switch(this.dataTable.columns[1].type){case"currency":return t.numberFormat(this.settings.formats.currencyFormat);case"percent":return t.numberFormat(this.settings.formats.percentFormat);case"time":return Craft.charts.utils.getDuration;default:return t.numberFormat("n")}},resize:function(){this.draw(this.dataTable,this.settings)},onAfterDrawTicks:function(){p(".tick",this.$chart).each(function(t,e){var s=p("text",e);s.clone().appendTo(e),s.attr("stroke","#ffffff"),s.attr("stroke-width",3)})}},{defaults:{margin:{top:25,right:25,bottom:25,left:25},chartClass:null,colors:["#0594D1","#DE3800","#FF9A00","#009802","#9B009B"],ticksStyles:{fill:"#555","font-size":"11px"}}}),Craft.charts.Area=Craft.charts.BaseChart.extend({tip:null,paddedX:null,paddedY:null,draw:function(t,e){this.base(t,e,Craft.charts.Area.defaults),this.tip&&(this.tip=null),this.width=this.$chart.width()-this.settings.margin.left-this.settings.margin.right,this.height=this.$chart.height()-this.settings.margin.top-this.settings.margin.bottom,this.x=d3.time.scale().range([0,this.width]),this.y=d3.scale.linear().range([this.height,0]),this.x.domain(this.xDomain()),this.y.domain(this.yDomain());var s={width:this.width+(this.settings.margin.left+this.settings.margin.right),height:this.height+(this.settings.margin.top+this.settings.margin.bottom),translateX:"rtl"!=this.orientation?this.settings.margin.left:this.settings.margin.right,translateY:this.settings.margin.top};this.svg=d3.select(this.$chart.get(0)).append("svg").attr("width",s.width).attr("height",s.height).append("g").attr("transform","translate("+s.translateX+","+s.translateY+")"),this.drawGridlines(),this.drawYTicks();var i=this.getChartMargin();this.paddedX=d3.time.scale().range([i.left,this.width-i.right]),this.paddedY=d3.scale.linear().range([this.height,0]),this.paddedX.domain(this.xDomain()),this.paddedY.domain(this.yDomain()),this.drawXTicks(),this.onAfterDrawTicks(),this.drawAxes(),this.drawChart(),this.drawPlots(),this.drawTipTriggers()},getChartMargin:function(){var t,i=0;return p(".y .tick text:last",this.$chart).each(function(t,e){var s=p(e).get(0).getBoundingClientRect().width;i<s&&(i=s)}),t=i+14,{left:"rtl"!=this.orientation?t:0,right:"rtl"!=this.orientation?0:t}},drawChart:function(){var e=this.paddedX,s=this.paddedY,t=d3.svg.line().x(function(t){return e(t[0])}).y(function(t){return s(t[1])});this.svg.append("g").attr("class","chart-line").append("path").datum(this.dataTable.rows).style({fill:"none",stroke:this.settings.colors[0],"stroke-width":"3px"}).attr("d",t);var i=d3.svg.area().x(function(t){return e(t[0])}).y0(this.height).y1(function(t){return s(t[1])});this.svg.append("g").attr("class","chart-area").append("path").datum(this.dataTable.rows).style({fill:this.settings.colors[0],"fill-opacity":"0.3"}).attr("d",i)},drawAxes:function(){var t=d3.time.scale().range([0,this.width]),e=this.y,s=d3.svg.axis().scale(t).orient("bottom").ticks(0).outerTickSize(0),i=this.height;this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+i+")").call(s);var n=this.getChartMargin();if(this.settings.axis.y.show)if("rtl"==this.orientation){var a=this.width-n.right,r=0,o=d3.svg.axis().scale(e).orient("left").ticks(0);this.svg.append("g").attr("class","y axis").attr("transform","translate("+a+", "+r+")").call(o)}else{a=n.left,r=0,o=d3.svg.axis().scale(e).orient("right").ticks(0);this.svg.append("g").attr("class","y axis").attr("transform","translate("+a+", "+r+")").call(o)}},drawYTicks:function(){var t=this.y;if("rtl"==this.orientation){var e=d3.svg.axis().scale(t).orient("left").tickFormat(this.yTickFormat(this.locale)).tickValues(this.yTickValues()).ticks(this.yTicks()),s=this.width+10,i=0;this.svg.append("g").attr("class","y ticks-axis").attr("transform","translate("+s+",0)").style(this.settings.ticksStyles).call(e),this.svg.selectAll(".y.ticks-axis text").style({"text-anchor":"start"})}else{e=d3.svg.axis().scale(t).orient("right").tickFormat(this.yTickFormat(this.locale)).tickValues(this.yTickValues()).ticks(this.yTicks()),s=-10,i=0;this.svg.append("g").attr("class","y ticks-axis").attr("transform","translate("+s+", "+i+")").style(this.settings.ticksStyles).call(e)}},drawXTicks:function(){var t=this.paddedX,e=d3.svg.axis().scale(t).orient("bottom").tickFormat(this.xTickFormat(this.locale)).ticks(this.xTicks());this.svg.append("g").attr("class","x ticks-axis").attr("transform","translate(0,"+this.height+")").style(this.settings.ticksStyles).call(e)},drawGridlines:function(){var t=this.x,e=this.y;if(this.settings.xAxisGridlines){var s=d3.svg.axis().scale(t).orient("bottom");this.svg.append("g").attr("class","x grid-line").attr("transform","translate(0,"+this.height+")").call(s.tickSize(-this.height,0,0).tickFormat(""))}if(this.settings.yAxisGridlines){var i=d3.svg.axis().scale(e).orient("left"),n=-this.width;this.svg.append("g").attr("class","y grid-line").attr("transform","translate(-0 , 0)").call(i.tickSize(n,0).tickFormat("").tickValues(this.yTickValues()).ticks(this.yTicks()))}},drawPlots:function(){var e=this.paddedX,s=this.paddedY;this.settings.enablePlots&&this.svg.append("g").attr("class","plots").selectAll("circle").data(this.dataTable.rows).enter().append("circle").style({fill:this.settings.colors[0]}).attr("class",p.proxy(function(t,e){return"plot plot-"+e},this)).attr("r",4).attr("cx",p.proxy(function(t){return e(t[0])},this)).attr("cy",p.proxy(function(t){return s(t[1])},this))},expandPlot:function(t){this.svg.select(".plot-"+t).attr("r",5)},unexpandPlot:function(t){this.svg.select(".plot-"+t).attr("r",4)},getTipTriggerWidth:function(){return Math.max(0,this.xAxisTickInterval())},xAxisTickInterval:function(){var t=this.getChartMargin();return(this.svg.select(".x path.domain").node().getTotalLength()-t.left-t.right-12)/(this.dataTable.rows.length-1)},drawTipTriggers:function(){var e=this.paddedX;if(this.settings.enableTips){var t={chart:this,locale:this.locale,xTickFormat:this.xTickFormat(this.locale),yTickFormat:this.yTickFormat(this.locale),tipContentFormat:p.proxy(this,"tipContentFormat"),getPosition:p.proxy(this,"getTipPosition")};this.tip?this.tip.setSettings(t):this.tip=new Craft.charts.Tip(this.$chart,t),this.svg.append("g").attr("class","tip-triggers").selectAll("rect").data(this.dataTable.rows).enter().append("rect").attr("class","tip-trigger").style({fill:"transparent","fill-opacity":"1"}).attr("width",this.getTipTriggerWidth()).attr("height",this.height).attr("x",p.proxy(function(t){return e(t[0])-this.getTipTriggerWidth()/2},this)).on("mouseover",p.proxy(function(t,e){this.expandPlot(e),this.tip.show(t)},this)).on("mouseout",p.proxy(function(t,e){this.unexpandPlot(e),this.tip.hide()},this))}Craft.charts.utils.applyShadowFilter("drop-shadow",this.svg)},getTipPosition:function(t,e){var s,i=this.paddedX,n=this.paddedY,a=(this.getChartMargin(),n(e[1])-t.height()/2);if("rtl"!=this.orientation){s=i(e[0])+this.settings.margin.left+24;var r=this.$chart.offset().left+s+t.width();this.$chart.offset().left+this.$chart.width()-24<r&&(s=i(e[0])-(t.width()+24))}else s=i(e[0])-(t.width()+this.settings.margin.left+24);return s<0&&(s=i(e[0])+this.settings.margin.left+24),{top:a,left:s}},xDomain:function(){var t=d3.min(this.dataTable.rows,function(t){return t[0]}),e=d3.max(this.dataTable.rows,function(t){return t[0]});return"rtl"==this.orientation?[e,t]:[t,e]},xTicks:function(){return 3},yAxisMaxValue:function(){return d3.max(this.dataTable.rows,function(t){return t[1]})},yDomain:function(){return[0,p.proxy(function(){return this.yAxisMaxValue()},this)()]},yTicks:function(){return 2},yTickValues:function(){return[this.yAxisMaxValue()/2,this.yAxisMaxValue()]}},{defaults:{chartClass:"area",enablePlots:!0,enableTips:!0,xAxisGridlines:!1,yAxisGridlines:!0,axis:{y:{show:!1}}}}),Craft.charts.utils={getDuration:function(t){var e=parseInt(t,10),s=Math.floor(e/3600),i=Math.floor((e-3600*s)/60),n=e-3600*s-60*i;return s<10&&(s="0"+s),i<10&&(i="0"+i),n<10&&(n="0"+n),s+":"+i+":"+n},arrayToDataTable:function(a){var r={columns:[],rows:[]};return p.each(a,function(i,t){if(0==i)r.columns=[],p.each(t,function(t,e){var s={name:e,type:typeof a[i+1][t]};r.columns.push(s)});else{var n=[];p.each(t,function(t,e){var s=e;n.push(s)}),r.rows.push(n)}}),new Craft.charts.DataTable(r)},applyShadowFilter:function(t,e){var s=e.append("defs").append("filter").attr("id",t).attr("width","200%").attr("height","200%").attr("x","-50%").attr("y","-50%");s.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",1).attr("result","blur"),s.append("feOffset").attr("in","blur").attr("dx",0).attr("dy",0).attr("result","offsetBlur");var i=s.append("feMerge");i.append("feMergeNode").attr("in","offsetBlur"),i.append("feMergeNode").attr("in","SourceGraphic")}},Craft.CustomizeSourcesModal=Garnish.Modal.extend({elementIndex:null,$elementIndexSourcesContainer:null,$sidebar:null,$sourcesContainer:null,$sourceSettingsContainer:null,$newHeadingBtn:null,$footer:null,$footerBtnContainer:null,$saveBtn:null,$cancelBtn:null,$saveSpinner:null,$loadingSpinner:null,sourceSort:null,sources:null,selectedSource:null,updateSourcesOnSave:!1,availableTableAttributes:null,init:function(t,e){this.base(),this.setSettings(e,{resizable:!0}),this.elementIndex=t,this.$elementIndexSourcesContainer=this.elementIndex.$sidebar.children("nav").children("ul");var s=p('<form class="modal customize-sources-modal"/>').appendTo(Garnish.$bod);this.$sidebar=p('<div class="cs-sidebar block-types"/>').appendTo(s),this.$sourcesContainer=p('<div class="sources">').appendTo(this.$sidebar),this.$sourceSettingsContainer=p('<div class="source-settings">').appendTo(s),this.$footer=p('<div class="footer"/>').appendTo(s),this.$footerBtnContainer=p('<div class="buttons right"/>').appendTo(this.$footer),this.$cancelBtn=p('<div class="btn" role="button"/>').text(Craft.t("Cancel")).appendTo(this.$footerBtnContainer),this.$saveBtn=p('<div class="btn submit disabled" role="button"/>').text(Craft.t("Save")).appendTo(this.$footerBtnContainer),this.$saveSpinner=p('<div class="spinner hidden"/>').appendTo(this.$footerBtnContainer),this.$newHeadingBtn=p('<div class="btn submit add icon"/>').text(Craft.t("New heading")).appendTo(p('<div class="buttons left secondary-buttons"/>').appendTo(this.$footer)),this.$loadingSpinner=p('<div class="spinner"/>').appendTo(s),this.setContainer(s),this.show();var i={elementType:this.elementIndex.elementType};Craft.postActionRequest("elementIndexSettings/getCustomizeSourcesModalData",i,p.proxy(function(t,e){this.$loadingSpinner.remove(),"success"==e&&(this.$saveBtn.removeClass("disabled"),this.buildModal(t))},this)),this.addListener(this.$newHeadingBtn,"click","handleNewHeadingBtnClick"),this.addListener(this.$cancelBtn,"click","hide"),this.addListener(this.$saveBtn,"click","save"),this.addListener(this.$container,"submit","save")},buildModal:function(t){this.availableTableAttributes=t.availableTableAttributes,this.sourceSort=new Garnish.DragSort({handle:".move",axis:"y",onSortChange:p.proxy(function(){this.updateSourcesOnSave=!0},this)}),this.sources=[];for(var e=0;e<t.sources.length;e++){var s=this.addSource(t.sources[e]);this.sources.push(s)}this.selectedSource||void 0===this.sources[0]||this.sources[0].select()},addSource:function(t){var e,s=p('<div class="customize-sources-item"/>').appendTo(this.$sourcesContainer),i=p('<div class="label"/>').appendTo(s),n=p('<input type="hidden"/>').appendTo(s);p('<a class="move icon" title="'+Craft.t("Reorder")+'" role="button"></a>').appendTo(s);return void 0!==t.heading?(s.addClass("heading"),n.attr("name","sourceOrder[][heading]"),(e=new Craft.CustomizeSourcesModal.Heading(this,s,i,n,t)).updateItemLabel(t.heading)):(n.attr("name","sourceOrder[][key]").val(t.key),(e=new Craft.CustomizeSourcesModal.Source(this,s,i,n,t)).updateItemLabel(t.label),t.key==this.elementIndex.sourceKey&&e.select()),this.sourceSort.addItems(s),e},handleNewHeadingBtnClick:function(){var t=this.addSource({heading:""});Garnish.scrollContainerToElement(this.$sidebar,t.$item),t.select(),this.updateSourcesOnSave=!0},save:function(t){if(t&&t.preventDefault(),!this.$saveBtn.hasClass("disabled")&&this.$saveSpinner.hasClass("hidden")){this.$saveSpinner.removeClass("hidden");var e=this.$container.serialize()+"&elementType="+this.elementIndex.elementType;Craft.postActionRequest("elementIndexSettings/saveCustomizeSourcesModalSettings",e,p.proxy(function(t,e){if(this.$saveSpinner.addClass("hidden"),"success"==e&&t.success){if(this.updateSourcesOnSave&&this.$elementIndexSourcesContainer.length){for(var s,i,n=0;n<this.sourceSort.$items.length;n++){var a=this.sourceSort.$items.eq(n).data("source"),r=a.getIndexSource();r&&(a.isHeading()?i=r:(i&&(this.appendSource(i,s),s=i,i=null),this.appendSource(r,s),s=r))}if(s){var o=s.nextAll();this.elementIndex.sourceSelect.removeItems(o),o.remove()}}this.selectedSource&&this.selectedSource.sourceData.key&&(this.elementIndex.selectSourceByKey(this.selectedSource.sourceData.key),this.elementIndex.updateElements()),Craft.cp.displayNotice(Craft.t("Source settings saved")),this.hide()}else{var l="success"==e&&t.error?t.error:Craft.t("An unknown error occurred.");Craft.cp.displayError(l)}},this))}},appendSource:function(t,e){e?t.insertAfter(e):t.prependTo(this.$elementIndexSourcesContainer)},destroy:function(){for(var t=0;t<this.sources.length;t++)this.sources[t].destroy();delete this.sources,this.base()}}),Craft.CustomizeSourcesModal.BaseSource=Garnish.Base.extend({modal:null,$item:null,$itemLabel:null,$itemInput:null,$settingsContainer:null,sourceData:null,init:function(t,e,s,i,n){this.modal=t,this.$item=e,this.$itemLabel=s,this.$itemInput=i,this.sourceData=n,this.$item.data("source",this),this.addListener(this.$item,"click","select")},isHeading:function(){return!1},isSelected:function(){return this.modal.selectedSource==this},select:function(){this.isSelected()||(this.modal.selectedSource&&this.modal.selectedSource.deselect(),this.$item.addClass("sel"),(this.modal.selectedSource=this).$settingsContainer?this.$settingsContainer.removeClass("hidden"):this.$settingsContainer=p("<div/>").append(this.createSettings()).appendTo(this.modal.$sourceSettingsContainer),this.modal.$sourceSettingsContainer.scrollTop(0))},createSettings:function(){},getIndexSource:function(){},deselect:function(){this.$item.removeClass("sel"),this.modal.selectedSource=null,this.$settingsContainer.addClass("hidden")},updateItemLabel:function(t){this.$itemLabel.text(t)},destroy:function(){this.$item.data("source",null),this.base()}}),Craft.CustomizeSourcesModal.Source=Craft.CustomizeSourcesModal.BaseSource.extend({createSettings:function(){if(this.sourceData.tableAttributes.length){var t=this.sourceData.tableAttributes[0],e=t[0],s=t[1],i=this.createTableColumnOption(e,s,!0,!0),n=p("<div/>"),a=[e];p('<input type="hidden" name="sources['+this.sourceData.key+'][tableAttributes][]" value=""/>').appendTo(n);for(var r=1;r<this.sourceData.tableAttributes.length;r++){var o=(h=this.sourceData.tableAttributes[r])[0],l=h[1];n.append(this.createTableColumnOption(o,l,!1,!0)),a.push(o)}for(r=0;r<this.modal.availableTableAttributes.length;r++){var h;o=(h=this.modal.availableTableAttributes[r])[0],l=h[1];Craft.inArray(o,a)||n.append(this.createTableColumnOption(o,l,!1,!1))}return new Garnish.DragSort(n.children(),{handle:".move",axis:"y"}),Craft.ui.createField(p([i[0],n[0]]),{label:Craft.t("Table Columns"),instructions:Craft.t("Choose which table columns should be visible for this source, and in which order.")})}},createTableColumnOption:function(t,e,s,i){return $option=p('<div class="customize-sources-table-column"/>').append('<div class="icon move"/>').append(Craft.ui.createCheckbox({label:e,name:"sources["+this.sourceData.key+"][tableAttributes][]",value:t,checked:i,disabled:s})),s&&$option.children(".move").addClass("disabled"),$option},getIndexSource:function(){var t=this.modal.elementIndex.getSourceByKey(this.sourceData.key);if(t)return t.closest("li")}}),Craft.CustomizeSourcesModal.Heading=Craft.CustomizeSourcesModal.BaseSource.extend({$labelField:null,$labelInput:null,$deleteBtn:null,isHeading:function(){return!0},select:function(){this.base(),this.$labelInput.trigger("focus")},createSettings:function(){return this.$labelField=Craft.ui.createTextField({label:Craft.t("Heading"),instructions:Craft.t("This can be left blank if you just want an unlabeled separator."),value:this.sourceData.heading}),this.$labelInput=this.$labelField.find(".text"),this.$deleteBtn=p('<a class="error delete"/>').text(Craft.t("Delete heading")),this.addListener(this.$labelInput,"textchange","handleLabelInputChange"),this.addListener(this.$deleteBtn,"click","deleteHeading"),p([this.$labelField[0],p("<hr/>")[0],this.$deleteBtn[0]])},handleLabelInputChange:function(){this.updateItemLabel(this.$labelInput.val()),this.modal.updateSourcesOnSave=!0},updateItemLabel:function(t){this.$itemLabel.html((t?Craft.escapeHtml(t):'<em class="light">'+Craft.t("(blank)")+"</em>")+"&nbsp;"),this.$itemInput.val(t)},deleteHeading:function(){this.modal.sourceSort.removeItems(this.$item),this.modal.sources.splice(p.inArray(this,this.modal.sources),1),this.modal.updateSourcesOnSave=!0,this.isSelected()&&(this.deselect(),this.modal.sources.length&&this.modal.sources[0].select()),this.$item.remove(),this.$settingsContainer.remove(),this.destroy()},getIndexSource:function(){var t=this.$labelInput?this.$labelInput.val():this.sourceData.heading;return p('<li class="heading"/>').append(p("<span/>").text(t))}}),Craft.DataTableSorter=Garnish.DragSort.extend({$table:null,init:function(t,e){this.$table=p(t);var s=this.$table.children("tbody").children(":not(.filler)");(e=p.extend({},Craft.DataTableSorter.defaults,e)).container=this.$table.children("tbody"),e.helper=p.proxy(this,"getHelper"),e.caboose="<tr/>",e.axis=Garnish.Y_AXIS,e.magnetStrength=4,e.helperLagBase=1.5,this.base(s,e)},getHelper:function(t){var e=p('<div class="'+this.settings.helperClass+'"/>').appendTo(Garnish.$bod),s=p("<table/>").appendTo(e),i=p("<tbody/>").appendTo(s);t.appendTo(i),s.width(this.$table.width()),s.prop("className",this.$table.prop("className"));for(var n=this.$table.find("tr:first").children(),a=t.children(),r=0;r<a.length;r++)p(a[r]).width(p(n[r]).width());return e}},{defaults:{handle:".move",helperClass:"datatablesorthelper"}}),Craft.DateRangePicker=Garnish.Base.extend({hud:null,value:null,presets:null,startDate:null,$startDateInput:null,$endDateInput:null,init:function(t,e){this.$trigger=t,this.setSettings(e,Craft.DateRangePicker.defaults),this.settings.customRangeStartDate&&(this.customRangeStartDate=new Date(this.settings.customRangeStartDate)),this.settings.customRangeEndDate&&(this.customRangeEndDate=new Date(this.settings.customRangeEndDate)),this.value=this.settings.value,this.presets=this.settings.presets,"customrange"==this.value?(this.startDate=this.customRangeStartDate,this.endDate=this.customRangeEndDate):(this.startDate=this.presets[this.value].startDate,this.endDate=this.presets[this.value].endDate);var s=this.presets[this.value].label;this.$trigger.data("value",s),this.addListener(this.$trigger,"click","showHud")},getStartDate:function(){return this.startDate},getEndDate:function(){return this.endDate},showHud:function(){if(this.$trigger.addClass("active"),this.hud)this.hud.show();else if(this.createHud(),this.value){var t=this.$items.filter("[data-value="+this.value+"]"),e=(t.data("value"),t.data("label"));"undefined"!=t.data("start-date")&&t.data("start-date"),"undefined"!=t.data("end-date")&&t.data("end-date");t.addClass("sel"),this.$trigger.data("value",e)}},createHud:function(){this.$hudBody=p("<div></div>"),this.createPresets(),p("<hr />").appendTo(this.$hudBody),this.createCustomRangeFields(),this.$items=p("a.item",this.$hudBody),this.addListener(this.$items,"click","selectItem"),this.hud=new Garnish.HUD(this.$trigger,this.$hudBody,{hudClass:"hud daterange-hud",onSubmit:p.proxy(this,"save"),onShow:p.proxy(function(){this.$trigger.addClass("active")},this),onHide:p.proxy(function(){this.$trigger.removeClass("active")},this)})},createPresets:function(){var t=p('<div class="daterange-items" />').appendTo(this.$hudBody),s=p("<ul />").appendTo(t);p.each(this.presets,function(t,e){"customrange"!=t&&p('<li><a class="item" data-value="'+t+'" data-label="'+e.label+'" data-start-date="'+e.startDate+'" data-end-date="'+e.endDate+'">'+e.label+"</a></li>").appendTo(s)})},createCustomRangeFields:function(){var t=p('<div class="daterange-items" />').appendTo(this.$hudBody),e=p("<ul />").appendTo(t),s=p("<li />").appendTo(e),i=(p('<a class="item" data-value="customrange" data-label="'+this.presets.customrange.label+'">'+this.presets.customrange.label+"</a>").appendTo(s),p('<div class="daterange-fields"></div>').appendTo(t)),n=p('<div class="datewrapper"></div>').appendTo(i),a=p('<div class="datewrapper"></div>').appendTo(i);if(!this.customRangeStartDate){var r=new Date;r=r.getTime()-6048e5,this.customRangeStartDate=new Date(r)}this.$startDateInput=p('<input type="text" value="'+Craft.formatDate(this.customRangeStartDate)+'" class="text" size="20" autocomplete="off" value="" />').appendTo(n),this.$startDateInput.datepicker(p.extend({onClose:p.proxy(function(t,e){this.$items.removeClass("sel"),p("[data-value=customrange]").addClass("sel");var s=new Date(e.currentYear,e.currentMonth,e.currentDay);if((this.customRangeStartDate=s).getTime()>this.customRangeEndDate.getTime()){var i=s.getTime()+6048e5;i=new Date(i),this.customRangeEndDate=i,this.$endDateInput.val(Craft.formatDate(this.customRangeEndDate))}this.showCustomRangeApplyButton()},this)},Craft.datepickerOptions)),this.customRangeEndDate||(this.customRangeEndDate=new Date),this.$endDateInput=p('<input type="text" value="'+Craft.formatDate(this.customRangeEndDate)+'" class="text" size="20" autocomplete="off" value="" />').appendTo(a),this.$endDateInput.datepicker(p.extend({onClose:p.proxy(function(t,e){this.$items.removeClass("sel"),p("[data-value=customrange]").addClass("sel");var s=new Date(e.currentYear,e.currentMonth,e.currentDay);if((this.customRangeEndDate=s).getTime()<this.customRangeStartDate.getTime()){var i=s.getTime()-6048e5;i=new Date(i),this.customRangeStartDate=i,this.$startDateInput.val(Craft.formatDate(this.customRangeStartDate))}this.showCustomRangeApplyButton()},this)},Craft.datepickerOptions))},selectItem:function(t){var e=p(t.currentTarget);this._selectItem(e)},_selectItem:function(t){this.$items.removeClass("sel");var e=t.data("label"),s=t.data("value");this.endDate="customrange"!=s?(this.startDate=t.data("start-date"),t.data("end-date")):(this.startDate=this.customRangeStartDate,this.customRangeEndDate),this.startDate="undefined"!=this.startDate?this.startDate:null,this.endDate="undefined"!=this.endDate?this.endDate:null,t.addClass("sel"),this.$trigger.data("value",e),this.hud.hide(),this.hideCustomRangeApplyButton(),this.onAfterSelect(s,this.startDate,this.endDate,this.customRangeStartDate,this.customRangeEndDate)},hideCustomRangeApplyButton:function(){this.$applyBtn&&this.$applyBtn.parent().addClass("hidden")},showCustomRangeApplyButton:function(){if(this.$applyBtn)this.$applyBtn.parent().removeClass("hidden");else{var t=p('<div class="buttons" />').appendTo(this.$hudBody);this.$applyBtn=p('<input type="button" class="btn" value="'+Craft.t("Apply")+'" />').appendTo(t),this.addListener(this.$applyBtn,"click","applyCustomRange")}},applyCustomRange:function(){var t=this.$items.filter("[data-value=customrange]");this._selectItem(t)},onAfterSelect:function(t,e,s,i,n){this.settings.onAfterSelect(t,e,s,i,n)}},{defaults:{value:null,presets:{d7:{label:Craft.t("Last 7 days"),startDate:"-7 days"},d30:{label:Craft.t("Last 30 days"),startDate:"-30 days"},lastweek:{label:Craft.t("Last Week"),startDate:"-14 days",endDate:"-7 days"},lastmonth:{label:Craft.t("Last Month"),startDate:"-60 days",endDate:"-30 days"},customrange:{label:Craft.t("Custom Range")}},customRangeStartDate:null,customRangeEndDate:null,onAfterSelect:p.noop}}),Craft.DeleteUserModal=Garnish.Modal.extend({id:null,userId:null,$deleteActionRadios:null,$deleteSpinner:null,userSelect:null,_deleting:!1,init:function(t,e){this.id=Math.floor(1e9*Math.random()),this.userId=t,e=p.extend(Craft.DeleteUserModal.defaults,e);var s,i=p('<form class="modal fitted deleteusermodal" method="post" accept-charset="UTF-8">'+Craft.getCsrfInput()+'<input type="hidden" name="action" value="users/deleteUser"/>'+(Garnish.isArray(this.userId)?"":'<input type="hidden" name="userId" value="'+this.userId+'"/>')+'<input type="hidden" name="redirect" value="'+(Craft.edition==Craft.Pro?"users":"dashboard")+'"/></form>').appendTo(Garnish.$bod),n=p('<div class="body"><p>'+Craft.t("What do you want to do with their content?")+'</p><div class="options"><label><input type="radio" name="contentAction" value="transfer"/> '+Craft.t("Transfer it to:")+'</label><div id="transferselect'+this.id+'" class="elementselect"><div class="elements"></div><div class="btn add icon dashed">'+Craft.t("Choose a user")+'</div></div></div><div><label><input type="radio" name="contentAction" value="delete"/> '+Craft.t("Delete it")+"</label></div></div>").appendTo(i),a=p('<div class="buttons right"/>').appendTo(n),r=p('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(a);if(this.$deleteActionRadios=n.find("input[type=radio]"),this.$deleteSubmitBtn=p('<input type="submit" class="btn submit disabled" value="'+(Garnish.isArray(this.userId)?Craft.t("Delete users"):Craft.t("Delete user"))+'" />').appendTo(a),this.$deleteSpinner=p('<div class="spinner hidden"/>').appendTo(a),Garnish.isArray(this.userId)){s=["and"];for(var o=0;o<this.userId.length;o++)s.push("not "+this.userId[o])}else s="not "+this.userId;this.userSelect=new Craft.BaseElementSelectInput({id:"transferselect"+this.id,name:"transferContentTo",elementType:"User",criteria:{id:s},limit:1,modalSettings:{closeOtherModals:!1},onSelectElements:p.proxy(function(){this.updateSizeAndPosition(),this.$deleteActionRadios.first().prop("checked")?this.validateDeleteInputs():this.$deleteActionRadios.first().trigger("click")},this),onRemoveElements:p.proxy(this,"validateDeleteInputs"),selectable:!1,editable:!1}),this.addListener(r,"click","hide"),this.addListener(this.$deleteActionRadios,"change","validateDeleteInputs"),this.addListener(i,"submit","handleSubmit"),this.base(i,e)},validateDeleteInputs:function(){var t=!1;return this.$deleteActionRadios.eq(0).prop("checked")?t=!!this.userSelect.totalSelected:this.$deleteActionRadios.eq(1).prop("checked")&&(t=!0),t?this.$deleteSubmitBtn.removeClass("disabled"):this.$deleteSubmitBtn.addClass("disabled"),t},handleSubmit:function(t){!this._deleting&&this.validateDeleteInputs()?(this.$deleteSubmitBtn.addClass("active"),this.$deleteSpinner.removeClass("hidden"),this.disable(),this.userSelect.disable(),!(this._deleting=!0)===this.settings.onSubmit()&&t.preventDefault()):t.preventDefault()},onFadeIn:function(){Garnish.isMobileBrowser(!0)||this.$deleteActionRadios.first().trigger("focus"),this.base()}},{defaults:{onSubmit:p.noop}}),Craft.EditableTable=Garnish.Base.extend({initialized:!1,id:null,baseName:null,columns:null,sorter:null,biggestId:-1,$table:null,$tbody:null,$addRowBtn:null,init:function(t,e,s,i){this.id=t,this.baseName=e,this.columns=s,this.setSettings(i,Craft.EditableTable.defaults),this.$table=p("#"+t),this.$tbody=this.$table.children("tbody"),this.sorter=new Craft.DataTableSorter(this.$table,{helperClass:"editabletablesorthelper",copyDraggeeInputValuesToHelper:!0}),this.isVisible()?this.initialize():setTimeout(p.proxy(this,"initializeIfVisible"),500)},isVisible:function(){return 0<this.$table.height()},initialize:function(){if(!this.initialized){this.initialized=!0,this.removeListener(Garnish.$win,"resize");for(var t=this.$tbody.children(),e=0;e<t.length;e++)new Craft.EditableTable.Row(this,t[e]);this.$addRowBtn=this.$table.next(".add"),this.addListener(this.$addRowBtn,"activate","addRow")}},initializeIfVisible:function(){this.removeListener(Garnish.$win,"resize"),this.isVisible()?this.initialize():this.addListener(Garnish.$win,"resize","initializeIfVisible")},addRow:function(){var t=this.settings.rowIdPrefix+(this.biggestId+1),e=this.getRowHtml(t,this.columns,this.baseName,{}),s=p(e).appendTo(this.$tbody);new Craft.EditableTable.Row(this,s),this.sorter.addItems(s),s.find("input,textarea,select").first().trigger("focus"),this.settings.onAddRow(s)},getRowHtml:function(t,e,s,i){return Craft.EditableTable.getRowHtml(t,e,s,i)}},{textualColTypes:["singleline","multiline","number"],defaults:{rowIdPrefix:"",onAddRow:p.noop,onDeleteRow:p.noop},getRowHtml:function(t,e,s,i){var n='<tr data-id="'+t+'">';for(var a in e){var r=e[a],o=s+"["+t+"]["+a+"]",l=void 0!==i[a]?i[a]:"";switch(n+='<td class="'+(Craft.inArray(r.type,Craft.EditableTable.textualColTypes)?"textual":"")+" "+(void 0!==r.class?r.class:"")+'"'+(void 0!==r.width?' width="'+r.width+'"':"")+">",r.type){case"select":n+='<div class="select small"><select name="'+o+'">';var h=!1;for(var d in r.options){var c=r.options[d];if(void 0!==c.optgroup)h?n+="</optgroup>":h=!0,n+='<optgroup label="'+c.optgroup+'">';else{var u=void 0!==c.label?c.label:c,g=void 0!==c.value?c.value:d;n+='<option value="'+g+'"'+(g==l?" selected":"")+(void 0!==c.disabled&&c.disabled?" disabled":"")+">"+u+"</option>"}}h&&(n+="</optgroup>"),n+="</select></div>";break;case"checkbox":n+='<input type="hidden" name="'+o+'"><input type="checkbox" name="'+o+'" value="1"'+(l?" checked":"")+">";break;default:n+='<textarea name="'+o+'" rows="1">'+l+"</textarea>"}n+="</td>"}return n+='<td class="thin action"><a class="move icon" title="'+Craft.t("Reorder")+'"></a></td><td class="thin action"><a class="delete icon" title="'+Craft.t("Delete")+'"></a></td></tr>'}}),Craft.EditableTable.Row=Garnish.Base.extend({table:null,id:null,niceTexts:null,$tr:null,$tds:null,$textareas:null,$deleteBtn:null,init:function(t,e){this.table=t,this.$tr=p(e),this.$tds=this.$tr.children();var s=parseInt(this.$tr.attr("data-id").substr(this.table.settings.rowIdPrefix.length));s>this.table.biggestId&&(this.table.biggestId=s),this.$textareas=p(),this.niceTexts=[];var i={},n=0;for(var a in this.table.columns){var r=this.table.columns[a];Craft.inArray(r.type,Craft.EditableTable.textualColTypes)&&($textarea=p("textarea",this.$tds[n]),this.$textareas=this.$textareas.add($textarea),this.addListener($textarea,"focus","onTextareaFocus"),this.addListener($textarea,"mousedown","ignoreNextTextareaFocus"),this.niceTexts.push(new Garnish.NiceText($textarea,{onHeightChange:p.proxy(this,"onTextareaHeightChange")})),"singleline"!=r.type&&"number"!=r.type||(this.addListener($textarea,"keypress",{type:r.type},"validateKeypress"),this.addListener($textarea,"textchange",{type:r.type},"validateValue")),i[a]=$textarea),n++}for(var a in this.onTextareaHeightChange(),this.table.columns){(r=this.table.columns[a]).autopopulate&&void 0!==i[r.autopopulate]&&!i[a].val()&&new Craft.HandleGenerator(i[a],i[r.autopopulate])}var o=this.$tr.children().last().find(".delete");this.addListener(o,"click","deleteRow")},onTextareaFocus:function(t){this.onTextareaHeightChange();var s=p(t.currentTarget);s.data("ignoreNextFocus")?s.data("ignoreNextFocus",!1):setTimeout(function(){var t=s.val();if(void 0!==s[0].setSelectionRange){var e=2*t.length;s[0].setSelectionRange(0,e)}else s.val(t)},0)},ignoreNextTextareaFocus:function(t){p.data(t.currentTarget,"ignoreNextFocus",!0)},validateKeypress:function(t){var e=t.keyCode?t.keyCode:t.charCode;Garnish.isCtrlKeyPressed(t)||e!=Garnish.RETURN_KEY&&("number"!=t.data.type||Craft.inArray(e,Craft.EditableTable.Row.numericKeyCodes))||t.preventDefault()},validateValue:function(t){var e;if("number"==t.data.type){var s=t.currentTarget.value.match(/^\s*(-?[\d\.]*)/);e=null!==s?s[1]:""}else e=t.currentTarget.value.replace(/[\r\n]/g,"");e!==t.currentTarget.value&&(t.currentTarget.value=e)},onTextareaHeightChange:function(){for(var t=-1,e=0;e<this.niceTexts.length;e++)this.niceTexts[e].height>t&&(t=this.niceTexts[e].height);this.$textareas.css("min-height",t);var s=this.$textareas.first().parent().height();t<s&&this.$textareas.css("min-height",s)},deleteRow:function(){this.table.sorter.removeItems(this.$tr),this.$tr.remove(),this.table.settings.onDeleteRow(this.$tr)}},{numericKeyCodes:[9,8,37,38,39,40,45,91,46,190,48,49,50,51,52,53,54,55,56,57]}),Craft.ElementActionTrigger=Garnish.Base.extend({maxLevels:null,newChildUrl:null,$trigger:null,$selectedItems:null,triggerEnabled:!0,init:function(t){this.setSettings(t,Craft.ElementActionTrigger.defaults),this.$trigger=p("#"+t.handle+"-actiontrigger"),this.settings.activate&&(this.$trigger.data("custom-handler",!0),"FORM"==this.$trigger.prop("nodeName")?this.addListener(this.$trigger,"submit","handleTriggerActivation"):this.addListener(this.$trigger,"click","handleTriggerActivation")),this.updateTrigger(),Craft.elementIndex.on("selectionChange",p.proxy(this,"updateTrigger"))},updateTrigger:function(){0!=Craft.elementIndex.getSelectedElements().length&&(this.validateSelection()?this.enableTrigger():this.disableTrigger())},validateSelection:function(){var t=!0;return this.$selectedItems=Craft.elementIndex.getSelectedElements(),!this.settings.batch&&1<this.$selectedItems.length?t=!1:"function"==typeof this.settings.validateSelection&&(t=this.settings.validateSelection(this.$selectedItems)),t},enableTrigger:function(){this.triggerEnabled||(this.$trigger.removeClass("disabled"),this.triggerEnabled=!0)},disableTrigger:function(){this.triggerEnabled&&(this.$trigger.addClass("disabled"),this.triggerEnabled=!1)},handleTriggerActivation:function(t){t.preventDefault(),t.stopPropagation(),this.triggerEnabled&&this.settings.activate(this.$selectedItems)}},{defaults:{handle:null,batch:!0,validateSelection:null,activate:null}}),Craft.ElementEditor=Garnish.Base.extend({$element:null,elementId:null,locale:null,$form:null,$fieldsContainer:null,$cancelBtn:null,$saveBtn:null,$spinner:null,$localeSelect:null,$localeSpinner:null,hud:null,init:function(t,e){void 0===e&&p.isPlainObject(t)&&(e=t,t=null),this.$element=t,this.setSettings(e,Craft.ElementEditor.defaults),this.loadHud()},setElementAttribute:function(t,e){this.settings.attributes||(this.settings.attributes={}),null===e?delete this.settings.attributes[t]:this.settings.attributes[t]=e},getBaseData:function(){var t=p.extend({},this.settings.params);return this.settings.locale?t.locale=this.settings.locale:this.$element&&this.$element.data("locale")&&(t.locale=this.$element.data("locale")),this.settings.elementId?t.elementId=this.settings.elementId:this.$element&&this.$element.data("id")&&(t.elementId=this.$element.data("id")),this.settings.elementType&&(t.elementType=this.settings.elementType),this.settings.attributes&&(t.attributes=this.settings.attributes),t},loadHud:function(){this.onBeginLoading();var t=this.getBaseData();t.includeLocales=this.settings.showLocaleSwitcher,Craft.postActionRequest("elements/getEditorHtml",t,p.proxy(this,"showHud"))},showHud:function(t,e){if(this.onEndLoading(),"success"==e){var s=p();if(t.locales){var i=p('<div class="hud-header"/>'),n=p('<div class="select"/>').appendTo(i);this.$localeSelect=p("<select/>").appendTo(n),this.$localeSpinner=p('<div class="spinner hidden"/>').appendTo(i);for(var a=0;a<t.locales.length;a++){var r=t.locales[a];p('<option value="'+r.id+'"'+(r.id==t.locale?' selected="selected"':"")+">"+r.name+"</option>").appendTo(this.$localeSelect)}this.addListener(this.$localeSelect,"change","switchLocale"),s=s.add(i)}this.$form=p("<div/>"),this.$fieldsContainer=p('<div class="fields"/>').appendTo(this.$form),this.updateForm(t),this.onCreateForm(this.$form);var o=p('<div class="hud-footer"/>').appendTo(this.$form),l=p('<div class="buttons right"/>').appendTo(o);if(this.$cancelBtn=p('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(l),this.$saveBtn=p('<input class="btn submit" type="submit" value="'+Craft.t("Save")+'"/>').appendTo(l),this.$spinner=p('<div class="spinner hidden"/>').appendTo(l),s=s.add(this.$form),this.hud)this.hud.updateBody(s),this.hud.updateSizeAndPosition();else{var h=this.settings.hudTrigger||this.$element;this.hud=new Garnish.HUD(h,s,{bodyClass:"body elementeditor",closeOtherHUDs:!1,onShow:p.proxy(this,"onShowHud"),onHide:p.proxy(this,"onHideHud"),onSubmit:p.proxy(this,"saveElement")}),this.hud.$hud.data("elementEditor",this),this.hud.on("hide",p.proxy(function(){delete this.hud},this))}s.find(".text:first").trigger("focus"),this.addListener(this.$cancelBtn,"click",function(){this.hud.hide()})}},switchLocale:function(){var t=this.$localeSelect.val();if(t!=this.locale){this.$localeSpinner.removeClass("hidden");var e=this.getBaseData();e.locale=t,Craft.postActionRequest("elements/getEditorHtml",e,p.proxy(function(t,e){this.$localeSpinner.addClass("hidden"),"success"==e?this.updateForm(t):this.$localeSelect.val(this.locale)},this))}},updateForm:function(t){this.locale=t.locale,this.$fieldsContainer.html(t.html);for(var e=this.$fieldsContainer.find("> .meta > .field > .heading > .instructions"),s=0;s<e.length;s++)e.eq(s).replaceWith(p("<span/>",{class:"info",html:e.eq(s).children().html()})).infoicon();Garnish.requestAnimationFrame(p.proxy(function(){Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),Craft.initUiElements(this.$fieldsContainer)},this))},saveElement:function(){var t=this.settings.validators;if(p.isArray(t))for(var e=0;e<t.length;e++)if(p.isFunction(t[e])&&!t[e].call())return!1;this.$spinner.removeClass("hidden");var s=p.param(this.getBaseData())+"&"+this.hud.$body.serialize();Craft.postActionRequest("elements/saveElement",s,p.proxy(function(t,e){if(this.$spinner.addClass("hidden"),"success"==e)if("success"==e&&t.success){if(this.$element&&this.locale==this.$element.data("locale")){var s=this.$element.find(".title"),i=s.find("a");i.length&&t.cpEditUrl?(i.attr("href",t.cpEditUrl),i.text(t.newTitle)):s.text(t.newTitle)}void 0!==Craft.livePreview&&Craft.livePreview.updateIframe(!0),this.closeHud(),this.onSaveElement(t)}else this.updateForm(t),Garnish.shake(this.hud.$hud)},this))},closeHud:function(){this.hud.hide(),delete this.hud},onShowHud:function(){this.settings.onShowHud(),this.trigger("showHud")},onHideHud:function(){this.settings.onHideHud(),this.trigger("hideHud")},onBeginLoading:function(){this.$element&&this.$element.addClass("loading"),this.settings.onBeginLoading(),this.trigger("beginLoading")},onEndLoading:function(){this.$element&&this.$element.removeClass("loading"),this.settings.onEndLoading(),this.trigger("endLoading")},onSaveElement:function(t){this.settings.onSaveElement(t),this.trigger("saveElement",{response:t})},onCreateForm:function(t){this.settings.onCreateForm(t)}},{defaults:{hudTrigger:null,showLocaleSwitcher:!0,elementId:null,elementType:null,locale:null,attributes:null,params:null,onShowHud:p.noop,onHideHud:p.noop,onBeginLoading:p.noop,onEndLoading:p.noop,onCreateForm:p.noop,onSaveElement:p.noop,validators:[]}}),Craft.ElevatedSessionForm=Garnish.Base.extend({$form:null,inputs:null,init:function(t,e){if(this.$form=p(t),void 0!==e){this.inputs=[];e=p.makeArray(e);for(var s=0;s<e.length;s++)for(var i=p(e[s]),n=0;n<i.length;n++){var a=i.eq(n);this.inputs.push({input:a,val:Garnish.getInputPostVal(a)})}}this.addListener(this.$form,"submit","handleFormSubmit")},handleFormSubmit:function(t){if(Craft.elevatedSessionManager.fetchingTimeout)t.preventDefault();else{if(this.inputs){for(var e=!1,s=0;s<this.inputs.length;s++)if(Garnish.getInputPostVal(this.inputs[s].input)!=this.inputs[s].val){e=!0;break}if(!e)return}t.preventDefault(),Craft.elevatedSessionManager.requireElevatedSession(p.proxy(this,"submitForm"))}},submitForm:function(){this.disable(),this.$form.trigger("submit"),this.enable()}}),Craft.ElevatedSessionManager=Garnish.Base.extend({fetchingTimeout:!1,passwordModal:null,$passwordInput:null,$passwordSpinner:null,$submitBtn:null,$errorPara:null,callback:null,requireElevatedSession:function(t){this.callback=t,this.fetchingTimeout=!0,Craft.postActionRequest("users/getElevatedSessionTimeout",p.proxy(function(t,e){this.fetchingTimeout=!1,"success"==e&&(!1===t.timeout||t.timeout>=Craft.ElevatedSessionManager.minSafeElevatedSessionTimeout?this.callback():this.showPasswordModal())},this))},showPasswordModal:function(){if(this.passwordModal)this.passwordModal.show();else{var t=p('<form id="elevatedsessionmodal" class="modal secure fitted"/>'),e=p('<div class="body"><p>'+Craft.t("Enter your password to continue.")+"</p></div>").appendTo(t),s=p('<div class="inputcontainer">').appendTo(e),i=p('<table class="inputs fullwidth"/>').appendTo(s),n=p("<tr/>").appendTo(i),a=p("<td/>").appendTo(n),r=p('<td class="thin"/>').appendTo(n),o=p('<div class="passwordwrapper"/>').appendTo(a);this.$passwordInput=p('<input type="password" class="text password fullwidth" placeholder="'+Craft.t("Password")+'"/>').appendTo(o),this.$passwordSpinner=p('<div class="spinner hidden"/>').appendTo(s),this.$submitBtn=p('<input type="submit" class="btn submit disabled" value="'+Craft.t("Submit")+'" />').appendTo(r),this.$errorPara=p('<p class="error"/>').appendTo(e),this.passwordModal=new Garnish.Modal(t,{closeOtherModals:!1,onFadeIn:p.proxy(function(){setTimeout(p.proxy(this,"focusPasswordInput"),100)},this),onFadeOut:p.proxy(function(){this.$passwordInput.val("")},this)}),new Craft.PasswordInput(this.$passwordInput,{onToggleInput:p.proxy(function(t){this.$passwordInput=t},this)}),this.addListener(this.$passwordInput,"textchange","validatePassword"),this.addListener(t,"submit","submitPassword")}},focusPasswordInput:function(){Garnish.isMobileBrowser(!0)||this.$passwordInput.trigger("focus")},validatePassword:function(){return 6<=this.$passwordInput.val().length?(this.$submitBtn.removeClass("disabled"),!0):(this.$submitBtn.addClass("disabled"),!1)},submitPassword:function(t){if(t&&t.preventDefault(),this.validatePassword()){this.$passwordSpinner.removeClass("hidden"),this.clearLoginError();var e={password:this.$passwordInput.val()};Craft.postActionRequest("users/startElevatedSession",e,p.proxy(function(t,e){this.$passwordSpinner.addClass("hidden"),"success"==e?t.success?(this.passwordModal.hide(),this.callback()):(this.showPasswordError(Craft.t("Incorrect password.")),Garnish.shake(this.passwordModal.$container),this.focusPasswordInput()):this.showPasswordError()},this))}},showPasswordError:function(t){null==t&&(t=Craft.t("An unknown error occurred.")),this.$errorPara.text(t),this.passwordModal.updateSizeAndPosition()},clearLoginError:function(){this.showPasswordError("")}},{minSafeElevatedSessionTimeout:5}),Craft.elevatedSessionManager=new Craft.ElevatedSessionManager,Craft.EntryIndex=Craft.BaseElementIndex.extend({publishableSections:null,$newEntryBtnGroup:null,$newEntryBtn:null,afterInit:function(){this.publishableSections=[];for(var t=0;t<Craft.publishableSections.length;t++){var e=Craft.publishableSections[t];this.getSourceByKey("section:"+e.id)&&this.publishableSections.push(e)}this.base()},getDefaultSourceKey:function(){if("index"==this.settings.context&&"undefined"!=typeof defaultSectionHandle){if("singles"==defaultSectionHandle)return"singles";for(var t=0;t<this.$sources.length;t++){var e=p(this.$sources[t]);if(e.data("handle")==defaultSectionHandle)return e.data("key")}}return this.base()},onSelectSource:function(){var t;if(t="singles"==this.$source.data("key")?"singles":this.$source.data("handle"),this.publishableSections.length){var e,s;if(this.$newEntryBtnGroup&&this.$newEntryBtnGroup.remove(),t)for(var i=0;i<this.publishableSections.length;i++)if(this.publishableSections[i].handle==t){e=this.publishableSections[i];break}if(this.$newEntryBtnGroup=p('<div class="btngroup submit"/>'),e){var n=this._getSectionTriggerHref(e),a="index"==this.settings.context?Craft.t("New entry"):Craft.t("New {section} entry",{section:e.name});this.$newEntryBtn=p('<a class="btn submit add icon" '+n+">"+Craft.escapeHtml(a)+"</a>").appendTo(this.$newEntryBtnGroup),"index"!=this.settings.context&&this.addListener(this.$newEntryBtn,"click",function(t){this._openCreateEntryModal(t.currentTarget.getAttribute("data-id"))}),1<this.publishableSections.length&&(s=p('<div class="btn submit menubtn"></div>').appendTo(this.$newEntryBtnGroup))}else this.$newEntryBtn=s=p('<div class="btn submit add icon menubtn">'+Craft.t("New entry")+"</div>").appendTo(this.$newEntryBtnGroup);if(s){var r='<div class="menu"><ul>';for(i=0;i<this.publishableSections.length;i++){var o=this.publishableSections[i];if("index"==this.settings.context||o!=e){n=this._getSectionTriggerHref(o),a="index"==this.settings.context?o.name:Craft.t("New {section} entry",{section:o.name});r+="<li><a "+n+'">'+Craft.escapeHtml(a)+"</a></li>"}}p(r+="</ul></div>").appendTo(this.$newEntryBtnGroup);var l=new Garnish.MenuBtn(s);"index"!=this.settings.context&&l.on("optionSelect",p.proxy(function(t){this._openCreateEntryModal(t.option.getAttribute("data-id"))},this))}this.addButton(this.$newEntryBtnGroup)}if("index"==this.settings.context&&"undefined"!=typeof history){var h="entries";t&&(h+="/"+t),history.replaceState({},"",Craft.getUrl(h))}this.base()},_getSectionTriggerHref:function(t){return"index"==this.settings.context?'href="'+Craft.getUrl("entries/"+t.handle+"/new")+'"':'data-id="'+t.id+'"'},_openCreateEntryModal:function(s){if(!this.$newEntryBtn.hasClass("loading")){for(var t,e=0;e<this.publishableSections.length;e++)if(this.publishableSections[e].id==s){t=this.publishableSections[e];break}if(t){this.$newEntryBtn.addClass("inactive");var i=this.$newEntryBtn.text();this.$newEntryBtn.text(Craft.t("New {section} entry",{section:t.name})),new Craft.ElementEditor({hudTrigger:this.$newEntryBtnGroup,elementType:"Entry",locale:this.locale,attributes:{sectionId:s},onBeginLoading:p.proxy(function(){this.$newEntryBtn.addClass("loading")},this),onEndLoading:p.proxy(function(){this.$newEntryBtn.removeClass("loading")},this),onHideHud:p.proxy(function(){this.$newEntryBtn.removeClass("inactive").text(i)},this),onSaveElement:p.proxy(function(t){var e="section:"+s;this.sourceKey!=e&&this.selectSourceByKey(e),this.selectElementAfterUpdate(t.id),this.updateElements()},this)})}}}}),Craft.registerElementIndexClass("Entry",Craft.EntryIndex),Craft.EntryUrlFormatGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(t){t=(t=t.replace("/<(.*?)>/g","")).toLowerCase(),t=(t=(t=Craft.asciiString(t)).replace(/^[^a-z]+/,"")).replace(/[^a-z0-9]+$/,"");var e=Craft.filterArray(t.split(/[^a-z0-9]+/)).join("-");return e&&this.settings.suffix&&(e+=this.settings.suffix),e}}),Craft.FieldLayoutDesigner=Garnish.Base.extend({$container:null,$tabContainer:null,$unusedFieldContainer:null,$newTabBtn:null,$allFields:null,tabGrid:null,unusedFieldGrid:null,tabDrag:null,fieldDrag:null,init:function(t,e){this.$container=p(t),this.setSettings(e,Craft.FieldLayoutDesigner.defaults),this.$tabContainer=this.$container.children(".fld-tabs"),this.$unusedFieldContainer=this.$container.children(".unusedfields"),this.$newTabBtn=this.$container.find("> .newtabbtn-container > .btn"),this.$allFields=this.$unusedFieldContainer.find(".fld-field"),this.tabGrid=new Craft.Grid(this.$tabContainer,Craft.FieldLayoutDesigner.gridSettings),this.unusedFieldGrid=new Craft.Grid(this.$unusedFieldContainer,Craft.FieldLayoutDesigner.gridSettings);for(var s=this.$tabContainer.children(),i=0;i<s.length;i++)this.initTab(p(s[i]));this.fieldDrag=new Craft.FieldLayoutDesigner.FieldDrag(this),this.settings.customizableTabs&&(this.tabDrag=new Craft.FieldLayoutDesigner.TabDrag(this),this.addListener(this.$newTabBtn,"activate","addTab"))},initTab:function(t){if(this.settings.customizableTabs){var e=t.find(".tabs .settings"),s=p('<div class="menu" data-align="center"/>').insertAfter(e),i=p("<ul/>").appendTo(s);p('<li><a data-action="rename">'+Craft.t("Rename")+"</a></li>").appendTo(i),p('<li><a data-action="delete">'+Craft.t("Delete")+"</a></li>").appendTo(i),new Garnish.MenuBtn(e,{onOptionSelect:p.proxy(this,"onTabOptionSelect")})}for(var n=t.children(".fld-tabcontent").children(),a=0;a<n.length;a++)this.initField(p(n[a]))},initField:function(t){var e=t.find(".settings"),s=p('<div class="menu" data-align="center"/>').insertAfter(e),i=p("<ul/>").appendTo(s);t.hasClass("fld-required")?p('<li><a data-action="toggle-required">'+Craft.t("Make not required")+"</a></li>").appendTo(i):p('<li><a data-action="toggle-required">'+Craft.t("Make required")+"</a></li>").appendTo(i),p('<li><a data-action="remove">'+Craft.t("Remove")+"</a></li>").appendTo(i),new Garnish.MenuBtn(e,{onOptionSelect:p.proxy(this,"onFieldOptionSelect")})},onTabOptionSelect:function(t){if(this.settings.customizableTabs){var e=p(t),s=e.data("menu").$anchor.parent().parent().parent();switch(e.data("action")){case"rename":this.renameTab(s);break;case"delete":this.deleteTab(s)}}},onFieldOptionSelect:function(t){var e=p(t),s=e.data("menu").$anchor.parent();switch(e.data("action")){case"toggle-required":this.toggleRequiredField(s,e);break;case"remove":this.removeField(s)}},renameTab:function(t){if(this.settings.customizableTabs){var e=t.find(".tabs .tab span"),s=e.text(),i=prompt(Craft.t("Give your tab a name."),s);i&&i!=s&&(e.text(i),t.find(".id-input").attr("name",this.getFieldInputName(i)))}},deleteTab:function(t){if(this.settings.customizableTabs){for(var e=t.find(".fld-field"),s=0;s<e.length;s++){var i=p(e[s]).attr("data-id");this.removeFieldById(i)}this.tabGrid.removeItems(t),this.tabDrag.removeItems(t),t.remove()}},toggleRequiredField:function(t,e){t.hasClass("fld-required")?(t.removeClass("fld-required"),t.find(".required-input").remove(),setTimeout(function(){e.text(Craft.t("Make required"))},500)):(t.addClass("fld-required"),p('<input class="required-input" type="hidden" name="'+this.settings.requiredFieldInputName+'" value="'+t.data("id")+'">').appendTo(t),setTimeout(function(){e.text(Craft.t("Make not required"))},500))},removeField:function(t){var e=t.attr("data-id");t.remove(),this.removeFieldById(e),this.tabGrid.refreshCols(!0)},removeFieldById:function(t){var e=this.$allFields.filter("[data-id="+t+"]:first"),s=e.closest(".fld-tab");e.removeClass("hidden"),s.hasClass("hidden")?(s.removeClass("hidden"),this.unusedFieldGrid.addItems(s),this.settings.customizableTabs&&this.tabDrag.addItems(s)):this.unusedFieldGrid.refreshCols(!0)},addTab:function(){if(this.settings.customizableTabs){var t=p('<div class="fld-tab"><div class="tabs"><div class="tab sel draggable"><span>Tab '+(this.tabGrid.$items.length+1)+'</span><a class="settings icon" title="'+Craft.t("Rename")+'"></a></div></div><div class="fld-tabcontent"></div></div>').appendTo(this.$tabContainer);this.tabGrid.addItems(t),this.tabDrag.addItems(t),this.initTab(t)}},getFieldInputName:function(t){return this.settings.fieldInputName.replace(/__TAB_NAME__/g,Craft.encodeUriComponent(t))}},{gridSettings:{itemSelector:".fld-tab:not(.hidden)",minColWidth:240,percentageWidths:!1,fillMode:"grid",snapToGrid:30},defaults:{customizableTabs:!0,fieldInputName:"fieldLayout[__TAB_NAME__][]",requiredFieldInputName:"requiredFields[]"}}),Craft.FieldLayoutDesigner.BaseDrag=Garnish.Drag.extend({designer:null,$insertion:null,showingInsertion:!1,$caboose:null,draggingUnusedItem:!1,addToTabGrid:!1,init:function(t,e){this.designer=t;var s=this.designer.$tabContainer.find(this.itemSelector).add(this.designer.$unusedFieldContainer.find(this.itemSelector));this.base(s,e)},onDragStart:function(){this.base(),this.draggingUnusedItem=this.$draggee.hasClass("unused"),this.$insertion=this.getInsertion(),this.addCaboose(),this.$items=p().add(this.$items.add(this.$caboose)),this.addToTabGrid&&this.designer.tabGrid.addItems(this.$caboose),this.draggingUnusedItem?this.showingInsertion=!1:(this.$insertion.insertBefore(this.$draggee),this.$draggee.detach(),this.$items=p().add(this.$items.not(this.$draggee).add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$draggee),this.designer.tabGrid.addItems(this.$insertion))),this.setMidpoints()},addCaboose:p.noop,getItemContainer:p.noop,isItemInTabContainer:function(t){return this.getItemContainer(t)[0]==this.designer.$tabContainer[0]},setMidpoints:function(){for(var t=0;t<this.$items.length;t++){var e=p(this.$items[t]);if(this.isItemInTabContainer(e)){var s=e.offset();e.data("midpoint",{left:s.left+e.outerWidth()/2,top:s.top+e.outerHeight()/2})}}},onDrag:function(){this.draggingUnusedItem&&!Garnish.hitTest(this.mouseX,this.mouseY,this.designer.$tabContainer)?this.showingInsertion&&(this.$insertion.remove(),this.$items=p().add(this.$items.not(this.$insertion)),this.showingInsertion=!1,this.addToTabGrid?this.designer.tabGrid.removeItems(this.$insertion):this.designer.tabGrid.refreshCols(!0),this.setMidpoints()):(this.onDrag._closestItem=this.getClosestItem(),this.onDrag._closestItem!=this.$insertion[0]&&(this.showingInsertion&&p.inArray(this.$insertion[0],this.$items)<p.inArray(this.onDrag._closestItem,this.$items)&&-1==p.inArray(this.onDrag._closestItem,this.$caboose)?this.$insertion.insertAfter(this.onDrag._closestItem):this.$insertion.insertBefore(this.onDrag._closestItem),this.$items=p().add(this.$items.add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid?this.designer.tabGrid.addItems(this.$insertion):this.designer.tabGrid.refreshCols(!0),this.setMidpoints())),this.base()},getClosestItem:function(){for(this.getClosestItem._closestItem=null,this.getClosestItem._closestItemMouseDiff=null,this.getClosestItem._i=0;this.getClosestItem._i<this.$items.length;this.getClosestItem._i++)this.getClosestItem._$item=p(this.$items[this.getClosestItem._i]),this.isItemInTabContainer(this.getClosestItem._$item)&&(this.getClosestItem._midpoint=this.getClosestItem._$item.data("midpoint"),this.getClosestItem._mouseDiff=Garnish.getDist(this.getClosestItem._midpoint.left,this.getClosestItem._midpoint.top,this.mouseX,this.mouseY),(null===this.getClosestItem._closestItem||this.getClosestItem._mouseDiff<this.getClosestItem._closestItemMouseDiff)&&(this.getClosestItem._closestItem=this.getClosestItem._$item[0],this.getClosestItem._closestItemMouseDiff=this.getClosestItem._mouseDiff));return this.getClosestItem._closestItem},onDragStop:function(){this.showingInsertion&&(this.$insertion.replaceWith(this.$draggee),this.$items=p().add(this.$items.not(this.$insertion).add(this.$draggee)),this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$insertion),this.designer.tabGrid.addItems(this.$draggee))),this.$items=this.$items.not(this.$caboose),this.$caboose.remove(),this.addToTabGrid&&this.designer.tabGrid.removeItems(this.$caboose),this.$draggee.css({display:this.draggeeDisplay,visibility:"hidden"}),this.designer.tabGrid.refreshCols(!0),this.designer.unusedFieldGrid.refreshCols(!0),this.returnHelpersToDraggees(),this.base()}}),Craft.FieldLayoutDesigner.TabDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab",addToTabGrid:!0,init:function(t){this.base(t,{handle:".tab"})},addCaboose:function(){this.$caboose=p('<div class="fld-tab fld-tab-caboose"/>').appendTo(this.designer.$tabContainer)},getInsertion:function(){var t=this.$draggee.find(".tab");return p('<div class="fld-tab fld-insertion" style="height: '+this.$draggee.height()+'px;"><div class="tabs"><div class="tab sel draggable" style="width: '+t.width()+"px; height: "+t.height()+'px;"></div></div><div class="fld-tabcontent" style="height: '+this.$draggee.find(".fld-tabcontent").height()+'px;"></div></div>')},getItemContainer:function(t){return t.parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var t=this.$draggee.clone().removeClass("unused"),e=t.find(".tab span").text();t.find(".fld-field").removeClass("unused"),t.find(".tabs .tab").append('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');var s=t.find(".fld-field"),i=s.filter(".hidden").remove();(s=s.not(i)).prepend('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');for(var n=0;n<s.length;n++){var a=p(s[n]),r=this.designer.getFieldInputName(e);a.append('<input class="id-input" type="hidden" name="'+r+'" value="'+a.data("id")+'">')}this.designer.fieldDrag.addItems(s),this.designer.initTab(t),this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden"),this.$draggee.find(".fld-field").addClass("hidden"),this.$draggee=t,this.addItems(t),this.designer.tabGrid.addItems(t),this.designer.unusedFieldGrid.removeItems(this.$draggee)}this.base()}}),Craft.FieldLayoutDesigner.FieldDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab .fld-field",addCaboose:function(){this.$caboose=p();for(var t=this.designer.$tabContainer.children().children(".fld-tabcontent"),e=0;e<t.length;e++){var s=p('<div class="fld-tab fld-tab-caboose"/>').appendTo(t[e]);this.$caboose=this.$caboose.add(s)}},getInsertion:function(){return p('<div class="fld-field fld-insertion" style="height: '+this.$draggee.height()+'px;"/>')},getItemContainer:function(t){return t.parent().parent().parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var t=this.$draggee.clone().removeClass("unused");if(t.prepend('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>'),this.designer.initField(t),this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden"),0==this.$draggee.siblings(":not(.hidden)").length){var e=this.$draggee.parent().parent();e.addClass("hidden"),this.designer.unusedFieldGrid.removeItems(e)}this.$draggee=t,this.addItems(t)}if(this.showingInsertion){var s=this.$insertion.parent().parent().find(".tab span").text(),i=this.designer.getFieldInputName(s);this.draggingUnusedItem?this.$draggee.append('<input class="id-input" type="hidden" name="'+i+'" value="'+this.$draggee.data("id")+'">'):this.$draggee.find(".id-input").attr("name",i)}this.base()}}),Craft.FieldToggle=Garnish.Base.extend({$toggle:null,targetPrefix:null,targetSelector:null,reverseTargetSelector:null,_$target:null,_$reverseTarget:null,type:null,init:function(t){this.$toggle=p(t),this.$toggle.data("fieldtoggle")&&(Garnish.log("Double-instantiating a field toggle on an element"),this.$toggle.data("fieldtoggle").destroy()),this.$toggle.data("fieldtoggle",this),this.type=this.getType(),"select"==this.type?this.targetPrefix=this.$toggle.attr("data-target-prefix")||"":(this.targetSelector=this.normalizeTargetSelector(this.$toggle.data("target")),this.reverseTargetSelector=this.normalizeTargetSelector(this.$toggle.data("reverse-target"))),this.findTargets(),"link"==this.type?this.addListener(this.$toggle,"click","onToggleChange"):this.addListener(this.$toggle,"change","onToggleChange")},normalizeTargetSelector:function(t){return t&&!t.match(/^[#\.]/)&&(t="#"+t),t},getType:function(){return"INPUT"==this.$toggle.prop("nodeName")&&"checkbox"==this.$toggle.attr("type").toLowerCase()?"checkbox":"SELECT"==this.$toggle.prop("nodeName")?"select":"A"==this.$toggle.prop("nodeName")?"link":"DIV"==this.$toggle.prop("nodeName")&&this.$toggle.hasClass("lightswitch")?"lightswitch":void 0},findTargets:function(){"select"==this.type?this._$target=p(this.normalizeTargetSelector(this.targetPrefix+this.getToggleVal())):(this.targetSelector&&(this._$target=p(this.targetSelector)),this.reverseTargetSelector&&(this._$reverseTarget=p(this.reverseTargetSelector)))},getToggleVal:function(){return"lightswitch"==this.type?this.$toggle.children("input").val():Garnish.getInputPostVal(this.$toggle)},onToggleChange:function(){"select"==this.type?(this.hideTarget(this._$target),this.findTargets(),this.showTarget(this._$target)):("link"==this.type?this.onToggleChange._show=this.$toggle.hasClass("collapsed")||!this.$toggle.hasClass("expanded"):this.onToggleChange._show=!!this.getToggleVal(),this.onToggleChange._show?(this.showTarget(this._$target),this.hideTarget(this._$reverseTarget)):(this.hideTarget(this._$target),this.showTarget(this._$reverseTarget)),delete this.onToggleChange._show)},showTarget:function(t){t&&t.length&&(this.showTarget._currentHeight=t.height(),t.removeClass("hidden"),"select"!=this.type&&("link"==this.type&&(this.$toggle.removeClass("collapsed"),this.$toggle.addClass("expanded")),t.height("auto"),this.showTarget._targetHeight=t.height(),t.css({height:this.showTarget._currentHeight,overflow:"hidden"}),t.velocity("stop"),t.velocity({height:this.showTarget._targetHeight},"fast",function(){t.css({height:"",overflow:""})}),delete this.showTarget._targetHeight),delete this.showTarget._currentHeight,Garnish.$win.trigger("resize"))},hideTarget:function(t){t&&t.length&&("select"==this.type?t.addClass("hidden"):("link"==this.type&&(this.$toggle.removeClass("expanded"),this.$toggle.addClass("collapsed")),t.css("overflow","hidden"),t.velocity("stop"),t.velocity({height:0},"fast",function(){t.addClass("hidden")})))}}),Craft.Grid=Garnish.Base.extend({$container:null,$items:null,items:null,totalCols:null,colPctWidth:null,sizeUnit:null,possibleItemColspans:null,possibleItemPositionsByColspan:null,itemPositions:null,itemColspansByPosition:null,layouts:null,layout:null,itemHeights:null,leftPadding:null,_refreshingCols:!1,_refreshColsAfterRefresh:!1,_forceRefreshColsAfterRefresh:!1,init:function(t,e){this.$container=p(t),this.$container.data("grid")&&(Garnish.log("Double-instantiating a grid on an element"),this.$container.data("grid").destroy()),this.$container.data("grid",this),this.setSettings(e,Craft.Grid.defaults),"pct"==this.settings.mode?this.sizeUnit="%":this.sizeUnit="px",this.handleContainerHeightProxy=p.proxy(function(){this.refreshCols(!1,!0)},this),this.$items=this.$container.children(this.settings.itemSelector),this.setItems(),this.refreshCols(!0,!1),Garnish.$doc.ready(p.proxy(function(){this.refreshCols(!1,!1)},this))},addItems:function(t){this.$items=p().add(this.$items.add(t)),this.setItems(),this.refreshCols(!0,!0),p(t).velocity("finish")},removeItems:function(t){this.$items=p().add(this.$items.not(t)),this.setItems(),this.refreshCols(!0,!0)},resetItemOrder:function(){this.$items=p().add(this.$items),this.setItems(),this.refreshCols(!0,!0)},setItems:function(){for(this.setItems._={},this.items=[],this.setItems._.i=0;this.setItems._.i<this.$items.length;this.setItems._.i++)this.items.push(p(this.$items[this.setItems._.i]));delete this.setItems._},refreshCols:function(t,e){if(this._refreshingCols)return this._refreshColsAfterRefresh=!0,void(t&&(this._forceRefreshColsAfterRefresh=!0));if(this._refreshingCols=!0,this.items.length)if(this.refreshCols._={},this.refreshCols._.oldHeight=this.$container[0].style.height,this.$container[0].style.height=1,this.refreshCols._.scrollHeight=this.$container[0].scrollHeight,this.$container[0].style.height=this.refreshCols._.oldHeight,0!=this.refreshCols._.scrollHeight)if(this.settings.cols?this.refreshCols._.totalCols=this.settings.cols:(this.refreshCols._.totalCols=Math.floor(this.$container.width()/this.settings.minColWidth),this.settings.maxCols&&this.refreshCols._.totalCols>this.settings.maxCols&&(this.refreshCols._.totalCols=this.settings.maxCols)),0==this.refreshCols._.totalCols&&(this.refreshCols._.totalCols=1),!0===t||this.totalCols!==this.refreshCols._.totalCols){if(this.totalCols=this.refreshCols._.totalCols,this.removeListener(this.$container,"resize"),"grid"==this.settings.fillMode)for(this.refreshCols._.itemIndex=0;this.refreshCols._.itemIndex<this.items.length;){for(this.refreshCols._.tallestItemHeight=-1,this.refreshCols._.colIndex=0,this.refreshCols._.i=this.refreshCols._.itemIndex;this.refreshCols._.i<this.refreshCols._.itemIndex+this.totalCols&&this.refreshCols._.i<this.items.length;this.refreshCols._.i++)this.refreshCols._.itemHeight=this.items[this.refreshCols._.i].height("auto").height(),this.refreshCols._.itemHeight>this.refreshCols._.tallestItemHeight&&(this.refreshCols._.tallestItemHeight=this.refreshCols._.itemHeight),this.refreshCols._.colIndex++;for(this.settings.snapToGrid&&(this.refreshCols._.remainder=this.refreshCols._.tallestItemHeight%this.settings.snapToGrid,this.refreshCols._.remainder&&(this.refreshCols._.tallestItemHeight+=this.settings.snapToGrid-this.refreshCols._.remainder)),this.refreshCols._.i=this.refreshCols._.itemIndex;this.refreshCols._.i<this.refreshCols._.itemIndex+this.totalCols&&this.refreshCols._.i<this.items.length;this.refreshCols._.i++)this.items[this.refreshCols._.i].height(this.refreshCols._.tallestItemHeight);this.refreshCols._.itemIndex+=this.totalCols}else if(this.removeListener(this.$items,"resize"),1==this.totalCols)this.$container.height("auto"),this.$items.show().css({position:"relative",width:"auto",top:0}).css(Craft.left,0);else{for(this.$items.css("position","absolute"),"pct"==this.settings.mode&&(this.colPctWidth=100/this.totalCols),this.layouts=[],this.itemPositions=[],this.itemColspansByPosition=[],this.possibleItemColspans=[],this.possibleItemPositionsByColspan=[],this.itemHeightsByColspan=[],this.refreshCols._.item=0;this.refreshCols._.item<this.items.length;this.refreshCols._.item++)for(this.possibleItemColspans[this.refreshCols._.item]=[],this.possibleItemPositionsByColspan[this.refreshCols._.item]={},this.itemHeightsByColspan[this.refreshCols._.item]={},this.refreshCols._.$item=this.items[this.refreshCols._.item].show(),this.refreshCols._.positionRight="right"==this.refreshCols._.$item.data("position"),this.refreshCols._.positionLeft="left"==this.refreshCols._.$item.data("position"),this.refreshCols._.minColspan=this.refreshCols._.$item.data("colspan")?this.refreshCols._.$item.data("colspan"):this.refreshCols._.$item.data("min-colspan")?this.refreshCols._.$item.data("min-colspan"):1,this.refreshCols._.maxColspan=this.refreshCols._.$item.data("colspan")?this.refreshCols._.$item.data("colspan"):this.refreshCols._.$item.data("max-colspan")?this.refreshCols._.$item.data("max-colspan"):this.totalCols,this.refreshCols._.minColspan>this.totalCols&&(this.refreshCols._.minColspan=this.totalCols),this.refreshCols._.maxColspan>this.totalCols&&(this.refreshCols._.maxColspan=this.totalCols),this.refreshCols._.colspan=this.refreshCols._.minColspan;this.refreshCols._.colspan<=this.refreshCols._.maxColspan;this.refreshCols._.colspan++)for(this.refreshCols._.$item.css("width",this.getItemWidth(this.refreshCols._.colspan)+this.sizeUnit),this.itemHeightsByColspan[this.refreshCols._.item][this.refreshCols._.colspan]=this.refreshCols._.$item.outerHeight(),this.possibleItemColspans[this.refreshCols._.item].push(this.refreshCols._.colspan),this.possibleItemPositionsByColspan[this.refreshCols._.item][this.refreshCols._.colspan]=[],this.refreshCols._.positionLeft?(this.refreshCols._.minPosition=0,this.refreshCols._.maxPosition=0):this.refreshCols._.positionRight?(this.refreshCols._.minPosition=this.totalCols-this.refreshCols._.colspan,this.refreshCols._.maxPosition=this.refreshCols._.minPosition):(this.refreshCols._.minPosition=0,this.refreshCols._.maxPosition=this.totalCols-this.refreshCols._.colspan),this.refreshCols._.position=this.refreshCols._.minPosition;this.refreshCols._.position<=this.refreshCols._.maxPosition;this.refreshCols._.position++)this.possibleItemPositionsByColspan[this.refreshCols._.item][this.refreshCols._.colspan].push(this.refreshCols._.position);for(this.refreshCols._.colHeights=[],this.refreshCols._.i=0;this.refreshCols._.i<this.totalCols;this.refreshCols._.i++)this.refreshCols._.colHeights.push(0);for(this.createLayouts(0,[],[],this.refreshCols._.colHeights,0),this.refreshCols._.layoutTotalCols=[],this.refreshCols._.i=0;this.refreshCols._.i<this.layouts.length;this.refreshCols._.i++)for(this.refreshCols._.layoutTotalCols[this.refreshCols._.i]=0,this.refreshCols._.j=0;this.refreshCols._.j<this.totalCols;this.refreshCols._.j++)this.layouts[this.refreshCols._.i].colHeights[this.refreshCols._.j]&&this.refreshCols._.layoutTotalCols[this.refreshCols._.i]++;for(this.refreshCols._.highestTotalCols=Math.max.apply(null,this.refreshCols._.layoutTotalCols),this.refreshCols._.i=this.layouts.length-1;0<=this.refreshCols._.i;this.refreshCols._.i--)this.refreshCols._.layoutTotalCols[this.refreshCols._.i]!=this.refreshCols._.highestTotalCols&&this.layouts.splice(this.refreshCols._.i,1);for(this.refreshCols._.layoutHeights=[],this.refreshCols._.i=0;this.refreshCols._.i<this.layouts.length;this.refreshCols._.i++)this.refreshCols._.layoutHeights.push(Math.max.apply(null,this.layouts[this.refreshCols._.i].colHeights));for(this.refreshCols._.shortestHeight=Math.min.apply(null,this.refreshCols._.layoutHeights),this.refreshCols._.shortestLayouts=[],this.refreshCols._.emptySpaces=[],this.refreshCols._.i=0;this.refreshCols._.i<this.refreshCols._.layoutHeights.length;this.refreshCols._.i++)if(this.refreshCols._.layoutHeights[this.refreshCols._.i]==this.refreshCols._.shortestHeight){for(this.refreshCols._.shortestLayouts.push(this.layouts[this.refreshCols._.i]),this.refreshCols._.emptySpace=this.layouts[this.refreshCols._.i].emptySpace,this.refreshCols._.j=0;this.refreshCols._.j<this.totalCols;this.refreshCols._.j++)this.refreshCols._.emptySpace+=this.refreshCols._.shortestHeight-this.layouts[this.refreshCols._.i].colHeights[this.refreshCols._.j];this.refreshCols._.emptySpaces.push(this.refreshCols._.emptySpace)}for(this.layout=this.refreshCols._.shortestLayouts[p.inArray(Math.min.apply(null,this.refreshCols._.emptySpaces),this.refreshCols._.emptySpaces)],this.refreshCols._.totalEmptyCols=0,this.refreshCols._.i=this.layout.colHeights.length-1;0<=this.refreshCols._.i&&0==this.layout.colHeights[this.refreshCols._.i];this.refreshCols._.i--)this.refreshCols._.totalEmptyCols++;for(this.leftPadding=this.getItemWidth(this.refreshCols._.totalEmptyCols)/2,"fixed"==this.settings.mode&&(this.leftPadding+=(this.$container.width()-this.settings.minColWidth*this.totalCols)/2),this.refreshCols._.i=0;this.refreshCols._.i<this.items.length;this.refreshCols._.i++)this.refreshCols._.css={width:this.getItemWidth(this.layout.colspans[this.refreshCols._.i])+this.sizeUnit},this.refreshCols._.css[Craft.left]=this.leftPadding+this.getItemWidth(this.layout.positions[this.refreshCols._.i])+this.sizeUnit,e?this.items[this.refreshCols._.i].velocity(this.refreshCols._.css,{queue:!1}):this.items[this.refreshCols._.i].velocity("finish").css(this.refreshCols._.css);this.isSimpleLayout()?(this.$container.height("auto"),this.$items.css("position","relative")):(this.$items.css("position","absolute"),this.positionItems(e),this.addListener(this.$items,"resize","onItemResize"))}this.completeRefreshCols(),this.addListener(this.$container,"resize",this.handleContainerHeightProxy),this.onRefreshCols()}else this.completeRefreshCols();else this.completeRefreshCols();else this.completeRefreshCols()},completeRefreshCols:function(){void 0!==this.refreshCols._&&delete this.refreshCols._,this._refreshingCols=!1,this._refreshColsAfterRefresh&&(force=this._forceRefreshColsAfterRefresh,this._refreshColsAfterRefresh=!1,this._forceRefreshColsAfterRefresh=!1,Garnish.requestAnimationFrame(p.proxy(function(){this.refreshCols(force)},this)))},getItemWidth:function(t){return"pct"==this.settings.mode?this.colPctWidth*t:this.settings.minColWidth*t},createLayouts:function(t,e,s,i,n){new Craft.Grid.LayoutGenerator(this).createLayouts(t,e,s,i,n)},isSimpleLayout:function(){for(this.isSimpleLayout._={},this.isSimpleLayout._.i=0;this.isSimpleLayout._.i<this.layout.positions.length;this.isSimpleLayout._.i++)if(0!=this.layout.positions[this.isSimpleLayout._.i])return delete this.isSimpleLayout._,!1;return delete this.isSimpleLayout._,!0},positionItems:function(t){for(this.positionItems._={},this.positionItems._.colHeights=[],this.positionItems._.i=0;this.positionItems._.i<this.totalCols;this.positionItems._.i++)this.positionItems._.colHeights.push(0);for(this.positionItems._.i=0;this.positionItems._.i<this.items.length;this.positionItems._.i++){for(this.positionItems._.endingCol=this.layout.positions[this.positionItems._.i]+this.layout.colspans[this.positionItems._.i]-1,this.positionItems._.affectedColHeights=[],this.positionItems._.col=this.layout.positions[this.positionItems._.i];this.positionItems._.col<=this.positionItems._.endingCol;this.positionItems._.col++)this.positionItems._.affectedColHeights.push(this.positionItems._.colHeights[this.positionItems._.col]);for(this.positionItems._.top=Math.max.apply(null,this.positionItems._.affectedColHeights),t?this.items[this.positionItems._.i].velocity({top:this.positionItems._.top},{queue:!1}):this.items[this.positionItems._.i].velocity("finish").css("top",this.positionItems._.top),this.positionItems._.col=this.layout.positions[this.positionItems._.i];this.positionItems._.col<=this.positionItems._.endingCol;this.positionItems._.col++)this.positionItems._.colHeights[this.positionItems._.col]=this.positionItems._.top+this.itemHeightsByColspan[this.positionItems._.i][this.layout.colspans[this.positionItems._.i]]}this.$container.height(Math.max.apply(null,this.positionItems._.colHeights)),delete this.positionItems._},onItemResize:function(t){this.onItemResize._={},t.stopPropagation(),this.onItemResize._.item=p.inArray(t.currentTarget,this.$items),-1!=this.onItemResize._.item&&(this.onItemResize._.newHeight=this.items[this.onItemResize._.item].outerHeight(),this.onItemResize._.newHeight!=this.itemHeightsByColspan[this.onItemResize._.item][this.layout.colspans[this.onItemResize._.item]]&&(this.itemHeightsByColspan[this.onItemResize._.item][this.layout.colspans[this.onItemResize._.item]]=this.onItemResize._.newHeight,this.positionItems(!1))),delete this.onItemResize._},onRefreshCols:function(){this.trigger("refreshCols"),this.settings.onRefreshCols()}},{defaults:{itemSelector:".item",cols:null,maxCols:null,minColWidth:320,mode:"pct",fillMode:"top",colClass:"col",snapToGrid:null,onRefreshCols:p.noop}}),Craft.Grid.LayoutGenerator=Garnish.Base.extend({grid:null,_:null,init:function(t){this.grid=t},createLayouts:function(t,e,s,i,n){for(this._={},this._.c=0;this._.c<this.grid.possibleItemColspans[t].length;this._.c++){for(this._.colspan=this.grid.possibleItemColspans[t][this._.c],this._.tallestColHeightsByPosition=[],this._.p=0;this._.p<this.grid.possibleItemPositionsByColspan[t][this._.colspan].length;this._.p++){for(this._.position=this.grid.possibleItemPositionsByColspan[t][this._.colspan][this._.p],this._.colHeightsForPosition=[],this._.endingCol=this._.position+this._.colspan-1,this._.col=this._.position;this._.col<=this._.endingCol;this._.col++)this._.colHeightsForPosition.push(i[this._.col]);this._.tallestColHeightsByPosition[this._.p]=Math.max.apply(null,this._.colHeightsForPosition)}for(this._.p=p.inArray(Math.min.apply(null,this._.tallestColHeightsByPosition),this._.tallestColHeightsByPosition),this._.position=this.grid.possibleItemPositionsByColspan[t][this._.colspan][this._.p],this._.positions=e.slice(0),this._.colspans=s.slice(0),this._.colHeights=i.slice(0),this._.emptySpace=n,this._.positions.push(this._.position),this._.colspans.push(this._.colspan),this._.tallestColHeight=this._.tallestColHeightsByPosition[this._.p],this._.endingCol=this._.position+this._.colspan-1,this._.col=this._.position;this._.col<=this._.endingCol;this._.col++)this._.emptySpace+=this._.tallestColHeight-this._.colHeights[this._.col],this._.colHeights[this._.col]=this._.tallestColHeight+this.grid.itemHeightsByColspan[t][this._.colspan];t==this.grid.items.length-1?this.grid.layouts.push({positions:this._.positions,colspans:this._.colspans,colHeights:this._.colHeights,emptySpace:this._.emptySpace}):this.grid.createLayouts(t+1,this._.positions,this._.colspans,this._.colHeights,this._.emptySpace)}delete this._}}),Craft.HandleGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(t){s=(s=(s=t.replace("/<(.*?)>/g","")).replace(/['"‘’“”\[\]\(\)\{\}:]/g,"")).toLowerCase(),s=(s=Craft.asciiString(s)).replace(/^[^a-z]+/,"");for(var e=Craft.filterArray(s.split(/[^a-z0-9]+/)),s="",i=0;i<e.length;i++)s+=0==i?e[i]:e[i].charAt(0).toUpperCase()+e[i].substr(1);return s}}),Craft.ImageUpload=Garnish.Base.extend({_imageHandler:null,init:function(t){this.setSettings(t,Craft.ImageUpload.defaults),this._imageHandler=new Craft.ImageHandler(t)},destroy:function(){this._imageHandler.destroy(),delete this._imageHandler,this.base()}},{$modalContainerDiv:null,defaults:{postParameters:{},modalClass:"",uploadButton:{},uploadAction:"",deleteButton:{},deleteMessage:"",deleteAction:"",cropAction:"",constraint:500,areaToolOptions:{aspectRatio:"1",initialRectangle:{mode:"auto",x1:0,x2:0,y1:0,y2:0}},onImageDelete:function(t){location.reload()},onImageSave:function(t){location.reload()}}}),Craft.ImageHandler=Garnish.Base.extend({modal:null,progressBar:null,$container:null,init:function(i){this.setSettings(i);var t=i.uploadButton,e=p('<input type="file" name="image-upload"/>').hide().insertBefore(t);this.progressBar=new Craft.ProgressBar(p('<div class="progress-shade"></div>').insertBefore(t)),this.progressBar.$progressBar.css({top:Math.round(t.outerHeight()/2)-6}),this.$container=t.parent();var s={url:Craft.getActionUrl(this.settings.uploadAction),fileInput:e,element:this.settings.uploadButton[0],action:Craft.actionUrl+"/"+this.settings.uploadAction,formData:"object"==typeof this.settings.postParameters?this.settings.postParameters:{},events:{fileuploadstart:p.proxy(function(){this.$container.addClass("uploading"),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar()},this),fileuploadprogressall:p.proxy(function(t){var e=parseInt(t.loaded/t.total*100,10);this.progressBar.setProgressPercentage(e)},this),fileuploaddone:p.proxy(function(t,e){this.progressBar.hideProgressBar(),this.$container.removeClass("uploading");var s=e.result;s.error?alert(s.error):(null==Craft.ImageUpload.$modalContainerDiv&&(Craft.ImageUpload.$modalContainerDiv=p('<div class="modal fitted"></div>').addClass(i.modalClass).appendTo(Garnish.$bod)),s.fileName&&(this.source=s.fileName),s.html&&(Craft.ImageUpload.$modalContainerDiv.empty().append(s.html),this.modal?this.modal.show():(this.modal=new Craft.ImageModal(Craft.ImageUpload.$modalContainerDiv,{postParameters:i.postParameters,cropAction:i.cropAction}),this.modal.imageHandler=this),this.modal.bindButtons(),this.modal.addListener(this.modal.$saveBtn,"click","saveImage"),this.modal.addListener(this.modal.$cancelBtn,"click","cancel"),this.modal.removeListener(Garnish.Modal.$shade,"click"),setTimeout(p.proxy(function(){Craft.ImageUpload.$modalContainerDiv.find("img").load(p.proxy(function(){var t=new Craft.ImageAreaTool(i.areaToolOptions,this.modal);t.showArea(),this.modal.cropAreaTool=t},this))},this),1)))},this)},acceptFileTypes:/(jpg|jpeg|gif|png)/};void 0!==Craft.csrfTokenName&&void 0!==Craft.csrfTokenValue&&(s.formData[Craft.csrfTokenName]=Craft.csrfTokenValue),this.uploader=new Craft.Uploader(t,s),this.addListener(p(i.deleteButton),"click",function(t){confirm(i.deleteMessage)&&(p(t.currentTarget).parent().append('<div class="blocking-modal"></div>'),Craft.postActionRequest(i.deleteAction,i.postParameters,p.proxy(function(t,e){"success"==e&&this.onImageDelete(t)},this)))}),this.addListener(p(i.uploadButton),"click",function(t){p(t.currentTarget).siblings("input[type=file]").trigger("click")})},onImageSave:function(t){this.settings.onImageSave.apply(this,[t])},onImageDelete:function(t){this.settings.onImageDelete.apply(this,[t])},destroy:function(){this.progressBar.destroy(),delete this.progressBar,this.modal&&(this.modal.destroy(),delete this.modal),this.uploader&&(this.uploader.destroy(),delete this.uploader),this.base()}}),Craft.ImageModal=Garnish.Modal.extend({$container:null,$saveBtn:null,$cancelBtn:null,areaSelect:null,source:null,_postParameters:null,_cropAction:"",imageHandler:null,cropAreaTool:null,init:function(t,e){this.cropAreaTool=null,this.base(t,e),this._postParameters=e.postParameters,this._cropAction=e.cropAction},bindButtons:function(){this.$saveBtn=this.$container.find(".submit:first"),this.$cancelBtn=this.$container.find(".cancel:first")},cancel:function(){this.hide(),this.$container.remove(),this.destroy()},saveImage:function(){var t=this.areaSelect.tellSelect(),e={x1:t.x,y1:t.y,x2:t.x2,y2:t.y2,source:this.source};e=p.extend(this._postParameters,e),Craft.postActionRequest(this._cropAction,e,p.proxy(function(t,e){"success"==e&&(t.error?Craft.cp.displayError(t.error):this.imageHandler.onImageSave.apply(this.imageHandler,[t])),this.hide(),this.$container.remove(),this.destroy()},this)),this.areaSelect.setOptions({disable:!0}),this.removeListener(this.$saveBtn,"click"),this.removeListener(this.$cancelBtn,"click"),this.$container.find(".crop-image").fadeTo(50,.5)}}),Craft.ImageAreaTool=Garnish.Base.extend({api:null,$container:null,containingModal:null,init:function(t,e){this.$container=Craft.ImageUpload.$modalContainerDiv,this.setSettings(t),this.containingModal=e},showArea:function(){var o=this.$container.find("img"),t={aspectRatio:this.settings.aspectRatio,maxSize:[o.width(),o.height()],bgColor:"none"},e=p.proxy(function(t){this.api=t;var e=this.settings.initialRectangle.x1,s=this.settings.initialRectangle.x2,i=this.settings.initialRectangle.y1,n=this.settings.initialRectangle.y2;if("auto"==this.settings.initialRectangle.mode){var a=0,r=0;""==this.settings.aspectRatio?(a=o.width(),r=o.height()):1<this.settings.aspectRatio?r=(a=o.width())/this.settings.aspectRatio:this.settings.aspectRatio<1?a=(r=o.height())*this.settings.aspectRatio:r=a=Math.min(o.width(),o.height()),s=(e=Math.round((o.width()-a)/2))+a,n=(i=Math.round((o.height()-r)/2))+r}this.api.setSelect([e,i,s,n]),this.containingModal.areaSelect=this.api,this.containingModal.source=o.attr("src").split("/").pop(),this.containingModal.updateSizeAndPosition()},this);o.Jcrop(t,function(){e(this)})}}),Craft.InfoIcon=Garnish.Base.extend({$icon:null,hud:null,init:function(t){this.$icon=p(t),this.addListener(this.$icon,"click","showHud")},showHud:function(){this.hud?this.hud.show():this.hud=new Garnish.HUD(this.$icon,this.$icon.html(),{hudClass:"hud info-hud",closeOtherHUDs:!1})}}),Craft.LightSwitch=Garnish.Base.extend({settings:null,$outerContainer:null,$innerContainer:null,$input:null,small:!1,on:null,dragger:null,dragStartMargin:null,init:function(t,e){this.$outerContainer=p(t),this.$outerContainer.data("lightswitch")&&(Garnish.log("Double-instantiating a lightswitch on an element"),this.$outerContainer.data("lightswitch").destroy()),this.$outerContainer.data("lightswitch",this),this.small=this.$outerContainer.hasClass("small"),this.setSettings(e,Craft.LightSwitch.defaults),this.$innerContainer=this.$outerContainer.find(".lightswitch-container:first"),this.$input=this.$outerContainer.find("input:first"),this.$input.prop("disabled")||(this.on=this.$outerContainer.hasClass("on"),this.$outerContainer.attr({role:"checkbox","aria-checked":this.on?"true":"false"}),this.addListener(this.$outerContainer,"mousedown","_onMouseDown"),this.addListener(this.$outerContainer,"keydown","_onKeyDown"),this.dragger=new Garnish.BaseDrag(this.$outerContainer,{axis:Garnish.X_AXIS,ignoreHandleSelector:null,onDragStart:p.proxy(this,"_onDragStart"),onDrag:p.proxy(this,"_onDrag"),onDragStop:p.proxy(this,"_onDragStop")}))},turnOn:function(){this.$outerContainer.addClass("dragging");var t={};t["margin-"+Craft.left]=0,this.$innerContainer.velocity("stop").velocity(t,Craft.LightSwitch.animationDuration,p.proxy(this,"_onSettle")),this.$input.val("1"),this.$outerContainer.addClass("on"),this.$outerContainer.attr("aria-checked","true"),this.on!==(this.on=!0)&&this.onChange()},turnOff:function(){this.$outerContainer.addClass("dragging");var t={};t["margin-"+Craft.left]=this._getOffMargin(),this.$innerContainer.velocity("stop").velocity(t,Craft.LightSwitch.animationDuration,p.proxy(this,"_onSettle")),this.$input.val(""),this.$outerContainer.removeClass("on"),this.$outerContainer.attr("aria-checked","false"),this.on!==(this.on=!1)&&this.onChange()},toggle:function(t){this.on?this.turnOff():this.turnOn()},onChange:function(){this.trigger("change"),this.settings.onChange(),this.$outerContainer.trigger("change")},_onMouseDown:function(){this.addListener(Garnish.$doc,"mouseup","_onMouseUp")},_onMouseUp:function(){this.removeListener(Garnish.$doc,"mouseup"),this.dragger.dragging||this.toggle()},_onKeyDown:function(t){switch(t.keyCode){case Garnish.SPACE_KEY:this.toggle(),t.preventDefault();break;case Garnish.RIGHT_KEY:"ltr"==Craft.orientation?this.turnOn():this.turnOff(),t.preventDefault();break;case Garnish.LEFT_KEY:"ltr"==Craft.orientation?this.turnOff():this.turnOn(),t.preventDefault()}},_getMargin:function(){return parseInt(this.$innerContainer.css("margin-"+Craft.left))},_onDragStart:function(){this.$outerContainer.addClass("dragging"),this.dragStartMargin=this._getMargin()},_onDrag:function(){var t;(t="ltr"==Craft.orientation?this.dragStartMargin+this.dragger.mouseDistX:this.dragStartMargin-this.dragger.mouseDistX)<this._getOffMargin()?t=this._getOffMargin():0<t&&(t=0),this.$innerContainer.css("margin-"+Craft.left,t)},_onDragStop:function(){this._getMargin()>this._getOffMargin()/2?this.turnOn():this.turnOff()},_onSettle:function(){this.$outerContainer.removeClass("dragging")},destroy:function(){this.base(),this.dragger.destroy()},_getOffMargin:function(){return this.small?-9:-11}},{animationDuration:100,defaults:{onChange:p.noop}}),Craft.LivePreview=Garnish.Base.extend({$extraFields:null,$trigger:null,$spinner:null,$shade:null,$editorContainer:null,$editor:null,$dragHandle:null,$iframeContainer:null,$iframe:null,$fieldPlaceholder:null,previewUrl:null,basePostData:null,inPreviewMode:!1,fields:null,lastPostData:null,updateIframeInterval:null,loading:!1,checkAgain:!1,dragger:null,dragStartEditorWidth:null,_handleSuccessProxy:null,_handleErrorProxy:null,_scrollX:null,_scrollY:null,_editorWidth:null,_editorWidthInPx:null,init:function(t){this.setSettings(t,Craft.LivePreview.defaults),this.settings.previewUrl?this.previewUrl=this.settings.previewUrl:this.previewUrl=Craft.baseSiteUrl.replace(/\/+$/,"")+"/","https:"==document.location.protocol&&(this.previewUrl=this.previewUrl.replace(/^http:/,"https:")),this.basePostData=p.extend({action:this.settings.previewAction,livePreview:!0},this.settings.previewParams),Craft.csrfTokenName&&(this.basePostData[Craft.csrfTokenName]=Craft.csrfTokenValue),this._handleSuccessProxy=p.proxy(this,"handleSuccess"),this._handleErrorProxy=p.proxy(this,"handleError"),this.$extraFields=p(this.settings.extraFields),this.$trigger=p(this.settings.trigger),this.$spinner=this.settings.spinner?p(this.settings.spinner):this.$trigger.find(".spinner"),this.$fieldPlaceholder=p("<div/>"),this.editorWidth=Craft.getLocalStorage("LivePreview.editorWidth",Craft.LivePreview.defaultEditorWidth),this.addListener(this.$trigger,"activate","toggle"),Craft.cp.on("beforeSaveShortcut",p.proxy(function(){this.inPreviewMode&&this.moveFieldsBack()},this))},get editorWidth(){return this._editorWidth},get editorWidthInPx(){return this._editorWidthInPx},set editorWidth(t){var e;1<=t?(e=t,t/=Garnish.$win.width()):e=Math.round(t*Garnish.$win.width()),e<Craft.LivePreview.minEditorWidthInPx&&(t=(e=Craft.LivePreview.minEditorWidthInPx)/Garnish.$win.width()),this._editorWidth=t,this._editorWidthInPx=e},toggle:function(){this.inPreviewMode?this.exit():this.enter()},enter:function(){if(!this.inPreviewMode){if(this.trigger("beforeEnter"),p(document.activeElement).trigger("blur"),!this.$editor){this.$shade=p('<div class="modal-shade dark"/>').appendTo(Garnish.$bod).css("z-index",2),this.$editorContainer=p('<div class="lp-editor-container"/>').appendTo(Garnish.$bod),this.$editor=p('<div class="lp-editor"/>').appendTo(this.$editorContainer),this.$iframeContainer=p('<div class="lp-iframe-container"/>').appendTo(Garnish.$bod),this.$iframe=p('<iframe class="lp-iframe" frameborder="0"/>').appendTo(this.$iframeContainer),this.$dragHandle=p('<div class="lp-draghandle"/>').appendTo(this.$editorContainer);var t=p('<header class="header"></header>').appendTo(this.$editor),e=p('<div class="btn">'+Craft.t("Close Live Preview")+"</div>").appendTo(t),s=p('<div class="btn submit">'+Craft.t("Save")+"</div>").appendTo(t);this.dragger=new Garnish.BaseDrag(this.$dragHandle,{axis:Garnish.X_AXIS,onDragStart:p.proxy(this,"_onDragStart"),onDrag:p.proxy(this,"_onDrag"),onDragStop:p.proxy(this,"_onDragStop")}),this.addListener(e,"click","exit"),this.addListener(s,"click","save")}this.handleWindowResize(),this.addListener(Garnish.$win,"resize","handleWindowResize"),this.$editorContainer.css(Craft.left,-(this.editorWidthInPx+Craft.LivePreview.dragHandleWidth)+"px"),this.$iframeContainer.css(Craft.right,-this.getIframeWidth()),this.fields=[];for(var i=p(this.settings.fields),n=0;n<i.length;n++){var a=p(i[n]),r=this._getClone(a);this.$fieldPlaceholder.insertAfter(a),a.detach(),this.$fieldPlaceholder.replaceWith(r),a.appendTo(this.$editor),this.fields.push({$field:a,$clone:r})}this.updateIframe()?(this.$spinner.removeClass("hidden"),this.addListener(this.$iframe,"load",function(){this.slideIn(),this.removeListener(this.$iframe,"load")})):this.slideIn(),this.inPreviewMode=!0,this.trigger("enter")}},save:function(){Craft.cp.submitPrimaryForm()},handleWindowResize:function(){this.editorWidth=this.editorWidth,this.updateWidths()},slideIn:function(){p("html").addClass("noscroll"),this.$spinner.addClass("hidden"),this.$shade.velocity("fadeIn"),this.$editorContainer.show().velocity("stop").animateLeft(0,"slow",p.proxy(function(){this.trigger("slideIn"),Garnish.$win.trigger("resize")},this)),this.$iframeContainer.show().velocity("stop").animateRight(0,"slow",p.proxy(function(){this.updateIframeInterval=setInterval(p.proxy(this,"updateIframe"),1e3),this.addListener(Garnish.$bod,"keyup",function(t){t.keyCode==Garnish.ESC_KEY&&this.exit()})},this))},exit:function(){if(this.inPreviewMode){this.trigger("beforeExit"),p("html").removeClass("noscroll"),this.removeListener(Garnish.$win,"resize"),this.removeListener(Garnish.$bod,"keyup"),this.updateIframeInterval&&clearInterval(this.updateIframeInterval),this.moveFieldsBack();Garnish.$win.width();this.$shade.delay(200).velocity("fadeOut"),this.$editorContainer.velocity("stop").animateLeft(-(this.editorWidthInPx+Craft.LivePreview.dragHandleWidth),"slow",p.proxy(function(){for(var t=0;t<this.fields.length;t++)this.fields[t].$newClone.remove();this.$editorContainer.hide(),this.trigger("slideOut")},this)),this.$iframeContainer.velocity("stop").animateRight(-this.getIframeWidth(),"slow",p.proxy(function(){this.$iframeContainer.hide()},this)),this.inPreviewMode=!1,this.trigger("exit")}},moveFieldsBack:function(){for(var t=0;t<this.fields.length;t++){var e=this.fields[t];e.$newClone=this._getClone(e.$field),this.$fieldPlaceholder.insertAfter(e.$field),e.$field.detach(),this.$fieldPlaceholder.replaceWith(e.$newClone),e.$clone.replaceWith(e.$field)}Garnish.$win.trigger("resize")},getIframeWidth:function(){return Garnish.$win.width()-(this.editorWidthInPx+Craft.LivePreview.dragHandleWidth)},updateWidths:function(){this.$editorContainer.css("width",this.editorWidthInPx+"px"),this.$iframeContainer.width(this.getIframeWidth())},updateIframe:function(t){if(t&&(this.lastPostData=null),!this.inPreviewMode)return!1;if(this.loading)return!(this.checkAgain=!0);var e=p.extend(Garnish.getPostData(this.$editor),Garnish.getPostData(this.$extraFields));if(this.lastPostData&&Craft.compare(e,this.lastPostData,!1))return!1;this.lastPostData=e,this.loading=!0;p.extend({},e,this.basePostData);var s=p(this.$iframe[0].contentWindow.document);return this._scrollX=s.scrollLeft(),this._scrollY=s.scrollTop(),p.ajax({url:this.previewUrl,method:"POST",data:p.extend({},e,this.basePostData),xhrFields:{withCredentials:!0},crossDomain:!0,success:this._handleSuccessProxy,error:this._handleErrorProxy}),!0},handleSuccess:function(t,e,s){var i=t+'<script type="text/javascript">window.scrollTo('+this._scrollX+", "+this._scrollY+");<\/script>";this.$iframe.css("background",p(this.$iframe[0].contentWindow.document.body).css("background")),this.$iframe[0].contentWindow.document.open(),this.$iframe[0].contentWindow.document.write(i),this.$iframe[0].contentWindow.document.close(),this.onResponse()},handleError:function(t,e,s){this.onResponse()},onResponse:function(){this.loading=!1,this.checkAgain&&(this.checkAgain=!1,this.updateIframe())},_getClone:function(t){var e=t.clone();return Garnish.copyInputValues(t,e),e.attr("id",""),e.find("[id]").attr("id",""),e},_onDragStart:function(){this.dragStartEditorWidth=this.editorWidthInPx,this.$iframeContainer.addClass("dragging")},_onDrag:function(){"ltr"==Craft.orientation?this.editorWidth=this.dragStartEditorWidth+this.dragger.mouseDistX:this.editorWidth=this.dragStartEditorWidth-this.dragger.mouseDistX,this.updateWidths()},_onDragStop:function(){this.$iframeContainer.removeClass("dragging"),Craft.setLocalStorage("LivePreview.editorWidth",this.editorWidth)}},{defaultEditorWidth:.33,minEditorWidthInPx:320,dragHandleWidth:4,defaults:{trigger:".livepreviewbtn",spinner:null,fields:null,extraFields:null,previewUrl:null,previewAction:null,previewParams:{}}}),Craft.LivePreview.init=function(t){Craft.livePreview=new Craft.LivePreview(t)},Craft.Pane=Garnish.Base.extend({$pane:null,$content:null,$sidebar:null,$tabsContainer:null,tabs:null,selectedTab:null,hasSidebar:null,init:function(t){this.$pane=p(t),this.$pane.data("pane")&&(Garnish.log("Double-instantiating a pane on an element"),this.$pane.data("pane").destroy()),this.$pane.data("pane",this),this.$content=this.$pane.find(".content:not(.hidden):first"),this.$tabsContainer=this.$pane.children(".tabs");var e=this.$tabsContainer.find("a");if(e.length){this.tabs={};for(var s=0;s<e.length;s++){var i=p(e[s]),n=i.attr("href");n&&"#"==n.charAt(0)&&(this.tabs[n]={$tab:i,$target:p(n)},this.addListener(i,"activate","selectTab")),!this.selectedTab&&i.hasClass("sel")&&(this.selectedTab=n)}document.location.hash&&void 0!==this.tabs[document.location.hash]?this.tabs[document.location.hash].$tab.trigger("activate"):this.selectedTab||p(e[0]).trigger("activate")}if(this.$pane.hasClass("meta")){var a=Garnish.findInputs(this.$pane);this.addListener(a,"focus","focusMetaField"),this.addListener(a,"blur","blurMetaField")}this.initContent()},focusMetaField:function(t){p(t.currentTarget).closest(".field").removeClass("has-errors").addClass("has-focus")},blurMetaField:function(t){p(t.currentTarget).closest(".field").removeClass("has-focus")},selectTab:function(t){if(!this.selectedTab||t.currentTarget!=this.tabs[this.selectedTab].$tab[0]){this.deselectTab();var e=p(t.currentTarget).addClass("sel");this.selectedTab=e.attr("href");var s=this.tabs[this.selectedTab].$target;s.removeClass("hidden"),s.hasClass("content")&&(this.$content=s),Garnish.$win.trigger("resize"),Garnish.$doc.trigger("scroll")}},deselectTab:function(){this.selectedTab&&(this.tabs[this.selectedTab].$tab.removeClass("sel"),this.tabs[this.selectedTab].$target.addClass("hidden"))},initContent:function(){this.hasSidebar=this.$content.hasClass("has-sidebar"),this.hasSidebar&&(this.$sidebar=this.$content.children(".sidebar"),this.addListener(this.$content,"resize",function(){this.updateSidebarStyles()}),this.addListener(this.$sidebar,"resize","setMinContentSizeForSidebar"),this.setMinContentSizeForSidebar(),this.addListener(Garnish.$win,"resize","updateSidebarStyles"),this.addListener(Garnish.$win,"scroll","updateSidebarStyles"),this.updateSidebarStyles())},setMinContentSizeForSidebar:function(){this.setMinContentSizeForSidebar._minHeight=this.$sidebar.prop("scrollHeight")-(this.$tabsContainer.height()||0)-48,this.$content.css("min-height",this.setMinContentSizeForSidebar._minHeight)},updateSidebarStyles:function(){this.updateSidebarStyles._styles={},this.updateSidebarStyles._scrollTop=Garnish.$win.scrollTop(),this.updateSidebarStyles._paneOffset=this.$pane.offset().top+(this.$tabsContainer.height()||0),this.updateSidebarStyles._paneHeight=this.$pane.outerHeight()-(this.$tabsContainer.height()||0),this.updateSidebarStyles._windowHeight=Garnish.$win.height(),992<Garnish.$win.width()&&this.updateSidebarStyles._scrollTop>this.updateSidebarStyles._paneOffset?(this.updateSidebarStyles._styles.position="fixed",this.updateSidebarStyles._styles.top="24px"):(this.updateSidebarStyles._styles.position="absolute",this.updateSidebarStyles._styles.top="auto"),this.updateSidebarStyles._styles.maxHeight=Math.min(this.updateSidebarStyles._paneHeight-(this.updateSidebarStyles._scrollTop-this.updateSidebarStyles._paneOffset),this.updateSidebarStyles._windowHeight),this.updateSidebarStyles._paneHeight>this.updateSidebarStyles._windowHeight?this.updateSidebarStyles._styles.height=this.updateSidebarStyles._styles.maxHeight:this.updateSidebarStyles._styles.height=this.updateSidebarStyles._paneHeight,this.$sidebar.css(this.updateSidebarStyles._styles)},destroy:function(){this.base(),this.$pane.data("pane",null)}}),Craft.PasswordInput=Garnish.Base.extend({$passwordInput:null,$textInput:null,$currentInput:null,$showPasswordToggle:null,showingPassword:null,init:function(t,e){this.$passwordInput=p(t),this.settings=p.extend({},Craft.PasswordInput.defaults,e),this.$passwordInput.data("passwordInput")&&(Garnish.log("Double-instantiating a password input on an element"),this.$passwordInput.data("passwordInput").destroy()),this.$passwordInput.data("passwordInput",this),this.$showPasswordToggle=p("<a/>").hide(),this.$showPasswordToggle.addClass("password-toggle"),this.$showPasswordToggle.insertAfter(this.$passwordInput),this.addListener(this.$showPasswordToggle,"mousedown","onToggleMouseDown"),this.hidePassword()},setCurrentInput:function(t){this.$currentInput&&(t.addClass("focus"),this.$currentInput.replaceWith(t),t.trigger("focus"),t.removeClass("focus"),t.val(this.$currentInput.val())),this.$currentInput=t,this.addListener(this.$currentInput,"keypress,keyup,change,blur","onInputChange")},updateToggleLabel:function(t){this.$showPasswordToggle.text(t)},showPassword:function(){this.showingPassword||(this.$textInput||(this.$textInput=this.$passwordInput.clone(!0),this.$textInput.attr("type","text")),this.setCurrentInput(this.$textInput),this.updateToggleLabel(Craft.t("Hide")),this.showingPassword=!0)},hidePassword:function(){!1!==this.showingPassword&&(this.setCurrentInput(this.$passwordInput),this.updateToggleLabel(Craft.t("Show")),this.showingPassword=!1)},togglePassword:function(){this.showingPassword?this.hidePassword():this.showPassword(),this.settings.onToggleInput(this.$currentInput)},onInputChange:function(){this.$currentInput.val()?this.$showPasswordToggle.show():this.$showPasswordToggle.hide()},onToggleMouseDown:function(t){var e,s;t.preventDefault(),this.$currentInput[0].setSelectionRange&&(e=this.$currentInput[0].selectionStart,s=this.$currentInput[0].selectionEnd),this.togglePassword(),this.$currentInput[0].setSelectionRange&&this.$currentInput[0].setSelectionRange(e,s)}},{defaults:{onToggleInput:p.noop}}),Craft.ProgressBar=Garnish.Base.extend({$progressBar:null,$innerProgressBar:null,_itemCount:0,_processedItemCount:0,init:function(t){this.$progressBar=p('<div class="progressbar pending hidden"/>').appendTo(t),this.$innerProgressBar=p('<div class="progressbar-inner"/>').appendTo(this.$progressBar),this.resetProgressBar()},resetProgressBar:function(){this.setProgressPercentage(100),this.$progressBar.addClass("pending"),this.setItemCount(1),this.setProcessedItemCount(0)},hideProgressBar:function(){this.$progressBar.fadeTo("fast",.01,p.proxy(function(){this.$progressBar.addClass("hidden").fadeTo(1,1,p.noop)},this))},showProgressBar:function(){this.$progressBar.removeClass("hidden")},setItemCount:function(t){this._itemCount=t},incrementItemCount:function(t){this._itemCount+=t},setProcessedItemCount:function(t){this._processedItemCount=t},incrementProcessedItemCount:function(t){this._processedItemCount+=t},updateProgressBar:function(){this._itemCount=Math.max(this._itemCount,1);var t=Math.min(100,Math.round(100*this._processedItemCount/this._itemCount));this.setProgressPercentage(t)},setProgressPercentage:function(t,e){0==t?this.$progressBar.addClass("pending"):(this.$progressBar.removeClass("pending"),e?this.$innerProgressBar.velocity("stop").velocity({width:t+"%"},"fast"):this.$innerProgressBar.velocity("stop").width(t+"%"))}}),Craft.PromptHandler=Garnish.Base.extend({$modalContainerDiv:null,$prompt:null,$promptApplyToRemainingContainer:null,$promptApplyToRemainingCheckbox:null,$promptApplyToRemainingLabel:null,$promptButtons:null,_prompts:[],_promptBatchCallback:p.noop,_promptBatchReturnData:[],_promptBatchNum:0,init:function(){},resetPrompts:function(){this._prompts=[],this._promptBatchCallback=p.noop,this._promptBatchReturnData=[],this._promptBatchNum=0},addPrompt:function(t){this._prompts.push(t)},getPromptCount:function(){return this._prompts.length},showBatchPrompts:function(t){this._promptBatchCallback=t,this._promptBatchReturnData=[],this._promptBatchNum=0,this._showNextPromptInBatch()},_showNextPromptInBatch:function(){var t=this._prompts[this._promptBatchNum].prompt,e=this._prompts.length-(this._promptBatchNum+1);this._showPrompt(t.message,t.choices,p.proxy(this,"_handleBatchPromptSelection"),e)},_handleBatchPromptSelection:function(t,e){var s=this._prompts[this._promptBatchNum],i=this._prompts.length-(this._promptBatchNum+1),n=p.extend(s,{choice:t});this._promptBatchReturnData.push(n),i?(this._promptBatchNum++,e?this._handleBatchPromptSelection(t,!0):this._showNextPromptInBatch()):"function"==typeof this._promptBatchCallback&&this._promptBatchCallback(this._promptBatchReturnData)},_showPrompt:function(t,e,s,i){this._promptCallback=s,null==this.modal&&(this.modal=new Garnish.Modal({closeOtherModals:!1})),null==this.$modalContainerDiv&&(this.$modalContainerDiv=p('<div class="modal fitted prompt-modal"></div>').addClass().appendTo(Garnish.$bod)),this.$prompt=p('<div class="body"></div>').appendTo(this.$modalContainerDiv.empty()),this.$promptMessage=p('<p class="prompt-msg"/>').appendTo(this.$prompt),p("<p>").html(Craft.t("What do you want to do?")).appendTo(this.$prompt),this.$promptApplyToRemainingContainer=p('<label class="assets-applytoremaining"/>').appendTo(this.$prompt).hide(),this.$promptApplyToRemainingCheckbox=p('<input type="checkbox"/>').appendTo(this.$promptApplyToRemainingContainer),this.$promptApplyToRemainingLabel=p("<span/>").appendTo(this.$promptApplyToRemainingContainer),this.$promptButtons=p('<div class="buttons"/>').appendTo(this.$prompt),this.modal.setContainer(this.$modalContainerDiv),this.$promptMessage.html(t);for(var n=0;n<e.length;n++){var a=p('<div class="btn" data-choice="'+e[n].value+'">'+e[n].title+"</div>");this.addListener(a,"activate",function(t){var e=t.currentTarget.getAttribute("data-choice"),s=this.$promptApplyToRemainingCheckbox.prop("checked");this._selectPromptChoice(e,s)}),this.$promptButtons.append(a)}i&&(this.$promptApplyToRemainingContainer.show(),this.$promptApplyToRemainingLabel.html(" "+Craft.t("Apply this to the {number} remaining conflicts?",{number:i}))),this.modal.show(),this.modal.removeListener(Garnish.Modal.$shade,"click"),this.addListener(Garnish.Modal.$shade,"click","_cancelPrompt")},_selectPromptChoice:function(t,e){this.$prompt.fadeOut("fast",p.proxy(function(){this.modal.hide(),this._promptCallback(t,e)},this))},_cancelPrompt:function(){this._selectPromptChoice("cancel",!0)}}),Craft.SlugGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(t){t=(t=(t=t.replace(/<(.*?)>/g,"")).replace(/['"‘’“”\[\]\(\)\{\}:]/g,"")).toLowerCase(),Craft.limitAutoSlugsToAscii&&(t=Craft.asciiString(t));var e=Craft.filterArray(XRegExp.matchChain(t,[XRegExp("[\\p{L}\\p{N}\\p{M}]+")]));return e.length?e.join(Craft.slugWordSeparator):""}}),Craft.Structure=Garnish.Base.extend({id:null,$container:null,state:null,structureDrag:null,init:function(t,e,s){this.id=t,this.$container=p(e),this.setSettings(s,Craft.Structure.defaults),this.$container.data("structure")&&(Garnish.log("Double-instantiating a structure on an element"),this.$container.data("structure").destroy()),this.$container.data("structure",this),this.state={},this.settings.storageKey&&p.extend(this.state,Craft.getLocalStorage(this.settings.storageKey,{})),void 0===this.state.collapsedElementIds&&(this.state.collapsedElementIds=[]);for(var i=this.$container.find("ul").prev(".row"),n=0;n<i.length;n++){var a=p(i[n]),r=a.parent(),o=p('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(a);-1!=p.inArray(a.children(".element").data("id"),this.state.collapsedElementIds)&&r.addClass("collapsed"),this.initToggle(o)}this.settings.sortable&&(this.structureDrag=new Craft.StructureDrag(this,this.settings.maxLevels)),this.settings.newChildUrl&&this.initNewChildMenus(this.$container.find(".add"))},initToggle:function(t){t.on("click",p.proxy(function(t){var e=p(t.currentTarget).closest("li"),s=e.children(".row").find(".element:first").data("id"),i=p.inArray(s,this.state.collapsedElementIds);e.hasClass("collapsed")?(e.removeClass("collapsed"),-1!=i&&this.state.collapsedElementIds.splice(i,1)):(e.addClass("collapsed"),-1==i&&this.state.collapsedElementIds.push(s)),this.settings.storageKey&&Craft.setLocalStorage(this.settings.storageKey,this.state)},this))},initNewChildMenus:function(t){this.addListener(t,"click","onNewChildMenuClick")},onNewChildMenuClick:function(t){var e=p(t.currentTarget);if(!e.data("menubtn")){var s=e.parent().children(".element").data("id"),i=Craft.getUrl(this.settings.newChildUrl,"parentId="+s);p('<div class="menu"><ul><li><a href="'+i+'">'+Craft.t("New child")+"</a></li></ul></div>").insertAfter(e);new Garnish.MenuBtn(e).showMenu()}},getIndent:function(t){return Craft.Structure.baseIndent+(t-1)*Craft.Structure.nestedIndent},addElement:function(t){var e=p('<li data-level="1"/>').appendTo(this.$container),s=p('<div class="row" style="margin-'+Craft.left+": -"+Craft.Structure.baseIndent+"px; padding-"+Craft.left+": "+Craft.Structure.baseIndent+'px;">').appendTo(e);if(s.append(t),this.settings.sortable&&(s.append('<a class="move icon" title="'+Craft.t("Move")+'"></a>'),this.structureDrag.addItems(e)),this.settings.newChildUrl){var i=p('<a class="add icon" title="'+Craft.t("New child")+'"></a>').appendTo(s);this.initNewChildMenus(i)}s.css("margin-bottom",-30),s.velocity({"margin-bottom":0},"fast")},removeElement:function(t){var e=t.parent().parent();if(this.settings.sortable&&this.structureDrag.removeItems(e),!e.siblings().length)var s=e.parent();e.css("visibility","hidden").velocity({marginBottom:-e.height()},"fast",p.proxy(function(){e.remove(),void 0!==s&&this._removeUl(s)},this))},_removeUl:function(t){t.siblings(".row").children(".toggle").remove(),t.remove()}},{baseIndent:8,nestedIndent:35,defaults:{storageKey:null,sortable:!1,newChildUrl:null,maxLevels:null}}),Craft.StructureDrag=Garnish.Drag.extend({structure:null,maxLevels:null,draggeeLevel:null,$helperLi:null,$targets:null,draggeeHeight:null,init:function(t,e){this.structure=t,this.maxLevels=e,this.$insertion=p('<li class="draginsertion"/>');var s=this.structure.$container.find("li");this.base(s,{handle:".element:first, .move:first",helper:p.proxy(this,"getHelper")})},getHelper:function(t){this.$helperLi=t;var e=p('<ul class="structure draghelper"/>').append(t);return t.css("padding-"+Craft.left,this.$draggee.css("padding-"+Craft.left)),t.find(".move").removeAttr("title"),e},onDragStart:function(){this.$targets=p(),this.findTargets(this.structure.$container),this.draggeeLevel=0;for(var t=this.$draggee;this.draggeeLevel++,(t=t.find("> ul > li")).length;);this.draggeeHeight=this.$draggee.height(),this.$draggee.velocity({height:0},"fast",p.proxy(function(){this.$draggee.addClass("hidden")},this)),this.base(),this.addListener(Garnish.$doc,"keydown",function(t){t.keyCode==Garnish.ESC_KEY&&this.cancelDrag()})},findTargets:function(t){for(var e=t.children().not(this.$draggee),s=0;s<e.length;s++){var i=p(e[s]);this.$targets=this.$targets.add(i.children(".row")),i.hasClass("collapsed")||this.findTargets(i.children("ul"))}},onDrag:function(){for(this._.$closestTarget&&(this._.$closestTarget.removeClass("draghover"),this.$insertion.remove()),this._.$closestTarget=null,this._.closestTargetPos=null,this._.closestTargetYDiff=null,this._.closestTargetOffset=null,this._.closestTargetHeight=null,this._.i=0;this._.i<this.$targets.length&&(this._.$target=p(this.$targets[this._.i]),this._.targetOffset=this._.$target.offset(),this._.targetHeight=this._.$target.outerHeight(),this._.targetYMidpoint=this._.targetOffset.top+this._.targetHeight/2,this._.targetYDiff=Math.abs(this.mouseY-this._.targetYMidpoint),0==this._.i||this.mouseY>=this._.targetOffset.top+5&&this._.targetYDiff<this._.closestTargetYDiff);this._.i++)this._.$closestTarget=this._.$target,this._.closestTargetPos=this._.i,this._.closestTargetYDiff=this._.targetYDiff,this._.closestTargetOffset=this._.targetOffset,this._.closestTargetHeight=this._.targetHeight;if(this._.$closestTarget)if(0==this._.closestTargetPos&&this.mouseY<this._.closestTargetOffset.top+5)this.$insertion.prependTo(this.structure.$container);else if(this._.$closestTargetLi=this._.$closestTarget.parent(),this._.closestTargetLevel=this._.$closestTargetLi.data("level"),this._.closestTargetPos<this.$targets.length-1?(this._.$nextTargetLi=p(this.$targets[this._.closestTargetPos+1]).parent(),this._.nextTargetLevel=this._.$nextTargetLi.data("level")):(this._.$nextTargetLi=null,this._.nextTargetLevel=null),this._.hoveringBetweenRows=this.mouseY>=this._.closestTargetOffset.top+this._.closestTargetHeight-5,this._.$nextTargetLi&&this._.nextTargetLevel==this._.closestTargetLevel)this._.hoveringBetweenRows?(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel-1)&&this.$insertion.insertAfter(this._.$closestTargetLi):(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass("draghover");else if(this._.$nextTargetLi&&this._.nextTargetLevel>this._.closestTargetLevel)(!this.maxLevels||this.maxLevels>=this._.nextTargetLevel+this.draggeeLevel-1)&&(this._.hoveringBetweenRows?this.$insertion.insertBefore(this._.$nextTargetLi):(this._.$closestTarget.addClass("draghover"),this.$insertion.appendTo(this._.$closestTargetLi.children("ul"))));else if(this._.hoveringBetweenRows){for(this._.draggeeX=this.mouseX-this.targetItemMouseDiffX,"rtl"==Craft.orientation&&(this._.draggeeX+=this.$helperLi.width()),this._.$parentLis=this._.$closestTarget.parentsUntil(this.structure.$container,"li"),this._.$closestParentLi=null,this._.closestParentLiXDiff=null,this._.closestParentLevel=null,this._.i=0;this._.i<this._.$parentLis.length;this._.i++)this._.$parentLi=p(this._.$parentLis[this._.i]),this._.parentLiX=this._.$parentLi.offset().left,"rtl"==Craft.orientation&&(this._.parentLiX+=this._.$parentLi.width()),this._.parentLiXDiff=Math.abs(this._.parentLiX-this._.draggeeX),this._.parentLevel=this._.$parentLi.data("level"),(!this.maxLevels||this.maxLevels>=this._.parentLevel+this.draggeeLevel-1)&&(!this._.$closestParentLi||this._.parentLiXDiff<this._.closestParentLiXDiff&&(!this._.$nextTargetLi||this._.parentLevel>=this._.nextTargetLevel))&&(this._.$closestParentLi=this._.$parentLi,this._.closestParentLiXDiff=this._.parentLiXDiff,this._.closestParentLevel=this._.parentLevel);this._.$closestParentLi&&this.$insertion.insertAfter(this._.$closestParentLi)}else(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass("draghover")},cancelDrag:function(){this.$insertion.remove(),this._.$closestTarget&&this._.$closestTarget.removeClass("draghover"),this.onMouseUp()},onDragStop:function(){if(this._.$closestTarget&&(this.$insertion.parent().length||this._.$closestTarget.hasClass("draghover"))){var t;if(t=this.$draggee.siblings().length?null:this.$draggee.parent(),this.$insertion.parent().length){var e=this.$insertion.next().add(this.$insertion.prev());if(-1==p.inArray(this.$draggee[0],e)){this.$insertion.replaceWith(this.$draggee);var s=!0}else{this.$insertion.remove();s=!1}}else{var i=this._.$closestTargetLi.children("ul");if(t&&i.length&&i[0]==t[0])s=!1;else{if(i.length)this._.$closestTargetLi.hasClass("collapsed")&&this._.$closestTarget.children(".toggle").trigger("click");else{var n=p('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(this._.$closestTarget);this.structure.initToggle(n),i=p("<ul>").appendTo(this._.$closestTargetLi)}this.$draggee.appendTo(i),s=!0}}if(this._.$closestTarget.removeClass("draghover"),s){t&&this.structure._removeUl(t);var a=this.$draggee.parentsUntil(this.structure.$container,"li").length+1;if(a!=this.$draggee.data("level")){if(1==this.$draggee.data("level"))(r={})["padding-"+Craft.left]=38,this.$helperLi.velocity(r,"fast");else if(1==a){var r;(r={})["padding-"+Craft.left]=Craft.Structure.baseIndent,this.$helperLi.velocity(r,"fast")}this.setLevel(this.$draggee,a)}var o=this.$draggee.children(".row").children(".element"),l={structureId:this.structure.id,elementId:o.data("id"),locale:o.data("locale"),prevId:this.$draggee.prev().children(".row").children(".element").data("id"),parentId:this.$draggee.parent("ul").parent("li").children(".row").children(".element").data("id")};Craft.postActionRequest("structures/moveElement",l,function(t,e){"success"==e&&Craft.cp.displayNotice(Craft.t("New order saved."))})}}this.$draggee.velocity("stop").removeClass("hidden").velocity({height:this.draggeeHeight},"fast",p.proxy(function(){this.$draggee.css("height","auto")},this)),this.returnHelpersToDraggees(),this.base()},setLevel:function(t,e){t.data("level",e);var s=this.structure.getIndent(e),i={};i["margin-"+Craft.left]="-"+s+"px",i["padding-"+Craft.left]=s+"px",this.$draggee.children(".row").css(i);for(var n=t.children("ul").children(),a=0;a<n.length;a++)this.setLevel(p(n[a]),e+1)}}),Craft.StructureTableSorter=Garnish.DragSort.extend({tableView:null,structureId:null,maxLevels:null,_helperMargin:null,_$firstRowCells:null,_$titleHelperCell:null,_titleHelperCellOuterWidth:null,_ancestors:null,_updateAncestorsFrame:null,_updateAncestorsProxy:null,_draggeeLevel:null,_draggeeLevelDelta:null,draggingLastElements:null,_loadingDraggeeLevelDelta:!1,_targetLevel:null,_targetLevelBounds:null,_positionChanged:null,init:function(t,e,s){this.tableView=t,this.structureId=this.tableView.$table.data("structure-id"),this.maxLevels=parseInt(this.tableView.$table.attr("data-max-levels")),s=p.extend({},Craft.StructureTableSorter.defaults,s,{handle:".move",collapseDraggees:!0,singleHelper:!0,helperSpacingY:2,magnetStrength:4,helper:p.proxy(this,"getHelper"),helperLagBase:1.5,axis:Garnish.Y_AXIS}),this.base(e,s)},startDragging:function(){this._helperMargin=Craft.StructureTableSorter.HELPER_MARGIN+(this.tableView.elementIndex.actions?24:0),this.base()},findDraggee:function(){this._draggeeLevel=this._targetLevel=this.$targetItem.data("level"),this._draggeeLevelDelta=0;for(var t=p(this.$targetItem),e=this.$targetItem.next();e.length;){var s=e.data("level");if(s<=this._draggeeLevel)break;var i=s-this._draggeeLevel;i>this._draggeeLevelDelta&&(this._draggeeLevelDelta=i),t=t.add(e),e=e.next()}if(this.draggingLastElements=!e.length,this.maxLevels&&this.draggingLastElements&&this.tableView.getMorePending()){this._loadingDraggeeLevelDelta=!0;var n=this._getAjaxBaseData(this.$targetItem);Craft.postActionRequest("structures/getElementLevelDelta",n,p.proxy(function(t,e){"success"==e&&(this._loadingDraggeeLevelDelta=!1,this.dragging&&(this._draggeeLevelDelta=t.delta,this.drag(!1)))},this))}return t},getHelper:function(t){var e=p('<div class="elements datatablesorthelper"/>').appendTo(Garnish.$bod),s=p('<div class="tableview"/>').appendTo(e),i=p('<table class="data"/>').appendTo(s),n=p("<tbody/>").appendTo(i);t.appendTo(n),this._$firstRowCells=this.tableView.$elementContainer.children("tr:first").children();for(var a=t.children(),r=0;r<a.length;r++){var o=p(a[r]);if(o.hasClass("checkbox-cell"))o.remove();else{var l=p(this._$firstRowCells[r]),h=l.width();if(l.width(h),o.width(h),Garnish.hasAttr(l,"data-titlecell")){this._$titleHelperCell=o;var d=parseInt(l.css("padding-"+Craft.left));this._titleHelperCellOuterWidth=h+d-(this.tableView.elementIndex.actions?12:0),o.css("padding-"+Craft.left,Craft.StructureTableSorter.BASE_PADDING)}}}return e},canInsertBefore:function(t){return!this._loadingDraggeeLevelDelta&&!1!==this._getLevelBounds(t.prev(),t)},canInsertAfter:function(t){return!this._loadingDraggeeLevelDelta&&!1!==this._getLevelBounds(t,t.next())},onDragStart:function(){this._ancestors=this._getAncestors(this.$targetItem,this.$targetItem.data("level")),this._setTargetLevelBounds(),this.tableView.maybeLoadMore(),this.base()},onDrag:function(){this.base(),this._updateIndent()},onInsertionPointChange:function(){this._setTargetLevelBounds(),this._updateAncestorsBeforeRepaint(),this.base()},onDragStop:function(){if(this._positionChanged=!1,this.base(),this._targetLevel!=this._draggeeLevel){for(var t=this._targetLevel-this._draggeeLevel,e=0;e<this.$draggee.length;e++){var s=p(this.$draggee[e]),i=s.data("level")+t,n=Craft.StructureTableSorter.BASE_PADDING+(this.tableView.elementIndex.actions?7:0)+this._getLevelIndent(i);s.data("level",i),s.find(".element").data("level",i),s.children("[data-titlecell]:first").css("padding-"+Craft.left,n)}this._positionChanged=!0}if(this._positionChanged){for(var a=this._getAjaxBaseData(this.$draggee),r=this.$draggee.first().prev();r.length;){var o=r.data("level");if(o==this._targetLevel){a.prevId=r.data("id");break}if(o<this._targetLevel){a.parentId=r.data("id");var l=r.find("> td > .toggle");if(!l.hasClass("expanded")){l.addClass("expanded");var h=this.tableView._createSpinnerRowAfter(r);this.tableView.elementSelect&&this.tableView.elementSelect.removeItems(this.$targetItem),this.removeItems(this.$targetItem),this.$targetItem.remove(),this.tableView._totalVisible--}break}r=r.prev()}Craft.postActionRequest("structures/moveElement",a,p.proxy(function(t,e){"success"==e&&(Craft.cp.displayNotice(Craft.t("New position saved.")),this.onPositionChange(),h&&h.parent().length&&(h.remove(),this.tableView._expandElement(l,!0)),Craft.cp.runPendingTasks())},this))}},onSortChange:function(){this.tableView.elementSelect&&this.tableView.elementSelect.resetItemOrder(),this._positionChanged=!0,this.base()},onPositionChange:function(){Garnish.requestAnimationFrame(p.proxy(function(){this.trigger("positionChange"),this.settings.onPositionChange()},this))},onReturnHelpersToDraggees:function(){if(this._$firstRowCells.css("width",""),this.draggingLastElements&&this.tableView.getMorePending()){this.tableView._totalVisible+=this.newDraggeeIndexes[0]-this.oldDraggeeIndexes[0];var t=this.$draggee.last().nextAll();t.length&&(this.removeItems(t),t.remove(),this.tableView.maybeLoadMore())}this.base()},_getLevelBounds:function(t,e){if(e&&e.length?this._getLevelBounds._minLevel=e.data("level"):this._getLevelBounds._minLevel=1,t&&t.length?this._getLevelBounds._maxLevel=t.data("level")+1:this._getLevelBounds._maxLevel=1,this.maxLevels){if(1!=this._getLevelBounds._minLevel&&this._getLevelBounds._minLevel+this._draggeeLevelDelta>this.maxLevels)return!1;this._getLevelBounds._maxLevel+this._draggeeLevelDelta>this.maxLevels&&(this._getLevelBounds._maxLevel=this.maxLevels-this._draggeeLevelDelta,this._getLevelBounds._maxLevel<this._getLevelBounds._minLevel&&(this._getLevelBounds._maxLevel=this._getLevelBounds._minLevel))}return{min:this._getLevelBounds._minLevel,max:this._getLevelBounds._maxLevel}},_setTargetLevelBounds:function(){this._targetLevelBounds=this._getLevelBounds(this.$draggee.first().prev(),this.$draggee.last().next())},_updateIndent:function(t){this._updateIndent._mouseDist=this.realMouseX-this.mousedownX,"rtl"==Craft.orientation&&(this._updateIndent._mouseDist*=-1),this._updateIndent._indentationDist=Math.round(this._updateIndent._mouseDist/Craft.StructureTableSorter.LEVEL_INDENT),this._updateIndent._targetLevel=this._draggeeLevel+this._updateIndent._indentationDist,this._updateIndent._targetLevel<this._targetLevelBounds.min?(this._updateIndent._indentationDist+=this._targetLevelBounds.min-this._updateIndent._targetLevel,this._updateIndent._targetLevel=this._targetLevelBounds.min):this._updateIndent._targetLevel>this._targetLevelBounds.max&&(this._updateIndent._indentationDist-=this._updateIndent._targetLevel-this._targetLevelBounds.max,this._updateIndent._targetLevel=this._targetLevelBounds.max),this._targetLevel!==(this._targetLevel=this._updateIndent._targetLevel)&&this._updateAncestorsBeforeRepaint(),this._updateIndent._targetLevelMouseDiff=this._updateIndent._mouseDist-this._updateIndent._indentationDist*Craft.StructureTableSorter.LEVEL_INDENT,this._updateIndent._magnetImpact=Math.round(this._updateIndent._targetLevelMouseDiff/15),Math.abs(this._updateIndent._magnetImpact)>Craft.StructureTableSorter.MAX_GIVE&&(this._updateIndent._magnetImpact=(0<this._updateIndent._magnetImpact?1:-1)*Craft.StructureTableSorter.MAX_GIVE),this._updateIndent._closestLevelMagnetIndent=this._getLevelIndent(this._targetLevel)+this._updateIndent._magnetImpact,this.helpers[0].css("margin-"+Craft.left,this._updateIndent._closestLevelMagnetIndent+this._helperMargin),this._$titleHelperCell.width(this._titleHelperCellOuterWidth-(this._updateIndent._closestLevelMagnetIndent+Craft.StructureTableSorter.BASE_PADDING))},_getLevelIndent:function(t){return(t-1)*Craft.StructureTableSorter.LEVEL_INDENT},_getAjaxBaseData:function(t){return{structureId:this.structureId,elementId:t.data("id"),locale:t.find(".element:first").data("locale")}},_getAncestors:function(t,e){if(this._getAncestors._ancestors=[],0!=e)for(this._getAncestors._level=e,this._getAncestors._$prevRow=t.prev();this._getAncestors._$prevRow.length&&!(this._getAncestors._$prevRow.data("level")<this._getAncestors._level&&(this._getAncestors._ancestors.unshift(this._getAncestors._$prevRow),this._getAncestors._level=this._getAncestors._$prevRow.data("level"),0==this._getAncestors._level));)this._getAncestors._$prevRow=this._getAncestors._$prevRow.prev();return this._getAncestors._ancestors},_updateAncestorsBeforeRepaint:function(){this._updateAncestorsFrame&&Garnish.cancelAnimationFrame(this._updateAncestorsFrame),this._updateAncestorsProxy||(this._updateAncestorsProxy=p.proxy(this,"_updateAncestors")),this._updateAncestorsFrame=Garnish.requestAnimationFrame(this._updateAncestorsProxy)},_updateAncestors:function(){for(this._updateAncestorsFrame=null,this._updateAncestors._i=0;this._updateAncestors._i<this._ancestors.length;this._updateAncestors._i++)this._updateAncestors._$ancestor=this._ancestors[this._updateAncestors._i],this._updateAncestors._$ancestor.data("descendants",this._updateAncestors._$ancestor.data("descendants")-1),0==this._updateAncestors._$ancestor.data("descendants")&&this._updateAncestors._$ancestor.find("> td > .toggle:first").remove();for(this._updateAncestors._newAncestors=this._getAncestors(this.$targetItem,this._targetLevel),this._updateAncestors._i=0;this._updateAncestors._i<this._updateAncestors._newAncestors.length;this._updateAncestors._i++)this._updateAncestors._$ancestor=this._updateAncestors._newAncestors[this._updateAncestors._i],this._updateAncestors._$ancestor.data("descendants",this._updateAncestors._$ancestor.data("descendants")+1),1==this._updateAncestors._$ancestor.data("descendants")&&p('<span class="toggle expanded" title="'+Craft.t("Show/hide children")+'"></span>').insertAfter(this._updateAncestors._$ancestor.find("> td .move:first"));this._ancestors=this._updateAncestors._newAncestors,delete this._updateAncestors._i,delete this._updateAncestors._$ancestor,delete this._updateAncestors._newAncestors}},{BASE_PADDING:36,HELPER_MARGIN:-7,LEVEL_INDENT:44,MAX_GIVE:22,defaults:{onPositionChange:p.noop}}),Craft.TableElementIndexView=Craft.BaseElementIndexView.extend({$table:null,$selectedSortHeader:null,structureTableSort:null,_totalVisiblePostStructureTableDraggee:null,_morePendingPostStructureTableDraggee:!1,getElementContainer:function(){return this.$table=this.$container.find("table:first"),this.$table.children("tbody:first")},afterInit:function(){Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.add(this.$table),Craft.cp.updateResponsiveTables(),this.initTableHeaders(),"index"==this.elementIndex.settings.context&&"structure"==this.elementIndex.getSelectedSortAttribute()&&Garnish.hasAttr(this.$table,"data-structure-id")?this.structureTableSort=new Craft.StructureTableSorter(this,this.getAllElements(),{onSortChange:p.proxy(this,"_onStructureTableSortChange")}):this.structureTableSort=null,"structure"==this.elementIndex.getSelectedSortAttribute()&&this.addListener(this.$elementContainer,"click",function(t){var e=p(t.target);e.hasClass("toggle")&&!1===this._collapseElement(e)&&this._expandElement(e)})},initTableHeaders:function(){for(var t=this.elementIndex.getSelectedSortAttribute(),e=this.$table.children("thead").children().children("[data-attribute]"),s=0;s<e.length;s++){var i=e.eq(s),n=i.attr("data-attribute");if(n==t){this.$selectedSortHeader=i;var a=this.elementIndex.getSelectedSortDirection();i.addClass("ordered "+a).on("click",p.proxy(this,"_handleSelectedSortHeaderClick"))}else{this.elementIndex.getSortAttributeOption(n).length&&i.addClass("orderable").on("click",p.proxy(this,"_handleUnselectedSortHeaderClick"))}}},isVerticalList:function(){return!0},getTotalVisible:function(){return this._isStructureTableDraggingLastElements()?this._totalVisiblePostStructureTableDraggee:this._totalVisible},setTotalVisible:function(t){this._isStructureTableDraggingLastElements()?this._totalVisiblePostStructureTableDraggee=t:this._totalVisible=t},getMorePending:function(){return this._isStructureTableDraggingLastElements()?this._morePendingPostStructureTableDraggee:this._morePending},setMorePending:function(t){this._isStructureTableDraggingLastElements()?this._morePendingPostStructureTableDraggee=t:this._morePending=this._morePendingPostStructureTableDraggee=t},getLoadMoreParams:function(){var t=this.base();return this._isStructureTableDraggingLastElements()&&(t.criteria.positionedAfter=this.structureTableSort.$targetItem.data("id")),t},appendElements:function(t){this.base(t),this.structureTableSort&&this.structureTableSort.addItems(t),Craft.cp.updateResponsiveTables()},createElementEditor:function(e){new Craft.ElementEditor(e,{params:{includeTableAttributesForSource:this.elementIndex.sourceKey},onSaveElement:p.proxy(function(t){t.tableAttributes&&this._updateTableAttributes(e,t.tableAttributes)},this)})},destroy:function(){this.$table&&(Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.not(this.$table)),this.base()},_collapseElement:function(t,e){if(!e&&!t.hasClass("expanded"))return!1;t.removeClass("expanded");for(var s=t.parent().parent(),i=s.data("id"),n=s.data("level"),a=s.next();a.length;){if(!Garnish.hasAttr(a,"data-spinnerrow")){if(a.data("level")<=n)break;this.elementSelect&&this.elementSelect.removeItems(a),this.structureTableSort&&this.structureTableSort.removeItems(a),this._totalVisible--}var r=a.next();a.remove(),a=r}this.elementIndex.instanceState.collapsedElementIds||(this.elementIndex.instanceState.collapsedElementIds=[]),this.elementIndex.instanceState.collapsedElementIds.push(i),this.elementIndex.setInstanceState("collapsedElementIds",this.elementIndex.instanceState.collapsedElementIds),this.maybeLoadMore()},_expandElement:function(t,e){if(!e&&t.hasClass("expanded"))return!1;if(t.addClass("expanded"),this.elementIndex.instanceState.collapsedElementIds){var s=t.parent().parent(),i=s.data("id"),n=p.inArray(i,this.elementIndex.instanceState.collapsedElementIds);if(-1!=n){this.elementIndex.instanceState.collapsedElementIds.splice(n,1),this.elementIndex.setInstanceState("collapsedElementIds",this.elementIndex.instanceState.collapsedElementIds);var r=this._createSpinnerRowAfter(s),a=p.extend(!0,{},this.settings.params);a.criteria.descendantOf=i,Craft.postActionRequest("elementIndex/getMoreElements",a,p.proxy(function(t,e){if(r.parent().length&&"success"==e){var s=p(t.html),i=this._totalVisible+s.length,n=this.settings.batchSize&&s.length==this.settings.batchSize;if(n){var a=r.nextAll();this.elementSelect&&this.elementSelect.removeItems(a),this.structureTableSort&&this.structureTableSort.removeItems(a),a.remove(),i-=a.length}else n=this._morePending;r.replaceWith(s),(this.elementIndex.actions||this.settings.selectable)&&(this.elementSelect.addItems(s.filter(":not(.disabled)")),this.elementIndex.updateActionTriggers()),this.structureTableSort&&this.structureTableSort.addItems(s),Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),Craft.cp.updateResponsiveTables(),this.setTotalVisible(i),this.setMorePending(n),this.maybeLoadMore()}},this))}}},_createSpinnerRowAfter:function(t){return p('<tr data-spinnerrow><td class="centeralign" colspan="'+t.children().length+'"><div class="spinner"/></td></tr>').insertAfter(t)},_isStructureTableDraggingLastElements:function(){return this.structureTableSort&&this.structureTableSort.dragging&&this.structureTableSort.draggingLastElements},_handleSelectedSortHeaderClick:function(t){var e=p(t.currentTarget);if(!e.hasClass("loading")){var s="asc"==this.elementIndex.getSelectedSortDirection()?"desc":"asc";this.elementIndex.setSortDirection(s),this._handleSortHeaderClick(t,e)}},_handleUnselectedSortHeaderClick:function(t){var e=p(t.currentTarget);if(!e.hasClass("loading")){var s=e.attr("data-attribute");this.elementIndex.setSortAttribute(s),this._handleSortHeaderClick(t,e)}},_handleSortHeaderClick:function(t,e){this.$selectedSortHeader&&this.$selectedSortHeader.removeClass("ordered asc desc"),e.removeClass("orderable").addClass("ordered loading"),this.elementIndex.storeSortAttributeAndDirection(),this.elementIndex.updateElements(),this.elementIndex.setIndexAvailable()},_updateTableAttributes:function(t,e){var s=t.closest("tr");for(var i in e)s.children('td[data-attr="'+i+'"]:first').html(e[i])}}),Craft.TagSelectInput=Craft.BaseElementSelectInput.extend({searchTimeout:null,searchMenu:null,$container:null,$elementsContainer:null,$elements:null,$addTagInput:null,$spinner:null,_ignoreBlur:!1,init:function(t){if(!p.isPlainObject(t)){for(var e={},s=["id","name","tagGroupId","sourceElementId"],i=0;i<s.length&&void 0!==arguments[i];i++)e[s[i]]=arguments[i];t=e}this.base(p.extend({},Craft.TagSelectInput.defaults,t)),this.$addTagInput=this.$container.children(".add").children(".text"),this.$spinner=this.$addTagInput.next(),this.addListener(this.$addTagInput,"textchange",p.proxy(function(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(p.proxy(this,"searchForTags"),500)},this)),this.addListener(this.$addTagInput,"keypress",function(t){t.keyCode==Garnish.RETURN_KEY&&(t.preventDefault(),this.searchMenu&&this.selectTag(this.searchMenu.$options[0]))}),this.addListener(this.$addTagInput,"focus",function(){this.searchMenu&&this.searchMenu.show()}),this.addListener(this.$addTagInput,"blur",function(){this._ignoreBlur?this._ignoreBlur=!1:setTimeout(p.proxy(function(){this.searchMenu&&this.searchMenu.hide()},this),1)})},getAddElementsBtn:p.noop,getElementSortAxis:function(){return null},searchForTags:function(){if(this.searchMenu&&this.killSearchMenu(),this.$addTagInput.val()){this.$spinner.removeClass("hidden");for(var t=[],e=0;e<this.$elements.length;e++){var s=p(this.$elements[e]).data("id");s&&t.push(s)}this.settings.sourceElementId&&t.push(this.settings.sourceElementId);var r={search:this.$addTagInput.val(),tagGroupId:this.settings.tagGroupId,excludeIds:t};Craft.postActionRequest("tags/searchForTags",r,p.proxy(function(t,e){if(this.searchMenu&&this.killSearchMenu(),this.$spinner.addClass("hidden"),"success"==e){for(var s=p('<div class="menu tagmenu"/>').appendTo(Garnish.$bod),i=p("<ul/>").appendTo(s),n=0;n<t.tags.length;n++){var a=p("<li/>").appendTo(i);p('<a data-icon="tag"/>').appendTo(a).text(t.tags[n].title).data("id",t.tags[n].id)}if(!t.exactMatch){a=p("<li/>").appendTo(i);p('<a data-icon="+"/>').appendTo(a).text(r.search)}i.find("> li:first-child > a").addClass("hover"),this.searchMenu=new Garnish.Menu(s,{attachToElement:this.$addTagInput,onOptionSelect:p.proxy(this,"selectTag")}),this.addListener(s,"mousedown",p.proxy(function(){this._ignoreBlur=!0},this)),this.searchMenu.show()}},this))}else this.$spinner.addClass("hidden")},selectTag:function(t){var e=p(t),s=e.data("id"),i=e.text(),n=p('<div class="element small removable" data-id="'+s+'" data-editable/>').appendTo(this.$elementsContainer),a=p('<input type="hidden" name="'+this.settings.name+'[]" value="'+s+'"/>').appendTo(n);p('<a class="delete icon" title="'+Craft.t("Remove")+'"></a>').appendTo(n),p('<span class="label"/>').text(i).appendTo(n);var r=-(n.outerWidth()+10);this.$addTagInput.css("margin-"+Craft.left,r+"px");var o={};if(o["margin-"+Craft.left]=0,this.$addTagInput.velocity(o,"fast"),this.$elements=this.$elements.add(n),this.addElements(n),this.killSearchMenu(),this.$addTagInput.val(""),this.$addTagInput.trigger("focus"),!s){n.addClass("loading disabled");var l={groupId:this.settings.tagGroupId,title:i};Craft.postActionRequest("tags/createTag",l,p.proxy(function(t,e){"success"==e&&t.success?(n.attr("data-id",t.id),a.val(t.id),n.removeClass("loading disabled")):(this.removeElement(n),"success"==e&&Craft.cp.displayError(Craft.t("An unknown error occurred.")))},this))}},killSearchMenu:function(){this.searchMenu.hide(),this.searchMenu.destroy(),this.searchMenu=null}},{defaults:{tagGroupId:null}}),Craft.ThumbsElementIndexView=Craft.BaseElementIndexView.extend({getElementContainer:function(){return this.$container.children("ul")}}),Craft.ui={createTextInput:function(t){var e=p("<input/>",{class:"text",type:t.type||"text",id:t.id,size:t.size,name:t.name,value:t.value,maxlength:t.maxlength,"data-show-chars-left":t.showCharsLeft,autofocus:this.getAutofocusValue(t.autofocus),autocomplete:void 0!==t.autocomplete&&t.autocomplete?null:"off",disabled:this.getDisabledValue(t.disabled),readonly:t.readonly,title:t.title,placeholder:t.placeholder});return t.class&&e.addClass(t.class),t.placeholder&&e.addClass("nicetext"),"password"==t.type&&e.addClass("password"),t.disabled&&e.addClass("disabled"),t.size||e.addClass("fullwidth"),t.showCharsLeft&&t.maxlength&&e.css("padding-"+("ltr"==Craft.orientation?"right":"left"),7.2*t.maxlength.toString().length+14+"px"),(t.placeholder||t.showCharsLeft)&&new Garnish.NiceText(e),"password"==t.type?p('<div class="passwordwrapper"/>').append(e):e},createTextField:function(t){return this.createField(this.createTextInput(t),t)},createCheckbox:function(t){var e=t.id||"checkbox"+Math.floor(1e9*Math.random()),s=p("<input/>",{type:"checkbox",value:void 0!==t.value?t.value:"1",id:e,class:"checkbox",name:t.name,checked:t.checked?"checked":null,autofocus:this.getAutofocusValue(t.autofocus),disabled:this.getDisabledValue(t.disabled),"data-target":t.toggle,"data-reverse-target":t.reverseToggle});t.class&&s.addClass(t.class),(t.toggle||t.reverseToggle)&&(s.addClass("fieldtoggle"),new Craft.FieldToggle(s));var i=p("<label/>",{for:e,text:t.label});return t.name&&(t.name.length<3||"[]"!=t.name.substr(-2))?p([p("<input/>",{type:"hidden",name:t.name,value:""})[0],s[0],i[0]]):p([s[0],i[0]])},createCheckboxField:function(t){var e=p('<div class="field checkboxfield"/>',{id:cofig.id?t.id+"-field":null});return t.first&&e.addClass("first"),t.instructions&&e.addClass("has-instructions"),this.createCheckbox(t).appendTo(e),t.instructions&&p('<div class="instructions"/>').text(t.instructions).appendTo(e),e},createCheckboxSelect:function(t){var e=t.allValue||"*",s=!t.values||t.values==t.allValue,i=p('<div class="checkbox-select"/>');t.class&&i.addClass(t.class),p("<div/>").appendTo(i).append(this.createCheckbox({id:t.id,class:"all",label:"<b>"+(t.allLabel||Craft.t("All"))+"</b>",name:t.name,value:e,checked:s,autofocus:t.autofocus}));for(var n=0;n<t.options.length;n++){var a=t.options[n];a.value!=e&&p("<div/>").appendTo(i).append(this.createCheckbox({label:a.label,name:t.name?t.name+"[]":null,value:a.value,checked:s||Craft.inArray(a.value,t.values),disabled:s}))}return new Garnish.CheckboxSelect(i),i},createCheckboxSelectField:function(t){return this.createField(this.createCheckboxSelect(t),t)},createField:function(t,e){var s=e.label&&"__blank__"!=e.label?e.label:null,i=Craft.isLocalized&&e.locale?e.locale:null,n=p("<div/>",{class:"field",id:e.fieldId||(e.id?e.id+"-field":null)});if(e.first&&n.addClass("first"),s||e.instructions){var a=p('<div class="heading"/>').appendTo(n);if(s){var r=p("<label/>",{id:e.labelId||(e.id?e.id+"-label":null),class:e.required?"required":null,for:e.id,text:s}).appendTo(a);i&&p('<span class="locale"/>').text(i).appendTo(r)}e.instructions&&p('<div class="instructions"/>').text(e.instructions).appendTo(a)}return p('<div class="input"/>').append(t).appendTo(n),e.warning&&p('<p class="warning"/>').text(e.warning).appendTo(n),e.errors&&this.addErrorsToField(n,e.errors),n},createErrorList:function(t){var e=p('<ul class="errors"/>');return t&&this.addErrorsToList(e,t),e},addErrorsToList:function(t,e){for(var s=0;s<e.length;s++)p("<li/>").text(e[s]).appendTo(t)},addErrorsToField:function(t,e){if(e){t.addClass("has-errors"),t.children(".input").addClass("errors");var s=t.children("ul.errors");s.length||(s=this.createErrorList().appendTo(t)),this.addErrorsToList(s,e)}},clearErrorsFromField:function(t){t.removeClass("has-errors"),t.children(".input").removeClass("errors"),t.children("ul.errors").remove()},getAutofocusValue:function(t){return t&&!Garnish.isMobileBrowser(!0)?"autofocus":null},getDisabledValue:function(t){return t?"disabled":null}},Craft.UpgradeModal=Garnish.Modal.extend({$container:null,$body:null,$compareScreen:null,$checkoutScreen:null,$successScreen:null,$checkoutForm:null,$checkoutLogo:null,$checkoutSubmitBtn:null,$checkoutSpinner:null,$checkoutFormError:null,$checkoutSecure:null,clearCheckoutFormTimeout:null,$customerNameInput:null,$customerEmailInput:null,$ccField:null,$ccNumInput:null,$ccExpInput:null,$ccCvcInput:null,$businessFieldsToggle:null,$businessNameInput:null,$businessAddress1Input:null,$businessAddress2Input:null,$businessCityInput:null,$businessStateInput:null,$businessCountryInput:null,$businessZipInput:null,$businessTaxIdInput:null,$purchaseNotesInput:null,$couponInput:null,$couponSpinner:null,submittingPurchase:!1,stripePublicKey:null,editions:null,countries:null,states:null,edition:null,initializedCheckoutForm:!1,applyingCouponCode:!1,applyNewCouponCodeAfterDoneLoading:!1,couponPrice:null,formattedCouponPrice:null,init:function(t){this.$container=p('<div id="upgrademodal" class="modal loading"/>').appendTo(Garnish.$bod),this.base(this.$container,p.extend({resizable:!0},t)),Craft.postActionRequest("app/getUpgradeModal",p.proxy(function(t,e){if(this.$container.removeClass("loading"),"success"==e){if(t.success){this.stripePublicKey=t.stripePublicKey,this.editions=t.editions,this.countries=t.countries,this.states=t.states,this.$container.append(t.modalHtml),this.$container.append('<script type="text/javascript" src="'+Craft.getResourceUrl("lib/jquery.payment"+(Craft.useCompressedJs?".min":"")+".js")+'"><\/script>'),this.$compareScreen=this.$container.children("#upgrademodal-compare"),this.$checkoutScreen=this.$container.children("#upgrademodal-checkout"),this.$successScreen=this.$container.children("#upgrademodal-success"),this.$checkoutLogo=this.$checkoutScreen.find(".logo:first"),this.$checkoutForm=this.$checkoutScreen.find("form:first"),this.$checkoutSubmitBtn=this.$checkoutForm.find("#pay-button"),this.$checkoutSpinner=this.$checkoutForm.find("#pay-spinner"),this.$customerNameInput=this.$checkoutForm.find("#customer-name"),this.$customerEmailInput=this.$checkoutForm.find("#customer-email"),this.$ccField=this.$checkoutForm.find("#cc-inputs"),this.$ccNumInput=this.$ccField.find("#cc-num"),this.$ccExpInput=this.$ccField.find("#cc-exp"),this.$ccCvcInput=this.$ccField.find("#cc-cvc"),this.$businessFieldsToggle=this.$checkoutForm.find(".fieldtoggle"),this.$businessNameInput=this.$checkoutForm.find("#business-name"),this.$businessAddress1Input=this.$checkoutForm.find("#business-address1"),this.$businessAddress2Input=this.$checkoutForm.find("#business-address2"),this.$businessCityInput=this.$checkoutForm.find("#business-city"),this.$businessStateInput=this.$checkoutForm.find("#business-state"),this.$businessCountryInput=this.$checkoutForm.find("#business-country"),this.$businessZipInput=this.$checkoutForm.find("#business-zip"),this.$businessTaxIdInput=this.$checkoutForm.find("#business-taxid"),this.$purchaseNotesInput=this.$checkoutForm.find("#purchase-notes"),this.$checkoutSecure=this.$checkoutScreen.find(".secure:first"),this.$couponInput=this.$checkoutForm.find("#coupon-input"),this.$couponSpinner=this.$checkoutForm.find("#coupon-spinner");var s=this.$compareScreen.find(".buybtn");this.addListener(s,"click","onBuyBtnClick");var i=this.$compareScreen.find(".btn.test");this.addListener(i,"click","onTestBtnClick");var n=this.$checkoutScreen.find("#upgrademodal-cancelcheckout");this.addListener(n,"click","cancelCheckout")}else{var a;a=t.error?t.error:Craft.t("An unknown error occurred."),this.$container.append('<div class="body">'+a+"</div>")}p('<script type="text/javascript" src="https://js.stripe.com/v1/"><\/script>').appendTo(Garnish.$bod)}},this))},initializeCheckoutForm:function(){this.$ccNumInput.payment("formatCardNumber"),this.$ccExpInput.payment("formatCardExpiry"),this.$ccCvcInput.payment("formatCardCVC"),this.$businessFieldsToggle.fieldtoggle(),this.$businessCountryInput.selectize({valueField:"iso",labelField:"name",searchField:["name","iso"],dropdownParent:"body",inputClass:"selectize-input text"}),this.$businessCountryInput[0].selectize.addOption(this.countries),this.$businessCountryInput[0].selectize.refreshOptions(!1),this.$businessStateInput.selectize({valueField:"abbr",labelField:"name",searchField:["name","abbr"],dropdownParent:"body",inputClass:"selectize-input text",create:!0}),this.$businessStateInput[0].selectize.addOption(this.states),this.$businessStateInput[0].selectize.refreshOptions(!1),this.addListener(this.$couponInput,"textchange",{delay:500},"applyCoupon"),this.addListener(this.$checkoutForm,"submit","submitPurchase")},applyCoupon:function(){if(this.applyingCouponCode)this.applyNewCouponCodeAfterDoneLoading=!0;else{var t=this.$couponInput.val();if(t){var e={edition:this.edition,couponCode:t};this.applyingCouponCode=!0,this.$couponSpinner.removeClass("hidden"),Craft.postActionRequest("app/getCouponPrice",e,p.proxy(function(t,e){this.applyingCouponCode=!1,this.applyNewCouponCodeAfterDoneLoading?(this.applyNewCouponCodeAfterDoneLoading=!1,this.applyCoupon()):(this.$couponSpinner.addClass("hidden"),"success"==e&&t.success&&(this.couponPrice=t.couponPrice,this.formattedCouponPrice=t.formattedCouponPrice,this.updateCheckoutUi()))},this))}else this.couponPrice=null,this.updateCheckoutUi()}},onHide:function(){this.initializedCheckoutForm&&(this.$businessCountryInput[0].selectize.blur(),this.$businessStateInput[0].selectize.blur()),this.clearCheckoutFormInABit(),this.base()},onBuyBtnClick:function(t){var e=p(t.currentTarget);switch(this.edition=e.data("edition"),this.couponPrice=null,this.formattedCouponPrice=null,this.edition){case 1:this.$checkoutLogo.attr("class","logo craftclient").text("Client");break;case 2:this.$checkoutLogo.attr("class","logo craftpro").text("Pro")}this.updateCheckoutUi(),this.clearCheckoutFormTimeout&&clearTimeout(this.clearCheckoutFormTimeout);var s=this.getWidth();this.$compareScreen.velocity("stop").animateLeft(-s,"fast",p.proxy(function(){this.$compareScreen.addClass("hidden"),this.initializedCheckoutForm||(this.initializeCheckoutForm(),this.initializedCheckoutForm=!0)},this)),this.$checkoutScreen.velocity("stop").css(Craft.left,s).removeClass("hidden").animateLeft(0,"fast")},updateCheckoutUi:function(){0==this.getPrice()?this.$ccField.hide():this.$ccField.show(),this.$checkoutSubmitBtn.val(Craft.t("Pay {price}",{price:this.getFormattedPrice()}))},getPrice:function(){return null!==this.couponPrice?this.couponPrice:this.editions[this.edition].salePrice?this.editions[this.edition].salePrice:this.editions[this.edition].price},getFormattedPrice:function(){return null!==this.couponPrice?this.formattedCouponPrice:this.editions[this.edition].salePrice?this.editions[this.edition].formattedSalePrice:this.editions[this.edition].formattedPrice},onTestBtnClick:function(t){var e={edition:p(t.currentTarget).data("edition")};Craft.postActionRequest("app/testUpgrade",e,p.proxy(function(t,e){if("success"==e){var s=this.getWidth();this.$compareScreen.velocity("stop").animateLeft(-s,"fast",p.proxy(function(){this.$compareScreen.addClass("hidden")},this)),this.onUpgrade()}},this))},cancelCheckout:function(){var t=this.getWidth();this.$compareScreen.velocity("stop").removeClass("hidden").animateLeft(0,"fast"),this.$checkoutScreen.velocity("stop").animateLeft(t,"fast",p.proxy(function(){this.$checkoutScreen.addClass("hidden")},this)),this.clearCheckoutFormInABit()},getExpiryValues:function(){return this.$ccExpInput.payment("cardExpiryVal")},submitPurchase:function(t){if(t.preventDefault(),!this.submittingPurchase){this.cleanupCheckoutForm();var s=this.getPrice(),e=this.getExpiryValues(),i={name:this.$customerNameInput.val(),number:this.$ccNumInput.val(),exp_month:e.month,exp_year:e.year,cvc:this.$ccCvcInput.val()},n=!0;i.name||(n=!1,this.$customerNameInput.addClass("error")),0!=s&&(Stripe.validateCardNumber(i.number)||(n=!1,this.$ccNumInput.addClass("error")),Stripe.validateExpiry(i.exp_month,i.exp_year)||(n=!1,this.$ccExpInput.addClass("error")),Stripe.validateCVC(i.cvc)||(n=!1,this.$ccCvcInput.addClass("error"))),n?(this.submittingPurchase=!0,this.$checkoutSubmitBtn.addClass("active"),this.$checkoutSpinner.removeClass("hidden"),0!=s?(Stripe.setPublishableKey(this.stripePublicKey),Stripe.createToken(i,p.proxy(function(t,e){e.error?(this.onPurchaseResponse(),this.showError(e.error.message),Garnish.shake(this.$checkoutForm,"left")):this.sendPurchaseRequest(s,e.id)},this))):this.sendPurchaseRequest(0,null)):Garnish.shake(this.$checkoutForm,"left")}},sendPurchaseRequest:function(t,e){var s=0!=t?this.getExpiryValues():{month:null,year:null},i={ccTokenId:e,expMonth:s.month,expYear:s.year,edition:this.edition,expectedPrice:t,name:this.$customerNameInput.val(),email:this.$customerEmailInput.val(),businessName:this.$businessNameInput.val(),businessAddress1:this.$businessAddress1Input.val(),businessAddress2:this.$businessAddress2Input.val(),businessCity:this.$businessCityInput.val(),businessState:this.$businessStateInput.val(),businessCountry:this.$businessCountryInput.val(),businessZip:this.$businessZipInput.val(),businessTaxId:this.$businessTaxIdInput.val(),purchaseNotes:this.$purchaseNotesInput.val(),couponCode:this.$couponInput.val()};Craft.postActionRequest("app/purchaseUpgrade",i,p.proxy(this,"onPurchaseUpgrade"))},onPurchaseResponse:function(){this.submittingPurchase=!1,this.$checkoutSubmitBtn.removeClass("active"),this.$checkoutSpinner.addClass("hidden")},onPurchaseUpgrade:function(t,e){if(this.onPurchaseResponse(),"success"==e)if(t.success){var s=this.getWidth();this.$checkoutScreen.velocity("stop").animateLeft(-s,"fast",p.proxy(function(){this.$checkoutScreen.addClass("hidden")},this)),this.onUpgrade()}else{if(t.errors){var i="";for(var n in t.errors)i&&(i+="<br>"),i+=t.errors[n];this.showError(i)}else i=Craft.t("An unknown error occurred.");Garnish.shake(this.$checkoutForm,"left")}},showError:function(t){this.$checkoutFormError=p('<p class="error centeralign">'+t+"</p>").insertBefore(this.$checkoutSecure)},onUpgrade:function(){this.$successScreen.css(Craft.left,this.getWidth()).removeClass("hidden").animateLeft(0,"fast");var t=this.$successScreen.find(".btn:first");this.addListener(t,"click",function(){location.reload()}),this.trigger("upgrade")},cleanupCheckoutForm:function(){this.$checkoutForm.find(".error").removeClass("error"),this.$checkoutFormError&&(this.$checkoutFormError.remove(),this.$checkoutFormError=null)},clearCheckoutForm:function(){this.$customerNameInput.val(""),this.$customerEmailInput.val(""),this.$ccNumInput.val(""),this.$ccExpInput.val(""),this.$ccCvcInput.val(""),this.$businessNameInput.val(""),this.$businessAddress1Input.val(""),this.$businessAddress2Input.val(""),this.$businessCityInput.val(""),this.$businessStateInput.val(""),this.$businessCountryInput.val(""),this.$businessZipInput.val(""),this.$businessTaxIdInput.val(""),this.$purchaseNotesInput.val(""),this.$couponInput.val("")},clearCheckoutFormInABit:function(){this.clearCheckoutFormTimeout=setTimeout(p.proxy(this,"clearCheckoutForm"),Craft.UpgradeModal.clearCheckoutFormTimeoutDuration)}},{clearCheckoutFormTimeoutDuration:3e4}),Craft.Uploader=Garnish.Base.extend({uploader:null,allowedKinds:null,$element:null,settings:null,_rejectedFiles:{},_extensionList:null,_totalFileCounter:0,_validFileCounter:0,init:function(t,e){this._rejectedFiles={size:[],type:[],limit:[]},this.$element=t,this.allowedKinds=null,this._extensionList=null,this._totalFileCounter=0,this._validFileCounter=0;var s=(e=p.extend({},Craft.Uploader.defaults,e)).events;for(var i in delete e.events,e.allowedKinds&&e.allowedKinds.length&&("string"==typeof e.allowedKinds&&(e.allowedKinds=[e.allowedKinds]),this.allowedKinds=e.allowedKinds,delete e.allowedKinds),e.autoUpload=!1,this.uploader=this.$element.fileupload(e),s)this.uploader.on(i,s[i]);this.settings=e,this.uploader.on("fileuploadadd",p.proxy(this,"onFileAdd"))},setParams:function(t){void 0!==Craft.csrfTokenName&&void 0!==Craft.csrfTokenValue&&(t[Craft.csrfTokenName]=Craft.csrfTokenValue),this.uploader.fileupload("option",{formData:t})},getInProgress:function(){return this.uploader.fileupload("active")},isLastUpload:function(){return this.getInProgress()<2},onFileAdd:function(t,i){t.stopPropagation();var n=!1;return this.allowedKinds&&(this._extensionList||this._createExtensionList(),n=!0),i.process().done(p.proxy(function(){var t=i.files[0],e=!0;if(n){var s=t.name.match(/\.([a-z0-4_]+)$/i)[1];-1==p.inArray(s.toLowerCase(),this._extensionList)&&(e=!1,this._rejectedFiles.type.push("“"+t.name+"”"))}t.size>this.settings.maxFileSize&&(this._rejectedFiles.size.push("“"+t.name+"”"),e=!1),e&&"function"==typeof this.settings.canAddMoreFiles&&!this.settings.canAddMoreFiles(this._validFileCounter)&&(this._rejectedFiles.limit.push("“"+t.name+"”"),e=!1),e&&(this._validFileCounter++,i.submit()),++this._totalFileCounter==i.originalFiles.length&&(this._totalFileCounter=0,this._validFileCounter=0,this.processErrorMessages())},this)),!0},processErrorMessages:function(){var t;this._rejectedFiles.type.length&&(t=1==this._rejectedFiles.type.length?"The file {files} could not be uploaded. The allowed file kinds are: {kinds}.":"The files {files} could not be uploaded. The allowed file kinds are: {kinds}.",t=Craft.t(t,{files:this._rejectedFiles.type.join(", "),kinds:this.allowedKinds.join(", ")}),this._rejectedFiles.type=[],alert(t)),this._rejectedFiles.size.length&&(t=1==this._rejectedFiles.size.length?"The file {files} could not be uploaded, because it exceeds the maximum upload size of {size}.":"The files {files} could not be uploaded, because they exceeded the maximum upload size of {size}.",t=Craft.t(t,{files:this._rejectedFiles.size.join(", "),size:this.humanFileSize(Craft.maxUploadSize)}),this._rejectedFiles.size=[],alert(t)),this._rejectedFiles.limit.length&&(t=1==this._rejectedFiles.limit.length?"The file {files} could not be uploaded, because the field limit has been reached.":"The files {files} could not be uploaded, because the field limit has been reached.",t=Craft.t(t,{files:this._rejectedFiles.limit.join(", ")}),this._rejectedFiles.limit=[],alert(t))},humanFileSize:function(t,e){if(t<1024)return t+" B";for(var s=-1;++s,1024<=(t/=1024););return t.toFixed(1)+" "+["kB","MB","GB","TB","PB","EB","ZB","YB"][s]},_createExtensionList:function(){this._extensionList=[];for(var t=0;t<this.allowedKinds.length;t++){var e=this.allowedKinds[t];if(void 0!==Craft.fileKinds[e])for(var s=0;s<Craft.fileKinds[e].extensions.length;s++){var i=Craft.fileKinds[e].extensions[s];this._extensionList.push(i)}}},destroy:function(){this.$element.fileupload("destroy"),this.base()}},{defaults:{dropZone:null,pasteZone:null,fileInput:null,sequentialUploads:!0,maxFileSize:Craft.maxUploadSize,allowedKinds:null,events:{},canAddMoreFiles:null}})}(jQuery);
//# sourceMappingURL=craft.js.map