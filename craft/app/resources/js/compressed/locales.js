!function(d){Craft.Locales=Garnish.Base.extend({$addLocaleField:null,$addLocaleInput:null,$addLocaleSpinner:null,$resultsSheet:null,$resultsList:null,$activeLocale:null,locales:null,selectedLocales:null,adminTable:null,inputVal:null,showingResultsSheet:!1,init:function(e,t){for(var i in this.locales={},e)this.locales[i]={name:e[i],words:Craft.asciiString(i+" "+e[i]).match(Craft.Locales.wordRegex)};this.selectedLocales=t,this.$addLocaleField=d("#addlocale"),this.$addLocaleInput=d("#addlocaleinput"),this.$addLocaleSpinner=this.$addLocaleField.find(".spinner"),this.adminTable=new a(this),this.addListener(this.$addLocaleInput,"keydown","onKeyDown"),this.addListener(this.$addLocaleInput,"focus","onFocus"),this.addListener(this.$addLocaleInput,"blur","onBlur")},onKeyDown:function(e){switch(e.keyCode){case Garnish.ESC_KEY:return this.$addLocaleInput.val(""),void this.hideResultsSheet();case Garnish.RETURN_KEY:return e.preventDefault(),void this.addSelectedLocale();case Garnish.UP_KEY:return void this.setRelativeActiveLocale("prev");case Garnish.DOWN_KEY:return void this.setRelativeActiveLocale("next")}setTimeout(d.proxy(this,"checkInputVal"),1)},onFocus:function(){this.inputVal&&this.showResultsSheet()},onBlur:function(){this.hideResultsSheet()},setRelativeActiveLocale:function(e){if(this.$activeLocale){var t=this.$activeLocale.parent()[e]().children("a");t.length&&(this.$activeLocale.removeClass("hover"),t.addClass("hover"),this.$activeLocale=t)}},checkInputVal:function(){if(this.inputVal!==(this.inputVal=this.$addLocaleInput.val())){var e=this.findMatchingLocales();if(e.length){e=e.sort(function(e,t){return e.length-t.length}),this.showResultsSheet(),this.$resultsList.html("");for(var t=0;t<e.length;t++){var i=this.locales[e[t]],a=d("<li/>").appendTo(this.$resultsList),s=d('<a data-id="'+e[t]+'">'+i.name+" ("+e[t]+")</a>").appendTo(a);0==t&&(s.addClass("hover"),this.$activeLocale=s)}}else this.hideResultsSheet(),this.$activeLocale=null}},findMatchingLocales:function(){var e=[],t=Craft.asciiString(this.inputVal).match(Craft.Locales.wordRegex);if(t){for(var i=[],a=0;a<t.length;a++)i.push(new RegExp("^"+t[a],"i"));for(var s in this.locales)if(!Craft.inArray(s,this.selectedLocales)){var l=!0;for(a=0;a<i.length;a++){for(var n=!1,o=0;o<this.locales[s].words.length;o++)if(-1!=this.locales[s].words[o].search(i[a])){n=!0;break}if(!n){l=!1;break}}l&&e.push(s)}}return e},showResultsSheet:function(){this.showingResultsSheet||(this.$resultsSheet||(this.$resultsSheet=d('<div id="addlocaleresults" class="menu" style="position: relative;"/>').appendTo(this.$addLocaleField),this.$resultsList=d("<ul/>").appendTo(this.$resultsSheet),this.addListener(this.$resultsList,"mousedown","addSelectedLocale")),this.$resultsSheet.show(),this.showingResultsSheet=!0)},hideResultsSheet:function(){this.showingResultsSheet&&(this.$resultsSheet.hide(),this.showingResultsSheet=!1)},addSelectedLocale:function(e){var t;if(e)t=d(e.target);else{if(!this.$activeLocale)return;t=this.$activeLocale}this.hideResultsSheet(),this.$addLocaleInput.val(this.$activeLocale.text()).prop("disabled",!0),this.$addLocaleSpinner.removeClass("hidden");var a=t.attr("data-id");Craft.postActionRequest("localization/addLocale",{id:a},d.proxy(function(e,t){if(this.$addLocaleSpinner.addClass("hidden"),"success"==t)if(e.success){var i=d('<tr data-id="'+a+'" data-name="'+this.locales[a].name+'"><th scope="row" data-title="'+Craft.t("Name")+'" width="40%">'+this.locales[a].name+'</th><td data-title="'+Craft.t("Locale ID")+'">'+a+'</td><td class="thin"><a class="move icon" title="'+Craft.t("Reorder")+'"></a></td><td class="thin"><a class="delete icon" title="'+Craft.t("Delete")+'"></a></td></tr>');this.adminTable.addRow(i),this.selectedLocales.push(a),this.$addLocaleInput.val("").prop("disabled",!1).trigger("keydown"),this.checkInputVal(),Craft.cp.displayNotice(Craft.t("New locale added.")),Craft.cp.runPendingTasks()}else Craft.cp.displayError(Craft.t("Unable to add the new locale."))},this))}},{wordRegex:new RegExp("[a-zA-Z]+","g")});var a=Craft.AdminTable.extend({manager:null,confirmDeleteModal:null,$rowToDelete:null,$deleteActionRadios:null,$deleteSubmitBtn:null,$deleteSpinner:null,_deleting:!1,init:function(e){this.manager=e,this.base({tableSelector:"#locales",sortable:!0,minObjects:1,reorderAction:"localization/reorderLocales",deleteAction:"localization/deleteLocale"})},confirmDeleteObject:function(e){return this.confirmDeleteModal&&(this.confirmDeleteModal.destroy(),delete this.confirmDeleteModal),this._createConfirmDeleteModal(e),Garnish.isMobileBrowser(!0)||setTimeout(d.proxy(function(){this.$deleteActionRadios.first().trigger("focus")},this),100),!1},onDeleteObject:function(e){var t=d.inArray(e,this.manager.selectedLocales);-1!=t&&this.manager.selectedLocales.splice(t,1),this.base(e)},validateDeleteInputs:function(){var e=this.$deleteActionRadios.eq(0).prop("checked")||this.$deleteActionRadios.eq(1).prop("checked");return e?this.$deleteSubmitBtn.removeClass("disabled"):this.$deleteSubmitBtn.addClass("disabled"),e},submitDeleteLocale:function(e){if(e.preventDefault(),!this._deleting&&this.validateDeleteInputs()){this.$deleteSubmitBtn.addClass("active"),this.$deleteSpinner.removeClass("hidden"),this.disable(),this._deleting=!0;var t={id:this.getObjectId(this.$rowToDelete)};this.$deleteActionRadios.eq(0).prop("checked")&&(t.transferContentTo=this.$transferSelect.val()),Craft.postActionRequest(this.settings.deleteAction,t,d.proxy(function(e,t){"success"==t&&(this._deleting=!1,this.enable(),this.confirmDeleteModal.hide(),this.handleDeleteObjectResponse(e,this.$rowToDelete))},this))}},_createConfirmDeleteModal:function(e){this.$rowToDelete=e;var t=this.getObjectId(e),i=this.getObjectName(e),a=d('<form id="confirmdeletemodal" class="modal fitted" method="post" accept-charset="UTF-8">'+Craft.getCsrfInput()+'<input type="hidden" name="action" value="localization/deleteLocale"/><input type="hidden" name="id" value="'+t+'"/></form>').appendTo(Garnish.$bod),s=d('<div class="body"><p>'+Craft.t("What do you want to do with any content that is only available in {language}?",{language:i})+'</p><div class="options"><label><input type="radio" name="contentAction" value="transfer"/> '+Craft.t("Transfer it to:")+'</label><div id="transferselect" class="select"><select/></div></div><div><label><input type="radio" name="contentAction" value="delete"/> '+Craft.t("Delete it")+"</label></div></div>").appendTo(a),l=d('<div class="buttons right"/>').appendTo(s),n=d('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(l);this.$deleteActionRadios=s.find("input[type=radio]"),this.$transferSelect=d("#transferselect > select"),this.$deleteSubmitBtn=d('<input type="submit" class="btn submit disabled" value="'+Craft.t("Delete {language}",{language:i})+'" />').appendTo(l),this.$deleteSpinner=d('<div class="spinner hidden"/>').appendTo(l);for(var o=0;o<this.manager.selectedLocales.length;o++)this.manager.selectedLocales[o]!=t&&this.$transferSelect.append('<option value="'+this.manager.selectedLocales[o]+'">'+this.manager.locales[this.manager.selectedLocales[o]].name+"</option>");this.confirmDeleteModal=new Garnish.Modal(a),this.addListener(n,"click",function(){this.confirmDeleteModal.hide()}),this.addListener(this.$deleteActionRadios,"change","validateDeleteInputs"),this.addListener(a,"submit","submitDeleteLocale")}})}(jQuery);
//# sourceMappingURL=locales.js.map