!function(r){Craft.Tool=Garnish.Base.extend({$trigger:null,$form:null,$innerProgressBar:null,toolClass:null,optionsHtml:null,buttonLabel:null,hud:null,totalActions:null,completedActions:null,loadingActions:null,queue:null,init:function(t,s,o){this.toolClass=t,this.optionsHtml=s,this.buttonLabel=o,this.$trigger=r("#tool-"+t),this.addListener(this.$trigger,"click","showHUD")},showHUD:function(t){t.stopPropagation(),this.hud?this.hud.show():(this.$form=r('<div class="form"/>').html(this.optionsHtml+'<div class="buttons"><input type="submit" class="btn submit" value="'+this.buttonLabel+'"></div>'),this.hud=new Garnish.HUD(this.$trigger,this.$form,{orientations:["top","bottom","right","left"],hudClass:"hud toolhud",onSubmit:r.proxy(this,"onSubmit")}),Craft.initUiElements(this.$form))},onSubmit:function(t){this.progressBar?this.progressBar.resetProgressBar():this.progressBar=new Craft.ProgressBar(this.hud.$main),this.totalActions=1,this.completedActions=0,this.queue=[],this.loadingActions=0,this.currentBatchQueue=[],this.progressBar.$progressBar.css({top:Math.round(this.hud.$main.outerHeight()/2)-6}).removeClass("hidden"),this.$form.velocity("stop").animateLeft(-200,"fast"),this.progressBar.$progressBar.velocity("stop").animateLeft(30,"fast",r.proxy(function(){var t=Garnish.getPostData(this.$form),s=Craft.expandPostArray(t);s.start=!0,this.loadAction({params:s})},this))},updateProgressBar:function(){var t=100*this.completedActions/this.totalActions;this.progressBar.setProgressPercentage(t)},loadAction:function(t){this.loadingActions++,void 0!==t.confirm&&t.confirm?this.showConfirmDialog(t):this.postActionRequest(t.params)},showConfirmDialog:function(i){var t=r('<form class="modal fitted confirmmodal"/>').appendTo(Garnish.$bod),e=r('<div class="body"/>').appendTo(t).html(i.confirm),s=r('<footer class="footer"/>').appendTo(t),o=r('<div class="buttons right"/>').appendTo(s),n=r('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(o);r('<input type="submit" class="btn submit" value="'+Craft.t("OK")+'"/>').appendTo(o);Craft.initUiElements(e);var a=new Garnish.Modal(t,{onHide:r.proxy(this,"onActionResponse")});this.addListener(n,"click",function(){a.hide()}),this.addListener(t,"submit",function(t){t.preventDefault(),a.settings.onHide=r.noop,a.hide();var s=Garnish.getPostData(e),o=Craft.expandPostArray(s);r.extend(o,i.params),this.postActionRequest(o)})},postActionRequest:function(t){var s={tool:this.toolClass,params:t};Craft.postActionRequest("tools/performAction",s,r.proxy(this,"onActionResponse"),{complete:r.noop})},onActionResponse:function(t,s){if(this.loadingActions--,this.completedActions++,"success"==s&&t&&t.batches)for(var o=0;o<t.batches.length;o++)t.batches[o].length&&(this.totalActions+=t.batches[o].length,this.queue.push(t.batches[o]));for(t&&t.error&&alert(t.error),this.updateProgressBar();this.loadingActions<Craft.Tool.maxConcurrentActions&&this.currentBatchQueue.length;)this.loadNextAction();if(!this.loadingActions)if(this.queue.length)this.currentBatchQueue=this.queue.shift(),this.loadNextAction();else{if(t&&t.backupFile){var i=r("<iframe/>",{src:Craft.getActionUrl("tools/downloadBackupFile",{fileName:t.backupFile})}).hide();this.$form.append(i)}setTimeout(r.proxy(this,"onComplete"),300)}},loadNextAction:function(){var t=this.currentBatchQueue.shift();this.loadAction(t)},onComplete:function(){this.$allDone||(this.$allDone=r('<div class="alldone" data-icon="done" />').appendTo(this.hud.$main)),this.$allDone.css({top:Math.round(this.hud.$main.outerHeight()/2)-30}),this.progressBar.$progressBar.animateLeft(-170,"fast"),this.$allDone.animateLeft(30,"fast"),Craft.cp.runPendingTasks()}},{maxConcurrentActions:3})}(jQuery);
//# sourceMappingURL=settings.js.map